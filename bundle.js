!function e(t,n,o){function r(a,i){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!i&&c)return c(a,!0);if(s)return s(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var u=n[a]={exports:{}};t[a][0].call(u.exports,(function(e){return r(t[a][1][e]||e)}),u,u.exports,e,t,n,o)}return n[a].exports}for(var s="function"==typeof require&&require,a=0;a<o.length;a++)r(o[a]);return r}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./commentBlockControl"),r=e("./Menu"),s=e("./messages");class a extends r.Menu{update(){this.clearItems();const e=o.getBlockedUsers();0===e.length?this.addItem(s.NO_BLOCKED_USERS,{small:!0}):this.addItem(s.CLICK_TO_UNBLOCK,{small:!0}),e.forEach(e=>{this.addItem(e,{small:!0,button:!0}).onClick(()=>{o.unblockUser(e)})})}constructor(e){super("屏蔽用户评论管理",e),this.update(),o.blockedUserUpdateEvent.on(this.update.bind(this))}}n.BlockMenu=a},{"./Menu":8,"./commentBlockControl":16,"./messages":26}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./chapterControl"),r=e("./data"),s=e("./history"),a=e("./Menu"),i=e("./shortNumber"),c=new Map;let l=null;function u(e,t){l=e.append("[上次阅读]")}function d(e){switch(e){case"Markdown":return a.ItemDecoration.ICON_FILE;case"WTCD":return a.ItemDecoration.ICON_GAME}}o.loadChapterEvent.on(e=>{null!==l&&l.remove(),u(c.get(e))});class h extends a.Menu{constructor(e,t){void 0===t&&(t=r.data.chapterTree),super(t.isRoot?"章节选择":t.displayName,e);for(const e of t.subFolders){this.addLink(new h(this,e),!0,a.ItemDecoration.ICON_FOLDER).append(`[${i.shortNumber(e.folderCharCount)}]`,"char-count")}for(const e of t.chapters){const t=this.addItem(e.displayName,{small:!0,button:!0,decoration:d(e.type)}).onClick(()=>{o.loadChapter(e.htmlRelativePath),s.updateHistory(!0)});e.isEarlyAccess&&(t.prepend("[编写中]"),t.addClass("early-access")),t.append(`[${i.shortNumber(e.chapterCharCount)}]`,"char-count"),window.localStorage.getItem("lastRead")===e.htmlRelativePath&&u(t,e.htmlRelativePath),c.set(e.htmlRelativePath,t)}}}n.ChaptersMenu=h},{"./Menu":8,"./chapterControl":15,"./data":18,"./history":22,"./shortNumber":28}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./Menu");class r extends o.Menu{constructor(e){super("订阅/讨论组",e),this.addItem("Telegram 更新推送频道",{small:!0,button:!0,link:"https://t.me/joinchat/AAAAAEpkRVwZ-3s5V3YHjA",decoration:o.ItemDecoration.ICON_LINK}),this.addItem("Telegram 讨论组",{small:!0,button:!0,link:"https://t.me/joinchat/Dt8_WlJnmEwYNbjzlnLyNA",decoration:o.ItemDecoration.ICON_LINK}),this.addItem("GitHub Repo",{small:!0,button:!0,link:"https://github.com/SCLeoX/Wearable-Technology",decoration:o.ItemDecoration.ICON_LINK}),this.addItem("原始 Google Docs",{small:!0,button:!0,link:"https://docs.google.com/document/d/1Pp5CtO8c77DnWGqbXg-3e7w9Q3t88P35FOl6iIJvMfo/edit?usp=sharing",decoration:o.ItemDecoration.ICON_LINK})}}n.ContactMenu=r},{"./Menu":8}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./DebugLogger");n.id=function(e){return document.getElementById(e)},n.getTextNodes=function e(t,n){const o=n||[];let r=t.firstChild;for(;null!==r;)r instanceof HTMLElement&&e(r,o),r instanceof Text&&o.push(r),r=r.nextSibling;return o};const r=new o.DebugLogger("selectNode");n.selectNode=function(e){try{const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}catch(t){r.log("Failed to select node: ",e,"; Error: ",t)}},n.isAnyParent=function(e,t){for(;null!==e;){if(t(e))return!0;e=e.parentElement}return!1}},{"./DebugLogger":5}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./settings");n.DebugLogger=class{constructor(e,t={}){this.prefix=e+"("+Object.keys(t).map(e=>`${e}=${function(e){switch(typeof e){case"string":return`"${e}"`;default:return String(e)}}(t[e])}`).join(",")+")"}log(...e){o.developerMode.getValue()&&console.info(this.prefix,...e)}info(...e){o.developerMode.getValue()&&console.info(this.prefix,...e)}warn(...e){o.developerMode.getValue()&&console.warn(this.prefix,...e)}error(...e){o.developerMode.getValue()&&console.error(this.prefix,...e)}}},{"./settings":27}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.Event=class{constructor(){this.listeners=null,this.onceListeners=null,this.isEmitting=!1,this.queue=[]}on(e){return this.isEmitting?(this.queue.push(()=>{this.on(e)}),e):(null===this.listeners&&(this.listeners=new Set),this.listeners.add(e),e)}off(e){this.isEmitting?this.queue.push(()=>{this.off(e)}):null!==this.listeners&&this.listeners.delete(e)}once(e){return this.isEmitting?(this.queue.push(()=>{this.once(e)}),e):(null===this.onceListeners&&(this.onceListeners=[]),this.onceListeners.push(e),e)}expect(e){return this.isEmitting?new Promise(t=>{this.queue.push(()=>{this.expect(e).then(t)})}):void 0===e?new Promise(e=>this.once(e)):new Promise(t=>{const n=this.on(o=>{e(o)&&(this.off(n),t(o))})})}emit(e){if(this.isEmitting)this.queue.push(()=>{this.emit(e)});else for(this.isEmitting=!0,null!==this.listeners&&this.listeners.forEach(t=>t(e)),null!==this.onceListeners&&(this.onceListeners.forEach(t=>t(e)),this.onceListeners.length=0),this.isEmitting=!1;this.queue.length>=1;)this.queue.shift()()}}},{}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./ChaptersMenu"),r=e("./ContactMenu"),s=e("./Menu"),a=e("./SettingsMenu"),i=e("./StatsMenu"),c=e("./StyleMenu"),l=e("./ThanksMenu");class u extends s.Menu{constructor(){super("",null),this.addLink(new o.ChaptersMenu(this)),this.addLink(new l.ThanksMenu(this)),this.addLink(new c.StyleMenu(this)),this.addLink(new r.ContactMenu(this)),this.addItem("源代码",{button:!0,link:"https://github.com/SCLeoX/Wearable-Technology"}),this.addLink(new a.SettingsMenu(this)),this.addLink(new i.StatsMenu(this))}}n.MainMenu=u},{"./ChaptersMenu":2,"./ContactMenu":3,"./Menu":8,"./SettingsMenu":10,"./StatsMenu":12,"./StyleMenu":13,"./ThanksMenu":14}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./DebugLogger"),r=e("./Event"),s=e("./RectMode");var a;function i(e,...t){const n=document.createElement("span");return n.innerText=e,n.classList.add(...t),n}!function(e){e[e.SELECTABLE=0]="SELECTABLE",e[e.BACK=1]="BACK",e[e.ICON_FOLDER=2]="ICON_FOLDER",e[e.ICON_LINK=3]="ICON_LINK",e[e.ICON_EQUALIZER=4]="ICON_EQUALIZER",e[e.ICON_FILE=5]="ICON_FILE",e[e.ICON_GAME=6]="ICON_GAME"}(a=n.ItemDecoration||(n.ItemDecoration={}));class c{constructor(e,t){this.menu=e,this.element=t,this.$prependSpan=null,this.$appendSpan=null}setSelected(e){return this.element.classList.toggle("selected",e),this}onClick(e){return this.element.addEventListener("click",()=>{e(this.element)}),this}linkTo(e){return this.onClick(()=>{this.menu.navigateTo(e)}),this}setInnerText(e){return this.element.innerText=e,this}addClass(e){return this.element.classList.add(e),this}removeClass(e){return this.element.classList.remove(e),this}prepend(e,t){null===this.$prependSpan&&(this.$prependSpan=i("","prepend"),this.element.prepend(this.$prependSpan));const n=i(e,"item-side");return void 0!==t&&n.classList.add(t),this.$prependSpan.prepend(n),n}append(e,t){null===this.$appendSpan&&(this.$appendSpan=i("","append"),this.element.appendChild(this.$appendSpan));const n=i(e,"item-side");return void 0!==t&&n.classList.add(t),this.$appendSpan.appendChild(n),n}}n.ItemHandle=c;n.Menu=class{constructor(e,t,n=s.RectMode.OFF){if(this.name=e,this.parent=t,this.rectMode=n,this.active=!1,this.clearableElements=[],this.activateEvent=new r.Event,this.debugLogger=new o.DebugLogger("Menu",{name:e}),this.fullPath=null===t?[]:t.fullPath.slice(),""!==e&&this.fullPath.push(e),this.container=document.createElement("div"),this.container.classList.add("menu","hidden"),this.fullPath.length>=1){const e=document.createElement("div");e.classList.add("path"),e.innerText=this.fullPath.join(" > "),this.container.appendChild(e)}null!==t&&this.addItem("返回",{button:!0,decoration:a.BACK,unclearable:!0}).linkTo(t),document.body.appendChild(this.container),s.rectModeChangeEvent.on(({newRectMode:e})=>{this.active&&e===s.RectMode.MAIN&&(this.setActive(!1),s.rectModeChangeEvent.expect().then(()=>{this.setActive(!0)}))})}navigateTo(e){this.setActive(!1),e.setActive(!0),s.setRectMode(e.rectMode)}exit(){if(null===this.parent)throw new Error("Cannot exit the root menu.");this.navigateTo(this.parent)}setActive(e){this.debugLogger.log(`setActive(${e})`),!this.active&&e&&this.activateEvent.emit(),this.active=e,this.container.classList.toggle("hidden",!e)}isActive(){return this.active}addItem(e,t){let n;if(t.button&&void 0!==t.link?((n=document.createElement("a")).href=t.link,n.target="_blank"):n=document.createElement("div"),n.innerText=e,t.small&&n.classList.add("small"),t.button)switch(n.classList.add("button"),t.decoration){case a.BACK:n.classList.add("back");break;case a.SELECTABLE:n.classList.add("selectable");break;case a.ICON_FOLDER:n.classList.add("icon","folder");break;case a.ICON_LINK:n.classList.add("icon","link");break;case a.ICON_EQUALIZER:n.classList.add("icon","equalizer");break;case a.ICON_FILE:n.classList.add("icon","file");break;case a.ICON_GAME:n.classList.add("icon","game")}return this.container.appendChild(n),t.unclearable||this.clearableElements.push(n),new c(this,n)}clearItems(){this.clearableElements.forEach(e=>e.remove()),this.clearableElements=[]}addLink(e,t,n){return this.addItem(e.name,{small:t,button:!0,decoration:n}).linkTo(e)}}},{"./DebugLogger":5,"./Event":6,"./RectMode":9}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./DebugLogger"),r=e("./DOM"),s=e("./Event");var a;!function(e){e[e.SIDE=0]="SIDE",e[e.MAIN=1]="MAIN",e[e.OFF=2]="OFF"}(a=n.RectMode||(n.RectMode={}));const i=r.id("rect"),c=new o.DebugLogger("RectMode");n.rectModeChangeEvent=new s.Event;let l=a.OFF;n.setRectMode=function(e){c.log(`${a[l]} -> ${a[e]}`),l!==e&&(e===a.OFF?i.classList.remove("reading"):(l===a.MAIN?i.classList.remove("main"):l===a.SIDE?i.classList.remove("side"):(i.classList.remove("main","side"),i.classList.add("reading")),e===a.MAIN?i.classList.add("main"):i.classList.add("side")),n.rectModeChangeEvent.emit({previousRectMode:l,newRectMode:e}),l=e)}},{"./DOM":4,"./DebugLogger":5,"./Event":6}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./BlockMenu"),r=e("./commentsControl"),s=e("./DOM"),a=e("./Menu"),i=e("./RectMode"),c=e("./settings"),l=e("./stylePreviewArticle");class u extends a.Menu{constructor(e,t,n,o){let c;super(`${t}设置`,e,o?i.RectMode.SIDE:i.RectMode.MAIN),o&&this.activateEvent.on(()=>{r.hideComments(),s.id("content").innerHTML=l.stylePreviewArticle}),n.options.forEach((e,t)=>{const o=this.addItem(e,{small:!0,button:!0,decoration:a.ItemDecoration.SELECTABLE}).onClick(()=>{c.setSelected(!1),o.setSelected(!0),n.setValue(t),c=o});t===n.getValue()&&(c=o,o.setSelected(!0))})}}n.EnumSettingMenu=u;class d extends a.Menu{constructor(e){super("设置",e),this.addBooleanSetting("NSFW 警告",c.warning),this.addBooleanSetting("使用动画",c.animation),this.addBooleanSetting("显示编写中章节",c.earlyAccess),this.addBooleanSetting("显示评论",c.useComments),this.addBooleanSetting("手势切换章节（仅限手机）",c.gestureSwitchChapter),this.addEnumSetting("字体",c.fontFamily,!0),this.addBooleanSetting("显示每个章节的字数",c.charCount),this.addBooleanSetting("开发人员模式",c.developerMode),this.addLink(new o.BlockMenu(this),!0)}addBooleanSetting(e,t){const n=()=>`${e}：${t.getValue()?"开":"关"}`,o=this.addItem(n(),{small:!0,button:!0}).onClick(()=>{t.toggle(),o.setInnerText(n())})}addEnumSetting(e,t,n){const o=()=>`${e}：${t.getValueName()}`,r=this.addItem(o(),{small:!0,button:!0}),s=new u(this,e,t,!0===n);r.linkTo(s).onClick(()=>{this.activateEvent.once(()=>{r.setInnerText(o())})})}}n.SettingsMenu=d},{"./BlockMenu":1,"./DOM":4,"./Menu":8,"./RectMode":9,"./commentsControl":17,"./settings":27,"./stylePreviewArticle":30}],11:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./data"),r=e("./Menu");class s extends r.Menu{constructor(e){super("关键词统计",e),this.addItem("添加其他关键词",{small:!0,button:!0,link:"https://github.com/SCLeoX/Wearable-Technology/edit/master/src/builder/keywords.ts",decoration:r.ItemDecoration.ICON_LINK}),o.data.keywordsCount.forEach(([e,t])=>{this.addItem(`${e}：${t}`,{small:!0})})}}n.StatsKeywordsCountMenu=s},{"./Menu":8,"./data":18}],12:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./data"),r=e("./Menu"),s=e("./StatsKeywordsCountMenu");class a extends r.Menu{constructor(e){super("统计",e),this.addItem("统计数据由构建脚本自动生成",{small:!0}),this.addLink(new s.StatsKeywordsCountMenu(this),!0,r.ItemDecoration.ICON_EQUALIZER),this.addItem(`总字数：${o.data.charsCount}`,{small:!0}),this.addItem(`总段落数：${o.data.paragraphsCount}`,{small:!0})}}n.StatsMenu=a},{"./Menu":8,"./StatsKeywordsCountMenu":11,"./data":18}],13:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./commentsControl"),r=e("./DebugLogger"),s=e("./DOM"),a=e("./Menu"),i=e("./RectMode"),c=e("./stylePreviewArticle");class l{constructor(e,t){this.name=e,this.def=t,this.styleSheet=null,this.debugLogger=new r.DebugLogger("Style",{name:e})}injectStyleSheet(){const e=document.createElement("style");document.head.appendChild(e);const t=e.sheet;t.disabled=!0;const n=e=>{try{t.insertRule(e)}catch(t){this.debugLogger.error(`Failed to inject rule "${e}".`,t)}},o=`rgb(${this.def.keyColor.join(",")})`,r=e=>`rgba(${this.def.keyColor.join(",")},${e})`;n(`.container { color: ${o}; }`),n(`.menu { color: ${o}; }`),n(`.menu .button:active::after { background-color: ${o}; }`),n(`.button::after { background-color: ${o}; }`),n(`body { background-color: ${this.def.paperBgColor}; }`),n(`.rect { background-color: ${this.def.rectBgColor}; }`),n(`.rect.reading>div { background-color: ${this.def.paperBgColor}; }`),n(`.rect.reading>div { color: ${o}; }`),n(`.rect.reading>.content a { color: ${this.def.linkColor}; }`),n(`.rect.reading>.content a:hover { color: ${this.def.linkHoverColor}; }`),n(`.rect.reading>.content a:active { color: ${this.def.linkActiveColor}; }`),n(`.rect.reading>.content>.earlyAccess.block { background-color: ${this.def.contentBlockEarlyAccessColor}; }`),n(`.rect>.comments>div { background-color: ${this.def.commentColor}; }`),n(`@media (min-width: 901px) { ::-webkit-scrollbar-thumb { background-color: ${this.def.paperBgColor}; } }`),n(`.rect>.comments>.create-comment::before { background-color: ${o}; }`),n(`:root { --key: ${o}; }`),n(`:root { --key-opacity-01: ${r(.1)}; }`),n(`:root { --key-opacity-05: ${r(.5)}; }`),n(`:root { --key-opacity-007: ${r(.07)}; }`),n(`:root { --key-opacity-004: ${r(.04)}; }`),n(`:root { --button-color: ${this.def.commentColor}; }`),this.styleSheet=t}active(){if(null!==l.currentlyEnabled){const e=l.currentlyEnabled;null!==e.styleSheet&&(e.styleSheet.disabled=!0),e.itemHandle.setSelected(!1)}null===this.styleSheet&&this.injectStyleSheet(),this.styleSheet.disabled=!1,this.itemHandle.setSelected(!0),window.localStorage.setItem("style",this.name),l.currentlyEnabled=this}}l.currentlyEnabled=null;const u={linkColor:"#00E",linkHoverColor:"#F00",linkActiveColor:"#00E"},d={linkColor:"#88F",linkHoverColor:"#F33",linkActiveColor:"#88F"},h=[new l("可穿戴科技（默认）",Object.assign(Object.assign({rectBgColor:"#444",paperBgColor:"#333",keyColor:[221,221,221]},d),{contentBlockEarlyAccessColor:"#E65100",commentColor:"#444",keyIsDark:!1})),new l("白纸",Object.assign(Object.assign({rectBgColor:"#EFEFED",paperBgColor:"#FFF",keyColor:[0,0,0]},u),{contentBlockEarlyAccessColor:"#FFE082",commentColor:"#F5F5F5",keyIsDark:!0})),new l("夜间",Object.assign(Object.assign({rectBgColor:"#272B36",paperBgColor:"#38404D",keyColor:[221,221,221]},d),{contentBlockEarlyAccessColor:"#E65100",commentColor:"#272B36",keyIsDark:!1})),new l("羊皮纸",Object.assign(Object.assign({rectBgColor:"#D8D4C9",paperBgColor:"#F8F4E9",keyColor:[85,40,48]},u),{contentBlockEarlyAccessColor:"#FFE082",commentColor:"#F9EFD7",keyIsDark:!0})),new l("巧克力",Object.assign(Object.assign({rectBgColor:"#2E1C11",paperBgColor:"#3A2519",keyColor:[221,175,153]},d),{contentBlockEarlyAccessColor:"#E65100",commentColor:"#2C1C11",keyIsDark:!1}))];class p extends a.Menu{constructor(e){super("阅读器样式",e,i.RectMode.SIDE);for(const e of h)e.itemHandle=this.addItem(e.name,{small:!0,button:!0,decoration:a.ItemDecoration.SELECTABLE}).onClick(()=>{e.active()});const t=window.localStorage.getItem("style");let n=!1;for(const e of h)if(t===e.name){e.active(),n=!0;break}n||h[0].active(),this.activateEvent.on(()=>{o.hideComments(),s.id("content").innerHTML=c.stylePreviewArticle})}}n.StyleMenu=p},{"./DOM":4,"./DebugLogger":5,"./Menu":8,"./RectMode":9,"./commentsControl":17,"./stylePreviewArticle":30}],14:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./Menu"),r=e("./thanks");class s extends o.Menu{constructor(e){super("鸣谢列表",e);for(const e of r.thanks)this.addItem(e.name,void 0===e.link?{small:!0}:{small:!0,button:!0,link:e.link,decoration:o.ItemDecoration.ICON_LINK})}}n.ThanksMenu=s},{"./Menu":8,"./thanks":31}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("../wtcd/FlowReader"),r=e("../wtcd/WTCDError"),s=e("./commentsControl"),a=e("./data"),i=e("./DebugLogger"),c=e("./DOM"),l=e("./Event"),u=e("./gestures"),d=e("./history"),h=e("./keyboard"),p=e("./loadingText"),m=e("./messages"),g=e("./RectMode"),f=e("./settings"),b=e("./state"),v=new i.DebugLogger("chapterControl"),y=c.id("content"),E=new Map;function C(){g.setRectMode(g.RectMode.OFF),b.state.currentChapter=null,b.state.chapterSelection=null,b.state.chapterTextNodes=null}n.loadChapterEvent=new l.Event,n.closeChapter=C;const w=([e,t,n,o])=>{if(null===b.state.chapterTextNodes)return;const r=b.state.chapterTextNodes[e],s=b.state.chapterTextNodes[n];if(void 0===r||void 0===s)return;document.getSelection().setBaseAndExtent(r,t,s,o);const a=r.parentElement;null!==a&&"function"==typeof a.scrollIntoView&&a.scrollIntoView()},T=()=>{const e=document.createElement("span");return e.style.flex="1",e},M=e=>f.earlyAccess.getValue()||!e.isEarlyAccess;function L(){const e=b.state.currentChapter;if(null===e)return;const t=e.inFolderIndex;if(t>=1&&M(e.folder.chapters[t-1])){O(e.folder.chapters[t-1].htmlRelativePath),d.updateHistory(!0)}}function S(){const e=b.state.currentChapter;if(null===e)return;const t=e.inFolderIndex;if(t<e.folder.chapters.length-1&&M(e.folder.chapters[t+1])){O(e.folder.chapters[t+1].htmlRelativePath),d.updateHistory(!0)}}n.loadPrevChapter=L,n.loadNextChapter=S;const k=e=>{b.state.chapterTextNodes=c.getTextNodes(y),void 0!==e&&(null===c.id("warning")?w(e):c.id("warning").addEventListener("click",()=>{w(e)})),Array.from(y.getElementsByTagName("a")).forEach(e=>e.target="_blank"),Array.from(y.getElementsByTagName("code")).forEach(e=>e.addEventListener("dblclick",()=>{c.selectNode(e)})),Array.from(y.getElementsByTagName("img")).forEach(e=>{const t=e.src,n=t.lastIndexOf("."),o=t.substr(0,n);if(o.endsWith("_low")){const r=t.substr(n+1),s=o.substr(0,o.length-4);e.style.cursor="zoom-in",e.addEventListener("click",()=>window.open(s+"."+r))}});const t=b.state.currentChapter,n=t.inFolderIndex;if(t.chapter.isEarlyAccess){const e=((e,t,n)=>{const o=document.createElement("div");o.classList.add("block",e);const r=document.createElement("h1");r.innerText=t,o.appendChild(r);const s=document.createElement("p");return s.innerText=n,o.appendChild(s),o})("earlyAccess","编写中章节","请注意，本文正在编写中，因此可能会含有未完成的句子或是尚未更新的信息。");y.prepend(e)}const o=document.createElement("div");if(o.style.display="flex",o.style.marginTop="2vw",n>=1&&M(t.folder.chapters[n-1])){const e=t.folder.chapters[n-1].htmlRelativePath,r=document.createElement("a");r.innerText="上一章",r.href=`${window.location.pathname}#${e}`,r.style.textAlign="left",r.style.flex="1",r.addEventListener("click",e=>{e.preventDefault(),L()}),o.appendChild(r)}else o.appendChild(T());const r=document.createElement("a");if(r.innerText="返回菜单",r.href=window.location.pathname,r.style.textAlign="center",r.style.flex="1",r.addEventListener("click",e=>{e.preventDefault(),C(),d.updateHistory(!0)}),o.appendChild(r),n<t.folder.chapters.length-1&&M(t.folder.chapters[n+1])){const e=t.folder.chapters[n+1].htmlRelativePath,r=document.createElement("a");r.innerText="下一章",r.href=`${window.location.pathname}#${e}`,r.style.textAlign="right",r.style.flex="1",r.addEventListener("click",e=>{e.preventDefault(),S()}),o.appendChild(r)}else o.appendChild(T());y.appendChild(o),s.loadComments(t.chapter.commentsUrl),c.id("rect").style.overflow="hidden",setTimeout(()=>{c.id("rect").style.overflow="",void 0===e&&c.id("rect").scrollTo(0,0)},1),setTimeout(()=>{c.id("rect").focus()},1)};var R;function I({errorType:e,message:t,stack:n}){const o=document.createElement("div"),r=document.createElement("h1"),s=document.createElement("p");switch(e){case R.COMPILE:r.innerText=m.WTCD_ERROR_COMPILE_TITLE,s.innerText=m.WTCD_ERROR_COMPILE_TITLE;break;case R.RUNTIME:r.innerText=m.WTCD_ERROR_RUNTIME_TITLE,s.innerText=m.WTCD_ERROR_RUNTIME_DESC;break;case R.INTERNAL:r.innerText=m.WTCD_ERROR_INTERNAL_TITLE,s.innerText=m.WTCD_ERROR_INTERNAL_DESC}o.appendChild(r),o.appendChild(s);const a=document.createElement("p");if(a.innerText=m.WTCD_ERROR_MESSAGE+t,o.appendChild(a),void 0!==n){const e=document.createElement("h2");e.innerText=m.WTCD_ERROR_INTERNAL_STACK_TITLE,o.appendChild(e);const t=document.createElement("p");t.innerText=m.WTCD_ERROR_INTERNAL_STACK_DESC,o.appendChild(t);const r=document.createElement("pre"),s=document.createElement("code");s.innerText=n,r.appendChild(s),o.appendChild(r)}return o}function _(e,t,n){switch(n.type){case"Markdown":e.innerHTML=t;break;case"WTCD":{e.innerHTML="";const s=JSON.parse(t);if(!0===s.error){e.appendChild(I({errorType:R.COMPILE,message:s.message,stack:s.internalStack}));break}const a=new o.FlowReader(n.htmlRelativePath,s.wtcdRoot,e=>I({errorType:e instanceof r.WTCDError?R.RUNTIME:R.INTERNAL,message:e.message,stack:e.stack})),i=document.createElement("div");a.renderTo(i),y.appendChild(i);break}}}function O(e,t){v.log("Load chapter",e,"selection",t),s.hideComments(),n.loadChapterEvent.emit(e),window.localStorage.setItem("lastRead",e),g.setRectMode(g.RectMode.MAIN);const o=a.relativePathLookUpMap.get(e);return b.state.currentChapter=o,E.has(e)?null===E.get(e)?y.innerText=p.loadingText:(_(y,E.get(e),o.chapter),k(t)):(y.innerText=p.loadingText,fetch(`./chapters/${e}`).then(e=>e.text()).then(n=>{E.set(e,n),o===b.state.currentChapter&&(_(y,n,o.chapter),k(t))})),!0}u.swipeEvent.on(e=>{f.gestureSwitchChapter.getValue()&&(e===u.SwipeDirection.TO_RIGHT?L():e===u.SwipeDirection.TO_LEFT&&S())}),h.arrowKeyPressEvent.on(e=>{e===h.ArrowKey.LEFT?L():e===h.ArrowKey.RIGHT&&S()}),function(e){e[e.COMPILE=0]="COMPILE",e[e.RUNTIME=1]="RUNTIME",e[e.INTERNAL=2]="INTERNAL"}(R||(R={})),n.loadChapter=O},{"../wtcd/FlowReader":33,"../wtcd/WTCDError":36,"./DOM":4,"./DebugLogger":5,"./Event":6,"./RectMode":9,"./commentsControl":17,"./data":18,"./gestures":21,"./history":22,"./keyboard":24,"./loadingText":25,"./messages":26,"./settings":27,"./state":29}],16:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./Event"),r=new Set(JSON.parse(window.localStorage.getItem("blockedUsers")||"[]"));function s(){window.localStorage.setItem("blockedUsers",JSON.stringify(Array.from(r))),n.blockedUserUpdateEvent.emit()}n.blockedUserUpdateEvent=new o.Event,n.blockUser=function(e){r.add(e),s()},n.unblockUser=function(e){r.delete(e),s()},n.isUserBlocked=function(e){return r.has(e)},n.getBlockedUsers=function(){return Array.from(r)}},{"./Event":6}],17:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./commentBlockControl"),r=e("./DOM"),s=e("./formatTime"),a=e("./messages"),i=e("./settings"),c=r.id("comments"),l=r.id("comments-status"),u=r.id("create-comment"),d=/^https:\/\/github\.com\/([a-zA-Z0-9-_]+)\/([a-zA-Z0-9-_]+)\/issues\/([1-9][0-9]*)$/;let h=1,p=0,m="";u.addEventListener("click",()=>{window.open(m,"_blank")}),n.hideComments=function(){c.classList.toggle("display-none",!0),p=0},n.loadComments=function(e){if(!1===i.useComments.getValue())return;if(Array.from(c.getElementsByClassName("comment")).forEach(e=>e.remove()),c.classList.toggle("display-none",!1),u.classList.toggle("display-none",!0),null===e)return void(l.innerText=a.COMMENTS_UNAVAILABLE);m=e;const t=p=h++,n=function(e){const t=d.exec(e);if(null===t)throw new Error(`Bad issue url: ${e}.`);return`https://api.github.com/repos/${t[1]}/${t[2]}/issues/${t[3]}/comments`}(e);l.innerText=a.COMMENTS_LOADING,fetch(n).then(e=>e.json()).then(e=>{t===p&&(l.innerText=a.COMMENTS_LOADED,e.forEach(e=>{o.isUserBlocked(e.user.login)||c.appendChild(function(e,t,n,r,a,i){const c=document.createElement("div");c.classList.add("comment");const l=document.createElement("img");l.classList.add("avatar"),l.src=e,c.appendChild(l);const u=document.createElement("a");u.classList.add("author"),u.innerText=t,u.target="_blank",u.href=n,c.appendChild(u);const d=document.createElement("div");d.classList.add("time"),d.innerText=r===a?s.formatTime(new Date(r)):`${s.formatTime(new Date(r))}（最后修改于 ${s.formatTime(new Date(a))}）`,c.appendChild(d);const h=document.createElement("a");return h.classList.add("block-user"),h.innerText="屏蔽此人",h.onclick=()=>{o.blockUser(t),c.remove()},c.appendChild(h),i.split("\n\n").forEach(e=>{const t=document.createElement("p");t.innerText=e,c.appendChild(t)}),c}(e.user.avatar_url,e.user.login,e.user.html_url,e.created_at,e.updated_at,e.body))}),u.classList.toggle("display-none",!1))})}},{"./DOM":4,"./commentBlockControl":16,"./formatTime":20,"./messages":26,"./settings":27}],18:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.data=window.DATA,n.relativePathLookUpMap=new Map,function e(t){t.subFolders.forEach(t=>{e(t)}),t.chapters.forEach((e,o)=>{n.relativePathLookUpMap.set(e.htmlRelativePath,{folder:t,chapter:e,inFolderIndex:o})})}(n.data.chapterTree)},{}],19:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./chapterControl"),r=e("./data"),s=e("./history"),a=e("./state");n.followQuery=function(){const e=decodeURIComponent(window.location.hash.substr(1)),t=r.relativePathLookUpMap.get(e);if(void 0!==t){if(a.state.currentChapter!==t)if("function"!=typeof URLSearchParams)o.loadChapter(e);else{const t=new URLSearchParams(window.location.search).get("selection"),n=null!==t?t.split(",").map(e=>+e):[];4===n.length&&n.every(e=>e>=0&&e%1==0&&!Number.isNaN(e)&&Number.isFinite(e))?o.loadChapter(e,n):o.loadChapter(e),document.title=s.getTitle()}}else null!==a.state.currentChapter&&(o.closeChapter(),document.title=s.getTitle())}},{"./chapterControl":15,"./data":18,"./history":22,"./state":29}],20:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=1e3,r=60*o,s=60*r,a=24*s,i=7*a;n.formatTime=function(e){const t=Date.now()-e.getTime();return t>i?`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()}`:t>a?`${Math.floor(t/a)} 天前`:t>s?`${Math.floor(t/s)} 小时前`:t>r?`${Math.floor(t/r)} 分钟前`:`${Math.floor(t/o)} 秒前`}},{}],21:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./DebugLogger"),r=e("./DOM"),s=e("./Event");var a;!function(e){e[e.TO_TOP=0]="TO_TOP",e[e.TO_RIGHT=1]="TO_RIGHT",e[e.TO_BOTTOM=2]="TO_BOTTOM",e[e.TO_LEFT=3]="TO_LEFT"}(a=n.SwipeDirection||(n.SwipeDirection={}));n.swipeEvent=new s.Event;let i=0,c=0,l=0,u=null;window.addEventListener("touchstart",e=>{1===e.touches.length&&(u=e.target,i=e.touches[0].clientX,c=e.touches[0].clientY,l=Date.now())}),window.addEventListener("touchend",e=>{if(0!==e.touches.length)return;if(Date.now()-l>500)return;if(window.innerWidth>900)return;const t=e.changedTouches[0].clientX-i,o=e.changedTouches[0].clientY-c,s=Math.abs(t/window.innerWidth),d=Math.abs(o/window.innerHeight);if(s>.17&&d<.1){if(r.isAnyParent(u,e=>"hidden"!==window.getComputedStyle(e).getPropertyValue("overflow-x")&&e.scrollWidth>e.clientWidth))return;t>0?n.swipeEvent.emit(a.TO_RIGHT):n.swipeEvent.emit(a.TO_LEFT)}else if(d>.1&&s<.1){if(r.isAnyParent(u,e=>"hidden"!==window.getComputedStyle(e).getPropertyValue("overflow-y")&&e.scrollHeight>e.clientHeight))return;o>0?n.swipeEvent.emit(a.TO_BOTTOM):n.swipeEvent.emit(a.TO_TOP)}});const d=new o.DebugLogger("swipeEvent");n.swipeEvent.on(e=>{d.log(a[e])})},{"./DOM":4,"./DebugLogger":5,"./Event":6}],22:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./state");function r(){let e="可穿戴科技";return null!==o.state.currentChapter&&(e+=" - "+o.state.currentChapter.chapter.displayName),e}n.getTitle=r,n.updateHistory=function(e){const t=e?window.history.pushState:window.history.replaceState;let n=window.location.pathname;null!==o.state.currentChapter&&(null!==o.state.chapterSelection&&(n+=`?selection=${o.state.chapterSelection.join(",")}`),n+="#"+o.state.currentChapter.chapter.htmlRelativePath);const s=r();document.title=s,t.call(window.history,null,s,n)}},{"./state":29}],23:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./data"),r=e("./DOM"),s=e("./followQuery"),a=e("./MainMenu"),i=e("./settings"),c=e("./updateSelection"),l=r.id("warning");null!==l&&l.addEventListener("click",()=>{l.style.opacity="0",i.animation.getValue()?l.addEventListener("transitionend",()=>{l.remove()}):l.remove()}),r.id("build-number").innerText=`Build ${o.data.buildNumber}`,(new a.MainMenu).setActive(!0),document.addEventListener("selectionchange",()=>{c.updateSelection()}),window.addEventListener("popstate",()=>{s.followQuery()}),s.followQuery()},{"./DOM":4,"./MainMenu":7,"./data":18,"./followQuery":19,"./settings":27,"./updateSelection":32}],24:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./DebugLogger"),r=e("./Event");var s;!function(e){e[e.LEFT=0]="LEFT",e[e.UP=1]="UP",e[e.RIGHT=2]="RIGHT",e[e.DOWN=3]="DOWN"}(s=n.ArrowKey||(n.ArrowKey={})),n.arrowKeyPressEvent=new r.Event,document.addEventListener("keyup",e=>{switch(e.keyCode){case 37:n.arrowKeyPressEvent.emit(s.LEFT);break;case 38:n.arrowKeyPressEvent.emit(s.UP);break;case 39:n.arrowKeyPressEvent.emit(s.RIGHT);break;case 40:n.arrowKeyPressEvent.emit(s.DOWN)}});const a=new o.DebugLogger("arrowKeyEvent");n.arrowKeyPressEvent.on(e=>{a.log(s[e])})},{"./DebugLogger":5,"./Event":6}],25:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.loadingText="加载中..."},{}],26:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.COMMENTS_UNAVAILABLE="本文评论不可用。",n.COMMENTS_LOADING="评论加载中...",n.COMMENTS_LOADED="以下为本章节的评论区。（您可以在设置中禁用评论）",n.NO_BLOCKED_USERS="没有用户的评论被屏蔽",n.CLICK_TO_UNBLOCK="(点击用户名以解除屏蔽)",n.WTCD_ERROR_COMPILE_TITLE="WTCD 编译失败",n.WTCD_ERROR_COMPILE_DESC="该 WTCD 文档在编译时发生了错误。请检查是否有语法错误或是其他基本错误。",n.WTCD_ERROR_RUNTIME_TITLE="WTCD 运行时错误",n.WTCD_ERROR_RUNTIME_DESC="该 WTCD 文档在运行时发生了错误。请检查是否有逻辑错误。",n.WTCD_ERROR_INTERNAL_TITLE="WTCD 内部错误",n.WTCD_ERROR_INTERNAL_DESC="WTCD 解释器在解释执行该 WTCD 文档时崩溃了。请务必告诉琳你做了什么好让她来修。",n.WTCD_ERROR_MESSAGE="错误信息：",n.WTCD_ERROR_INTERNAL_STACK_TITLE="内部调用栈",n.WTCD_ERROR_INTERNAL_STACK_DESC="内部调用栈记录了出现该错误时编译器或是解释器的状态。请注意内部调用栈通常只在调试 WTCD 编译器或是解释器时有用。内部调用栈通常对调试 WTCD 文档没有作用。"},{}],27:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=()=>{};class r{constructor(e,t,n=o){this.key=e,this.onUpdate=n,this.value=t?"false"!==window.localStorage.getItem(e):"true"===window.localStorage.getItem(e),this.updateLocalStorage(),this.onUpdate(this.value)}updateLocalStorage(){window.localStorage.setItem(this.key,String(this.value))}getValue(){return this.value}setValue(e){e!==this.value&&this.onUpdate(e),this.value=e,this.updateLocalStorage()}toggle(){this.setValue(!this.value)}}n.BooleanSetting=r;class s{constructor(e,t,n,r=o){if(this.key=e,this.options=t,this.defaultValue=n,this.onUpdate=r,!this.isCorrectValue(n))throw new Error(`Default value ${n} is not correct.`);this.value=+(window.localStorage.getItem(e)||n),this.correctValue(),this.onUpdate(this.value,this.options[this.value])}isCorrectValue(e){return!(Number.isNaN(e)||e%1!=0||e<0||e>=this.options.length)}correctValue(){this.isCorrectValue(this.value)||(this.value=this.defaultValue)}updateLocalStorage(){window.localStorage.setItem(this.key,String(this.value))}getValue(){return this.value}getValueName(){return this.options[this.value]}setValue(e){e!==this.value&&this.onUpdate(e,this.options[e]),this.value=e,this.updateLocalStorage()}}n.EnumSetting=s,n.animation=new r("animation",!0,e=>{setTimeout(()=>{document.body.classList.toggle("animation-enabled",e)},1)}),n.warning=new r("warning",!1),n.earlyAccess=new r("earlyAccess",!1,e=>{document.body.classList.toggle("early-access-disabled",!e)}),n.useComments=new r("useComments",!0),n.gestureSwitchChapter=new r("gestureSwitchChapter",!0);const a=['-apple-system, "Noto Sans", "Helvetica Neue", Helvetica, "Nimbus Sans L", Arial, "Liberation Sans", "PingFang SC", "Hiragino Sans GB", "Noto Sans CJK SC", "Source Han Sans SC", "Source Han Sans CN", "Microsoft YaHei", "Wenquanyi Micro Hei", "WenQuanYi Zen Hei", "ST Heiti", SimHei, "WenQuanYi Zen Hei Sharp", sans-serif','Baskerville, Georgia, "Liberation Serif", "Kaiti SC", STKaiti, "AR PL UKai CN", "AR PL UKai HK", "AR PL UKai TW", "AR PL UKai TW MBE", "AR PL KaitiM GB", KaiTi, KaiTi_GB2312, DFKai-SB, "TW-Kai", serif','Georgia, "Nimbus Roman No9 L", "Songti SC", "Noto Serif CJK SC", "Source Han Serif SC", "Source Han Serif CN", STSong, "AR PL New Sung", "AR PL SungtiL GB", NSimSun, SimSun, "TW-Sung", "WenQuanYi Bitmap Song", "AR PL UMing CN", "AR PL UMing HK", "AR PL UMing TW", "AR PL UMing TW MBE", PMingLiU, MingLiU, serif','Baskerville, "Times New Roman", "Liberation Serif", STFangsong, FangSong, FangSong_GB2312, "CWTEX-F", serif'];n.fontFamily=new s("fontFamily",["黑体","楷体","宋体","仿宋"],0,e=>{document.documentElement.style.setProperty("--font-family",a[e]),document.documentElement.style.setProperty("--font-family-mono",'"Fira Code", '+a[e])}),n.developerMode=new r("developerMode",!1),n.charCount=new r("charCount",!0,e=>{document.body.classList.toggle("char-count-disabled",!e)})},{}],28:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.shortNumber=function(e){return e<1e3?String(e):e<1e6?(e/1e3).toFixed(1)+"k":(e/1e6).toFixed(1)+"M"}},{}],29:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.state={currentChapter:null,chapterSelection:null,chapterTextNodes:null}},{}],30:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.stylePreviewArticle="<h1>午饭</h1>\n<p><em>作者：友人♪B</em></p>\n<p>“午饭，午饭♪”</p>\n<p>阳伞下的琳，很是期待今天的午饭。</p>\n<p>或许是体质和别的血族不太一样，琳能够感知到食物的味道，似乎也保有着生物对食物的喜爱。</p>\n<p>虽然她并不能从这些食物中获取能量就是。</p>\n<p>学校食堂的夏季限定甜点今天也很是抢手，这点从队伍的长度就能看出来——队伍险些就要超出食堂的范围了。</p>\n<p>“你说我要有钱多好——”</p>\n<p>已经从隔壁窗口买下了普通，但是很便宜的营养餐的秋镜悬，看着队伍中兴致勃勃的琳。</p>\n<p>其实她并不是缺钱，大约是吝啬。</p>\n<p>这得怪她娘，穷养秋镜悬养习惯了，现在她光自己除灵退魔挣来的外快都够她奢侈上一把了，可却还保留着能不花钱绝对不花，必须花钱越少越好的吝啬习惯。</p>\n<p>少顷，琳已经带着她的甜品建筑——每块砖头都是一块蛋糕，堆成一个诡异的火柴盒——来到了桌前。</p>\n<p>“（吃不胖真好，有钱真好……”</p>\n<p>血族的听觉自然是捕捉到了秋镜悬的嘀咕，琳放下盘子，悄咪咪地将牙贴上了秋镜悬的脖颈。</p>\n<p>“嘻嘻♪”</p>\n<p>“呜——”</p>\n<p>盯——</p>\n<p>秋镜悬看了看盘中剩下的一块毛血旺，似是联系到了什么，将目光转向了琳的牙。</p>\n<p>正在享用蛋糕盛宴的琳以余光瞥见了她的视线，</p>\n<p>“盯着本小姐是要做什么呢？”</p>\n<p>“啊，没，没什么……”</p>\n<p>秋镜悬支支吾吾的说着，</p>\n<p>“就是好奇一个问题，血族为什么不吃毛血旺……”</p>\n<p>“噢☆毛血旺就是那个煮熟的血块是吧？太没有美感了这种血！而且吃了也没法儿恢复能量，简直就是血液的绝佳浪费☆！”</p>\n<p>琳发出了对这样美食的鄙视，不过这种鄙视大约只有血族和蚊子会出现吧……</p>\n<p>“血族需要摄入血，是因为血所具有的生命能量，如果煮熟了的话，超过九成的能量都被转化成其他的东西了，对我们来说实在是没什么用处，还白白浪费了作为原料的血，这种东西本小姐才不吃咧✘！饿死，死外边，从这边跳下去也不吃✘！”</p>\n<p>“欸，别这么说嘛，你能尝得到味道的吧，吃一块试试呗？”</p>\n<p>“真……真香♪”</p>\n<p>当晚，因为触发了真香定律而感到很火大的琳，把秋镜悬丢进了自己的高维空间里头放置了一晚上（高维时间三天）泄愤。</p>"},{}],31:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.thanks=[{name:"神楽坂 立音"},{name:"lgd_小翅膀"},{name:"青葉"},{name:"kn"},{name:"F74nk",link:"https://t.me/F74nk_K"},{name:"杨佳文"},{name:"不知名的N姓人士就好"},{name:"某不愿透露姓名的N性？"},{name:"神楽坂 萌绫"},{name:"Butby"},{name:"友人♪B"},{name:"NekoCaffeine"},{name:"RainSlide"},{name:"czp",link:"https://www.hiczp.com"},{name:"kookxiang"},{name:"櫻川 紗良"},{name:"Skimige"},{name:"TExL",link:"http://texas.penguin-logistics.cn"},{name:"路人乙"},{name:"pokemonchw",link:"https://github.com/pokemonchw"},{name:"帕蒂卡",link:"https://github.com/Patika-ailemait"},{name:"零件",link:"https://nekosc.com"},{name:"幻梦",link:"https://t.me/HuanmengQwQ"},{name:"acted咕咕喵",link:"https://acted.gitlab.io"},{name:"重水时雨",link:"https://t.me/boatmasteronD2O"},{name:"神楽坂 紫"},{name:"Runian Lee",link:"https://t.me/Runian"}].sort(()=>Math.random()-.5)},{}],32:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./history"),r=e("./state");n.updateSelection=function(){if(null===r.state.chapterTextNodes)return;const e=String(r.state.chapterSelection),t=document.getSelection();if(null===t)r.state.chapterSelection=null;else{const e=t.anchorNode instanceof HTMLElement?t.anchorNode.firstChild:t.anchorNode,n=r.state.chapterTextNodes.indexOf(e),o=t.focusNode instanceof HTMLElement?t.focusNode.firstChild:t.focusNode,s=r.state.chapterTextNodes.indexOf(o);-1===n||-1===s||n===s&&t.anchorOffset===t.focusOffset?r.state.chapterSelection=null:n<s||n===s&&t.anchorOffset<t.focusOffset?r.state.chapterSelection=[n,t.anchorOffset,s,t.focusOffset]:r.state.chapterSelection=[s,t.focusOffset,n,t.anchorOffset]}e!==String(r.state.chapterSelection)&&o.updateHistory(!1)}},{"./history":22,"./state":29}],33:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./Interpreter"),r=e("./Random");n.FlowReader=class{constructor(e,t,n){this.wtcdRoot=t,this.errorMessageCreator=n,this.currentDecisionIndex=0,this.buttons=[],this.contents=[],this.started=!1,this.storageKey=`wtcd.fr.${e}`,this.data=this.parseData(window.localStorage.getItem(this.storageKey))||{random:String(Math.random()),decisions:[]},this.resetInterpreter()}parseData(e){if("string"!=typeof e)return null;let t;try{t=JSON.parse(e)}catch(e){return null}return"string"!=typeof t.random?null:Array.isArray(t.decisions)?t.decisions.some(e=>"number"!=typeof e)?null:t:null}persist(){window.localStorage.setItem(this.storageKey,JSON.stringify(this.data))}next(e){try{return this.interpreterIterator.next(e)}catch(e){const t=this.errorMessageCreator(e);return this.target.appendChild(t),this.contents.push(t),{done:!0,value:{choices:[],content:[]}}}}resetInterpreter(){const e=new o.Interpreter(this.wtcdRoot,new r.Random(this.data.random));this.interpreterIterator=e.start()}decide(e,t=!1){this.buttons[this.currentDecisionIndex].forEach((t,n)=>{t.classList.contains("disabled")||(t.classList.remove("candidate"),n===e?t.classList.add("selected"):t.classList.add("unselected"))}),t||this.data.decisions.push(e),this.currentDecisionIndex++;const n=this.next(e);return this.handleOutput(n.value),n.done}undecide(e){this.resetInterpreter(),this.data.decisions.splice(e),this.buttons.splice(e+1),this.contents.splice(e+1).forEach(e=>e.remove()),this.next();for(const e of this.data.decisions)this.next(e);this.buttons[e].forEach(e=>{e.classList.contains("disabled")||(e.classList.remove("selected","unselected"),e.classList.add("candidate"))}),this.currentDecisionIndex=e}handleOutput(e){const t=document.createElement("div");e.content.forEach(e=>t.appendChild(e));const n=this.currentDecisionIndex;this.buttons.push(e.choices.map((e,o)=>{const r=document.createElement("div");return r.classList.add("wtcd-button"),r.innerText=e.content,e.disabled?r.classList.add("disabled"):(r.classList.add("candidate"),r.addEventListener("click",()=>{this.data.decisions[n]===o?(this.undecide(n),this.persist()):this.currentDecisionIndex===n&&(this.decide(o),this.persist())})),t.appendChild(r),r})),this.contents.push(t),this.target.appendChild(t)}renderTo(e){if(this.started)throw new Error("Flow Interface already started.");this.started=!0,this.target=e;const t=this.next();let n=t.done;this.handleOutput(t.value);for(const e of this.data.decisions){if(n)return;n=this.decide(e,!0)}}}},{"./Interpreter":34,"./Random":35}],34:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./constantsPool"),r=e("./operators"),s=e("./WTCDError");var a;!function(e){e[e.YIELD=0]="YIELD",e[e.RETURN=1]="RETURN"}(a||(a={}));class i extends Error{constructor(e){super("Uncaught Bubble Signal."),this.type=e,Object.setPrototypeOf(this,new.target.prototype)}}function c(e){switch(e.type){case"number":case"boolean":return`${e.type} ${e.value}`;case"string":return`string "${e.value}"`;case"choice":return`a choice for action ${c(e.value.action)} with label "${e.value.text}"`;case"action":switch(e.value.action){case"goto":return`an action for goto to ${e.value.target}`;case"exit":return"an action for exiting"}case"null":return"null";case"selection":return`a selection among the following choices: [${e.value.choices.map(c).join(", ")}]`}}n.describe=c;class l{constructor(){this.variables=new Map,this.registers=null}resolveVariableReference(e){return this.variables.get(e)||null}addVariable(e,t,n){this.variables.set(e,{type:t,value:n})}addRegister(e){null===this.registers&&(this.registers=new Map),this.registers.set(e,o.getMaybePooled("null",null))}setRegisterIfExist(e,t){return null!==this.registers&&(!!this.registers.has(e)&&(this.registers.set(e,t),!0))}getRegister(e){return this.registers&&this.registers.get(e)||null}}class u extends Error{constructor(e){super(`Invalid choice ${e}.`),this.choiceId=e}}n.InvalidChoiceError=u;n.Interpreter=class{constructor(e,t){this.wtcdRoot=e,this.random=t,this.scopes=[new l],this.sectionStack=[],this.resolveVariableReference=e=>{for(let t=this.scopes.length-1;t>=0;t--){const n=this.scopes[t].resolveVariableReference(e);if(null!==n)return n}throw s.WTCDError.atUnknown(`Cannot resolve variable reference "${e}". `+"This is most likely caused by WTCD compiler's error or the compiled output has been modified")},this.evaluator=e=>{switch(e.type){case"unaryExpression":return r.unaryOperators.get(e.operator).fn(e,this.evaluator);case"binaryExpression":return r.binaryOperators.get(e.operator).fn(e,this.evaluator,this.resolveVariableReference);case"booleanLiteral":return o.getMaybePooled("boolean",e.value);case"numberLiteral":return o.getMaybePooled("number",e.value);case"stringLiteral":return o.getMaybePooled("string",e.value);case"nullLiteral":return o.getMaybePooled("null",null);case"choiceExpression":return this.evaluateChoiceExpression(e);case"conditionalExpression":return this.evaluateConditionalExpression(e);case"block":return this.evaluateBlockExpression(e);case"gotoAction":return{type:"action",value:{action:"goto",target:e.sections}};case"exitAction":return{type:"action",value:{action:"exit"}};case"selection":return this.evaluateSelectionExpression(e);case"variableReference":return this.resolveVariableReference(e.variableName)}},this.started=!1,this.sectionEnterTimes=new Map,this.currentlyBuilding=[],this.sectionStack.push(this.wtcdRoot.sections[0])}setRegister(e,t){for(let n=this.scopes.length-1;n>=0;n--)if(this.scopes[n].setRegisterIfExist(e,t))return;throw s.WTCDError.atUnknown(`Cannot resolve register reference "${e}". `+"This is mostly likely caused by WTCD compiler's error or the compiled output has been modified")}getCurrentScope(){return this.scopes[this.scopes.length-1]}pushScope(){const e=new l;return this.scopes.push(e),e}popScope(){this.scopes.pop()}evaluateChoiceExpression(e){const t=this.evaluator(e.text);if("string"!==t.type)throw s.WTCDError.atLocation(e,"First argument of choice is expected to be a string, "+`received: ${c(t)}`);const n=this.evaluator(e.action);if("action"!==n.type&&"null"!==n.type)throw s.WTCDError.atLocation(e,"First argument of choice is expected to be an action "+`or null, received: ${c(t)}`);return{type:"choice",value:{text:t.value,action:n}}}evaluateConditionalExpression(e){const t=this.evaluator(e.condition);if("boolean"!==t.type)throw s.WTCDError.atLocation(e,"First argument of a conditional expression is expected to "+`be a boolean, received: ${c(t)}`);return t.value?this.evaluator(e.then):this.evaluator(e.otherwise)}executeDeclarationStatement(e){for(const t of e.declarations){let n;if(null!==t.initialValue)n=this.evaluator(t.initialValue);else switch(t.variableType){case"boolean":n=o.getMaybePooled("boolean",!1);break;case"number":n=o.getMaybePooled("number",0);break;case"string":n=o.getMaybePooled("string","");break;default:throw s.WTCDError.atLocation(e,`Variable type ${t.variableType} `+"does not have a default initial value")}if(n.type!==t.variableType)throw s.WTCDError.atLocation(e,`The type of variable ${t.variableName} is `+`${t.variableType}, thus cannot hold ${c(n)}`);this.getCurrentScope().addVariable(t.variableName,t.variableType,n.value)}}evaluateBlockExpression(e){const t=this.pushScope();t.addRegister("yield");try{for(const t of e.statements)this.executeStatement(t);return t.getRegister("yield")}catch(e){if(e instanceof i&&e.type===a.YIELD)return t.getRegister("yield");throw e}finally{this.popScope()}}evaluateSelectionExpression(e){const t=e.choices.map(e=>this.evaluator(e)).filter(e=>"null"!==e.type);for(let n=0;n<t.length;n++)if("choice"!==t[n].type)throw s.WTCDError.atLocation(e.choices[n],`Choice at index ${n} is expected to be a choice, `+`received ${c(t[n])}`);return{type:"selection",value:{choices:t}}}executeStatement(e){switch(e.type){case"declaration":return void this.executeDeclarationStatement(e);case"expression":return void this.evaluator(e.expression);case"yield":throw this.setRegister("yield",this.evaluator(e.value)),new i(a.YIELD);case"setYield":return void this.setRegister("yield",this.evaluator(e.value));default:throw s.WTCDError.atLocation(e,"Not implemented")}}addToSectionStack(e){for(const t of this.wtcdRoot.sections)if(t.name===e)return void this.sectionStack.push(t);throw s.WTCDError.atUnknown(`Unknown section "${e}"`)}executeAction(e){switch(e.value.action){case"goto":for(let t=e.value.target.length-1;t>=0;t--)this.addToSectionStack(e.value.target[t]);break;case"exit":this.sectionStack.length=0}}*start(){if(this.started)throw new Error("Interpretation has already started.");this.started=!0;try{for(const e of this.wtcdRoot.initStatements)this.executeStatement(e);const e=document.createElement("div");for(;0!==this.sectionStack.length;){const t=this.sectionStack.pop();null!==t.executes&&this.evaluator(t.executes);const n=this.sectionEnterTimes.has(t.name)?this.sectionEnterTimes.get(t.name)+1:1;this.sectionEnterTimes.set(t.name,n);const o=t.content.filter(e=>(void 0===e.lowerBound||e.lowerBound<=n)&&(void 0===e.upperBound||e.upperBound>=n));if(0!==o.length){const t=o[this.random.nextInt(0,o.length)];e.innerHTML=t.html;for(const n of t.variables)e.getElementsByClassName(n.elementClass)[0].innerText=String(this.resolveVariableReference(n.variableName).value);let n=e.firstChild;for(;null!==n;)n instanceof HTMLElement&&this.currentlyBuilding.push(n),n=n.nextSibling}const r=this.evaluator(t.then);if("selection"===r.type){const e=r.value.choices.map(e=>({content:e.value.text,disabled:"null"===e.value.action.type})),t={content:this.currentlyBuilding,choices:e};this.currentlyBuilding=[];const n=yield t,o=r.value.choices[n];if(void 0===o||"null"===o.value.action.type)throw new u(n);this.executeAction(o.value.action)}else if("action"===r.type)this.executeAction(r);else if("null"!==r.type)throw s.WTCDError.atLocation(t.then,"Expression after then is expected to return "+`selection, action, or null. Received: ${c(r)}`)}}catch(e){if(e instanceof i)throw s.WTCDError.atUnknown(`Uncaught BubbleSignal with type "${e.type}".`);throw e}return{content:this.currentlyBuilding,choices:[]}}}},{"./WTCDError":36,"./constantsPool":37,"./operators":38}],35:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.Random=class{constructor(e){const t=function(e){let t=1779033703^e.length;for(let n=0;n<e.length;n++)t=(t=Math.imul(t^e.charCodeAt(n),3432918353))<<13|t>>>19;return()=>(t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0)}(e);var n,o,r,s;this.rng=(n=t(),o=t(),r=t(),s=t(),()=>{let e=(n>>>=0)+(o>>>=0)|0;return n=o^o>>>9,o=(r>>>=0)+(r<<3)|0,r=(r=r<<21|r>>>11)+(e=e+(s=1+(s>>>=0)|0)|0)|0,(e>>>0)/4294967296})}next(e=0,t=1){return this.rng()*(t-e)+e}nextBool(){return this.rng()<.5}nextInt(e=0,t=1){return Math.floor(this.next(e,t))}}},{}],36:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});class o extends Error{constructor(e,t,n){super(e),this.line=t,this.column=n,this.name="WTCDError"}static atUnknown(e){return new o(e+" at unknown location. (Location info is not available for this type of error)",null,null)}static atLineColumn(e,t,n){return new o(n+` at ${e}:${t}.`,e,t)}static atLocation(e,t){return void 0===e.line?new o(t+" at unknown location. (Try recompile in debug mode to enable source map)",null,null):this.atLineColumn(e.line,e.column,t)}}n.WTCDError=o},{}],37:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.nullValue={type:"null",value:null},n.trueValue={type:"boolean",value:!0},n.falseValue={type:"boolean",value:!1},n.smallIntegers=[];for(let e=0;e<=100;e++)n.smallIntegers.push({type:"number",value:e});function o(e){return e?n.trueValue:n.falseValue}n.booleanValue=o,n.getMaybePooled=function(e,t){return"null"===e?n.nullValue:"boolean"===e?o(t):"number"===e&&t>=0&&t<=100?n.smallIntegers[t]:{type:e,value:t}}},{}],38:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const o=e("./constantsPool"),r=e("./Interpreter"),s=e("./WTCDError");function a(e){return(t,n,o)=>{const r=n(t.arg0),s=n(t.arg1);return e(r,s,t,n,o)}}function i(e,t,n){return a((a,i,c,l,u)=>{if(a.type===e&&i.type===e)return o.getMaybePooled(t,n(a.value,i.value,c,l,u));throw s.WTCDError.atLocation(c,`Binary operator "${c.operator}" can only be `+`applied to two ${e}s. Received: ${r.describe(a)} (left) and `+`${r.describe(i)} (right)`)})}function c(e,t,n){return(a,i,c)=>{if("variableReference"!==a.arg0.type)throw s.WTCDError.atLocation(a,`Left side of binary operator "${a.operator}" `+"has to be a variable reference");const l=c(a.arg0.variableName);if(l.type!==e)throw s.WTCDError.atLocation(a,`Left side of binary operator "${a.operator}" has to be a `+`variable of type ${e}, actual type: ${l.type}`);const u=i(a.arg1);if(u.type!==t)throw s.WTCDError.atLocation(a,`Right side of binary operator "${a.operator}" `+` has to be a ${t}. Received: ${r.describe(u)}`);const d=n(l.value,u.value,a,i,c);return l.value=d,o.getMaybePooled(e,d)}}n.unaryOperators=new Map([["-",{precedence:16,fn:(e,t)=>{const n=t(e.arg);if("number"!==n.type)throw s.WTCDError.atLocation(e,'Unary operator "-" can only be applied '+`to a number. Received: ${r.describe(n)}`);return o.getMaybePooled("number",-n.value)}}],["!",{precedence:16,fn:(e,t)=>{const n=t(e.arg);if("boolean"!==n.type)throw s.WTCDError.atLocation(e,'Unary operator "!" can only be applied '+`to a boolean. Received: ${r.describe(n)}`);return o.getMaybePooled("boolean",!n.value)}}]]),n.binaryOperators=new Map([["=",{precedence:3,fn:(e,t,n)=>{if("variableReference"!==e.arg0.type)throw s.WTCDError.atLocation(e,'Left side of binary operator "=" has to be a variable reference');const o=n(e.arg0.variableName),a=t(e.arg1);if(a.type!==o.type)throw s.WTCDError.atLocation(e,`Variable "${e.arg0.variableName}" can only hold `+`values of type ${o.type}. Received ${r.describe(a)}`);return o.value=a.value,a}}],["+=",{precedence:3,fn:(e,t,n)=>{if("variableReference"!==e.arg0.type)throw s.WTCDError.atLocation(e,'Left side of binary operator "+=" has to be a variable reference');const a=n(e.arg0.variableName);if("string"!==a.type&&"number"!==a.type)throw s.WTCDError.atLocation(e,'Left side of binary operator "+=" has to be a '+`variable of type number or string, actual type: ${a.type}`);const i=t(e.arg1);if(i.type!==a.type)throw s.WTCDError.atLocation(e,'Right side of binary operator "+=" has to '+` be a ${a.type}. Received: ${r.describe(i)}`);const c=a.value+i.value;return a.value=c,o.getMaybePooled(a.type,c)}}],["-=",{precedence:3,fn:c("number","number",(e,t)=>e-t)}],["*=",{precedence:3,fn:c("number","number",(e,t)=>e*t)}],["/=",{precedence:3,fn:c("number","number",(e,t)=>e/t)}],["~/=",{precedence:3,fn:c("number","number",(e,t)=>Math.trunc(e/t))}],["%=",{precedence:3,fn:c("number","number",(e,t)=>e%t)}],["||",{precedence:5,fn:(e,t)=>{const n=t(e.arg0);if("boolean"!==n.type)throw s.WTCDError.atLocation(e,'Left side of binary operator "||" has to be a boolean. '+`Received ${r.describe(n)}`);if(!0===n.value)return o.getMaybePooled("boolean",!0);const a=t(e.arg1);if("boolean"!==a.type)throw s.WTCDError.atLocation(e,'Right side of binary operator "||" has to be a boolean. '+`Received ${r.describe(a)}`);return o.getMaybePooled("boolean",a.value)}}],["&&",{precedence:6,fn:(e,t)=>{const n=t(e.arg0);if("boolean"!==n.type)throw s.WTCDError.atLocation(e,'Left side of binary operator "&&" has to be a boolean. '+`Received ${r.describe(n)}`);if(!1===n.value)return o.getMaybePooled("boolean",!1);const a=t(e.arg1);if("boolean"!==a.type)throw s.WTCDError.atLocation(e,'Right side of binary operator "&&" has to be a boolean. '+`Received ${r.describe(a)}`);return o.getMaybePooled("boolean",a.value)}}],["==",{precedence:10,fn:a((e,t)=>o.getMaybePooled("boolean",e.type===t.type&&e.value===t.value))}],["!=",{precedence:10,fn:a((e,t)=>o.getMaybePooled("boolean",e.type!==t.type||e.value!==t.value))}],["<",{precedence:11,fn:i("number","boolean",(e,t)=>e<t)}],["<=",{precedence:11,fn:i("number","boolean",(e,t)=>e<=t)}],[">",{precedence:11,fn:i("number","boolean",(e,t)=>e>t)}],[">=",{precedence:11,fn:i("number","boolean",(e,t)=>e>=t)}],["+",{precedence:13,fn:a((e,t,n)=>{if("number"===e.type&&"number"===t.type)return o.getMaybePooled("number",e.value+t.value);if("string"===e.type&&"string"===t.type)return o.getMaybePooled("string",e.value+t.value);throw s.WTCDError.atLocation(n,'Binary operator "+" can only be applied to two '+`strings or two numbers. Received: ${r.describe(e)} (left) and `+`${r.describe(t)} (right)`)})}],["-",{precedence:13,fn:i("number","number",(e,t)=>e+t)}],["*",{precedence:14,fn:i("number","number",(e,t)=>e*t)}],["/",{precedence:14,fn:i("number","number",(e,t)=>e/t)}],["~/",{precedence:14,fn:i("number","number",(e,t)=>Math.trunc(e/t))}],["%",{precedence:14,fn:i("number","number",(e,t)=>e%t)}]]),n.conditionalOperatorPrecedence=4,n.operators=new Set([...n.unaryOperators.keys(),...n.binaryOperators.keys(),"?",":"])},{"./Interpreter":34,"./WTCDError":36,"./constantsPool":37}]},{},[23]);