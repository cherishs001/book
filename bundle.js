!function r(e,t,n){function o(i,s){if(!t[i]){if(!e[i]){var l="function"==typeof require&&require;if(!s&&l)return l(i,!0);if(a)return a(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var u=t[i]={exports:{}};e[i][0].call(u.exports,(function(t){return o(e[i][1][t]||t)}),u,u.exports,r,e,t,n)}return t[i].exports}for(var a="function"==typeof require&&require,i=0;i<n.length;i++)o(n[i]);return o}({1:[function(e,t,n){},{}],2:[function(e,t,n){
/*!
 * Cross-Browser Split 1.1.1
 * Copyright 2007-2012 Steven Levithan <stevenlevithan.com>
 * Available under the MIT License
 * ECMAScript compliant, uniform cross-browser split method
 */
t.exports=function split(e){var t=String.prototype.split,n=/()??/.exec("")[1]===e;return function(a,i,s){if("[object RegExp]"!==Object.prototype.toString.call(i))return t.call(a,i,s);var l,c,u,d,p=[],g=(i.ignoreCase?"i":"")+(i.multiline?"m":"")+(i.extended?"x":"")+(i.sticky?"y":""),f=0;i=new RegExp(i.source,g+"g");for(a+="",n||(l=new RegExp("^"+i.source+"$(?!\\s)",g)),s=s===e?-1>>>0:s>>>0;(c=i.exec(a))&&!((u=c.index+c[0].length)>f&&(p.push(a.slice(f,c.index)),!n&&c.length>1&&c[0].replace(l,(function(){for(var t=1;t<arguments.length-2;t++)arguments[t]===e&&(c[t]=e)})),c.length>1&&c.index<a.length&&Array.prototype.push.apply(p,c.slice(1)),d=c[0].length,f=u,p.length>=s));)i.lastIndex===c.index&&i.lastIndex++;return f===a.length?!d&&i.test("")||p.push(""):p.push(a.slice(f)),p.length>s?p.slice(0,s):p}}()},{}],3:[function(e,t,n){var a=e("indexof");function isTruthy(e){return!!e}t.exports=function ClassList(e){var t=e.classList;if(t)return t;var n={add:add,remove:remove,contains:contains,toggle:function toggle(e){return contains(e)?(remove(e),!1):(add(e),!0)},toString:function $toString(){return e.className},length:0,item:function item(e){return getTokens()[e]||null}};return n;function add(e){var t=getTokens();a(t,e)>-1||(t.push(e),setTokens(t))}function remove(e){var t=getTokens(),n=a(t,e);-1!==n&&(t.splice(n,1),setTokens(t))}function contains(e){return a(getTokens(),e)>-1}function getTokens(){return function filter(e,t){for(var n=[],a=0;a<e.length;a++)t(e[a])&&n.push(e[a]);return n}(e.className.split(" "),isTruthy)}function setTokens(t){var a=t.length;e.className=t.join(" "),n.length=a;for(var i=0;i<t.length;i++)n[i]=t[i];delete t[a]}}},{indexof:5}],4:[function(e,t,n){var a=e("browser-split"),i=e("class-list"),s="undefined"==typeof window?e("html-element"):window,l=s.document,c=s.Text;function context(){var e=[];function h(){var t=[].slice.call(arguments),n=null;function item(t){var s;if(null==t);else if("string"==typeof t)n?n.appendChild(s=l.createTextNode(t)):function parseClass(e){var t=a(e,/([\.#]?[^\s#.]+)/);/^\.|#/.test(t[1])&&(n=l.createElement("div")),forEach(t,(function(e){var t=e.substring(1,e.length);e&&(n?"."===e[0]?i(n).add(t):"#"===e[0]&&n.setAttribute("id",t):n=l.createElement(e))}))}(t);else if("number"==typeof t||"boolean"==typeof t||t instanceof Date||t instanceof RegExp)n.appendChild(s=l.createTextNode(t.toString()));else if(isArray(t))forEach(t,item);else if(isNode(t))n.appendChild(s=t);else if(t instanceof c)n.appendChild(s=t);else if("object"==typeof t)for(var u in t)if("function"==typeof t[u])/^on\w+/.test(u)?function(t,a){n.addEventListener?(n.addEventListener(t.substring(2),a[t],!1),e.push((function(){n.removeEventListener(t.substring(2),a[t],!1)}))):(n.attachEvent(t,a[t]),e.push((function(){n.detachEvent(t,a[t])})))}(u,t):(n[u]=t[u](),e.push(t[u]((function(e){n[u]=e}))));else if("style"===u)if("string"==typeof t[u])n.style.cssText=t[u];else for(var d in t[u])!function(a,i){if("function"==typeof i)n.style.setProperty(a,i()),e.push(i((function(e){n.style.setProperty(a,e)})));else var s=t[u][a].match(/(.*)\W+!important\W*$/);s?n.style.setProperty(a,s[1],"important"):n.style.setProperty(a,t[u][a])}(d,t[u][d]);else if("attrs"===u)for(var p in t[u])n.setAttribute(p,t[u][p]);else"data-"===u.substr(0,5)?n.setAttribute(u,t[u]):n[u]=t[u];else if("function"==typeof t){p=t();n.appendChild(s=isNode(p)?p:l.createTextNode(p)),e.push(t((function(e){isNode(e)&&s.parentElement?(s.parentElement.replaceChild(e,s),s=e):s.textContent=e})))}return s}for(;t.length;)item(t.shift());return n}return h.cleanup=function(){for(var t=0;t<e.length;t++)e[t]();e.length=0},h}function isNode(e){return e&&e.nodeName&&e.nodeType}function forEach(e,t){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n++)t(e[n],n)}function isArray(e){return"[object Array]"==Object.prototype.toString.call(e)}(t.exports=context()).context=context},{"browser-split":2,"class-list":3,"html-element":1}],5:[function(e,t,n){var a=[].indexOf;t.exports=function(e,t){if(a)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}},{}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./constant/materialDarkColors"),i=e("./data/settings"),s=e("./util/stringHash");n.DebugLogger=class DebugLogger{constructor(e){this.prefix="%c"+e,this.css="background-color: #"+a.materialDarkColors[Math.abs(s.stringHash(e))%a.materialDarkColors.length]+"; border-radius: 0.3em; padding: 0 0.3em; color: white"}log(...e){i.developerMode.getValue()&&console.info(this.prefix,this.css,...e)}warn(...e){console.warn(this.prefix,this.css,...e)}error(...e){console.error(this.prefix,this.css,...e)}}},{"./constant/materialDarkColors":10,"./data/settings":34,"./util/stringHash":56}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.Event=class Event{constructor(){this.listeners=null,this.onceListeners=null,this.isEmitting=!1,this.queue=[]}on(e){return this.isEmitting?(this.queue.push(()=>{this.on(e)}),e):(null===this.listeners&&(this.listeners=new Set),this.listeners.add(e),e)}off(e){this.isEmitting?this.queue.push(()=>{this.off(e)}):null!==this.listeners&&this.listeners.delete(e)}once(e){return this.isEmitting?(this.queue.push(()=>{this.once(e)}),e):(null===this.onceListeners&&(this.onceListeners=[]),this.onceListeners.push(e),e)}expect(e){return this.isEmitting?new Promise(t=>{this.queue.push(()=>{this.expect(e).then(t)})}):new Promise(void 0===e?e=>this.once(e):t=>{const n=this.on(a=>{e(a)&&(this.off(n),t(a))})})}emit(e){this.isEmitting?this.queue.push(()=>{this.emit(e)}):(this.isEmitting=!0,null!==this.listeners&&this.listeners.forEach(t=>t(e)),null!==this.onceListeners&&(this.onceListeners.forEach(t=>t(e)),this.onceListeners.length=0),this.isEmitting=!1,this.queue.forEach(e=>e()),this.queue.length=0)}}},{}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./control/layoutControl"),i=e("./DebugLogger"),s=e("./Event");var l;function createSpan(e,...t){const n=document.createElement("span");return n.innerText=e,n.classList.add(...t),n}!function(e){e[e.SELECTABLE=0]="SELECTABLE",e[e.BACK=1]="BACK",e[e.ICON_FOLDER=2]="ICON_FOLDER",e[e.ICON_LINK=3]="ICON_LINK",e[e.ICON_EQUALIZER=4]="ICON_EQUALIZER",e[e.ICON_FILE=5]="ICON_FILE",e[e.ICON_GAME=6]="ICON_GAME"}(l=n.ItemDecoration||(n.ItemDecoration={}));class ItemHandle{constructor(e,t){this.menu=e,this.element=t,this.$prependSpan=null,this.$appendSpan=null}setSelected(e){return this.element.classList.toggle("selected",e),this}onClick(e){return this.element.addEventListener("click",()=>{e(this.element)}),this}linkTo(e){return this.onClick(()=>{this.menu.navigateTo(e)}),this}setInnerText(e){return this.element.innerText=e,this}addClass(e){return this.element.classList.add(e),this}removeClass(e){return this.element.classList.remove(e),this}prepend(e,t){null===this.$prependSpan&&(this.$prependSpan=createSpan("","prepend"),this.element.prepend(this.$prependSpan));const n=createSpan(e,"item-side");return void 0!==t&&n.classList.add(t),this.$prependSpan.prepend(n),n}append(e,t){null===this.$appendSpan&&(this.$appendSpan=createSpan("","append"),this.element.appendChild(this.$appendSpan));const n=createSpan(e,"item-side");return void 0!==t&&n.classList.add(t),this.$appendSpan.appendChild(n),n}}n.ItemHandle=ItemHandle;n.Menu=class Menu{constructor(e,t,n=a.Layout.OFF){if(this.name=e,this.parent=t,this.layout=n,this.active=!1,this.clearableElements=[],this.activateEvent=new s.Event,this.debugLogger=new i.DebugLogger(`Menu (${e})`),this.fullPath=null===t?[]:t.fullPath.slice(),""!==e&&this.fullPath.push(e),this.container=document.createElement("div"),this.container.classList.add("menu","hidden"),this.fullPath.length>=1){const e=document.createElement("div");e.classList.add("path"),e.innerText=this.fullPath.join(" > "),this.container.appendChild(e)}null!==t&&this.addItem("返回",{button:!0,decoration:l.BACK,unclearable:!0}).linkTo(t),document.body.appendChild(this.container),a.layoutChangeEvent.on(({newLayout:e})=>{this.active&&e===a.Layout.MAIN&&(this.setActive(!1),a.layoutChangeEvent.expect().then(()=>{this.setActive(!0)}))})}navigateTo(e){this.setActive(!1),e.setActive(!0),a.setLayout(e.layout)}exit(){if(null===this.parent)throw new Error("Cannot exit the root menu.");this.navigateTo(this.parent)}setActive(e){this.debugLogger.log(`setActive(${e})`),!this.active&&e&&this.activateEvent.emit(),this.active=e,this.container.classList.toggle("hidden",!e)}isActive(){return this.active}addItem(e,t){let n;if(t.button&&void 0!==t.link?(n=document.createElement("a"),n.href=t.link,n.rel="noopener noreferrer",n.target="_blank"):n=document.createElement("div"),n.innerText=e,t.small&&n.classList.add("small"),t.button)switch(n.classList.add("button"),t.decoration){case l.BACK:n.classList.add("back");break;case l.SELECTABLE:n.classList.add("selectable");break;case l.ICON_FOLDER:n.classList.add("icon","folder");break;case l.ICON_LINK:n.classList.add("icon","link");break;case l.ICON_EQUALIZER:n.classList.add("icon","equalizer");break;case l.ICON_FILE:n.classList.add("icon","file");break;case l.ICON_GAME:n.classList.add("icon","game")}return this.container.appendChild(n),t.unclearable||this.clearableElements.push(n),new ItemHandle(this,n)}clearItems(){this.clearableElements.forEach(e=>e.remove()),this.clearableElements=[]}addLink(e,t,n){return this.addItem(e.name,{small:t,button:!0,decoration:n}).linkTo(e)}}},{"./DebugLogger":6,"./Event":7,"./control/layoutControl":27}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.loadingText="加载中..."},{}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.materialDarkColors=["b71c1c","880e4f","4a148c","311b92","1a237e","0d47a1","01579b","006064","004d40","1b5e20","33691e","827717","bf360c","3e2723","795548","5d4037","1976d2","303f9f","3f51b5","673ab7","9c27b0","c2185b","d32f2f","263238","455a64","616161","212121"]},{}],11:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.EARLY_ACCESS_TITLE="编写中章节",n.EARLY_ACCESS_DESC="请注意，本文正在编写中，因此可能会含有未完成的句子或是尚未更新的信息。",n.PREVIOUS_CHAPTER="上一章",n.GO_TO_MENU="返回",n.NEXT_CHAPTER="下一章",n.CHAPTER_LOADING="章节加载中...",n.CHAPTER_FAILED="章节加载失败，请检查网络连接。",n.COMMENTS_SECTION="评论区",n.COMMENTS_LOADING="评论加载中...",n.COMMENTS_UNAVAILABLE="本文评论不可用。",n.COMMENTS_CREATE="+ 添加评论",n.COMMENTS_LOADED="以下为本章节的评论区。",n.COMMENTS_FAILED="评论加载失败，请检查网络连接。",n.NO_BLOCKED_USERS="没有用户的评论被屏蔽",n.CLICK_TO_UNBLOCK="(点击用户名以解除屏蔽)",n.WTCD_GAME_RESTART="重置游戏",n.WTCD_GAME_RESTART_TITLE="是否重置游戏种子",n.WTCD_GAME_RESTART_DESC="游戏种子会决定游戏的随机因素。",n.WTCD_GAME_RESTART_ALL_DESC="若选择【重置游戏种子与进度】，那么新游戏中的所有随机因素和本游戏不一致。",n.WTCD_GAME_RESTART_DECISION_ONLY_DESC="若选择【仅重置进度】，那么新游戏中的随机因素将与本游戏完全一致。",n.WTCD_GAME_RESTART_ALL="重置游戏种子与进度",n.WTCD_GAME_RESTART_DECISION_ONLY="仅重置进度",n.WTCD_GAME_RESTART_CANCEL="不重置任何内容",n.WTCD_GAME_RESTART_OK="游戏重置成功",n.WTCD_GAME_SAVE="存储",n.WTCD_GAME_SAVE_TITLE="请选择要存储的位置",n.WTCD_GAME_SAVE_CANCEL="取消",n.WTCD_GAME_SAVE_NEW="- 新存档 -",n.WTCD_GAME_SAVE_OVERWRITE_TITLE="是否覆盖？",n.WTCD_GAME_SAVE_OVERWRITE_CONFIRM="确认覆盖",n.WTCD_GAME_SAVE_OVERWRITE_CANCEL="取消",n.WTCD_GAME_SAVE_OK="存储成功",n.WTCD_GAME_LOAD="读取",n.WTCD_GAME_LOAD_TITLE="请选择要读取的存档",n.WTCD_GAME_LOAD_CANCEL="取消",n.WTCD_GAME_LOAD_QUICK="快",n.WTCD_GAME_LOAD_OK="读取成功",n.WTCD_GAME_QUICK_SAVE="快速存储",n.WTCD_GAME_QUICK_SAVE_OK="快速存储成功",n.WTCD_GAME_QUICK_LOAD="快速读取",n.WTCD_GAME_QUICK_LOAD_OK="快速读取成功",n.WTCD_GAME_QUICK_LOAD_NOT_EXIST="没有可用的快速存档，请先使用【快速存储】来创建快速存档。",n.WTCD_GAME_QUICK_LOAD_CONFIRM_TITLE="是否快速读取？",n.WTCD_GAME_QUICK_LOAD_CONFIRM_DESC="这会丢失当前未保存的数据。（可在【设置】中禁用此确认）",n.WTCD_GAME_QUICK_LOAD_CONFIRM_CONFIRM="确认读取",n.WTCD_GAME_QUICK_LOAD_CONFIRM_CANCEL="取消",n.WTCD_GAME_NO_DESC="无描述文本",n.WTCD_ERROR_COMPILE_TITLE="WTCD 编译失败",n.WTCD_ERROR_COMPILE_DESC="该 WTCD 文档在编译时发生了错误。请检查是否有语法错误或是其他基本错误。",n.WTCD_ERROR_RUNTIME_TITLE="WTCD 运行时错误",n.WTCD_ERROR_RUNTIME_DESC="该 WTCD 文档在运行时发生了错误。请检查是否有逻辑错误。",n.WTCD_ERROR_INTERNAL_TITLE="WTCD 内部错误",n.WTCD_ERROR_INTERNAL_DESC="WTCD 解释器在解释执行该 WTCD 文档时崩溃了。请务必告诉琳你做了什么好让她来修。",n.WTCD_ERROR_MESSAGE="错误信息：",n.WTCD_ERROR_WTCD_STACK_TITLE="WTCD 调用栈",n.WTCD_ERROR_WTCD_STACK_DESC="WTCD 调用栈记录了在错误发生时 WTCD 的解释器状态。这可以帮助理解错误发生的上下文。",n.WTCD_ERROR_INTERNAL_STACK_TITLE="内部调用栈",n.WTCD_ERROR_INTERNAL_STACK_DESC="内部调用栈记录了出现该错误时编译器或是解释器的状态。请注意内部调用栈通常只在调试 WTCD 编译器或是解释器时有用。内部调用栈通常对调试 WTCD 文档没有作用。",n.MAKAI_ERROR_INTERNET="和 Makai 主机通讯时出现错误 OxO, 或许是你的网络环境出现了问题？",n.MAKAI_ERROR_SUBMIT_COMMENT_INVALID_TOKEN="Oops！评论失败啦，或许是你的令牌过期啦？",n.MAKAI_ERROR_DELETE_COMMENT_INVALID_TOKEN="Oops！删除失败啦，或许是你的令牌过期啦？",n.MAKAI_ERROR_EMPTY_TOKEN="嘿！请先把令牌输进来啦！",n.MAKAI_ERROR_INVALID_TOKEN="Oops！你的令牌并没有被 Makai 记录在案！",n.MAKAI_ERROR_INVALID_EMAIL="你输入的邮箱格式有问题啦！",n.MAKAI_ERROR_USER_EXIST="这个名字已经被使用过了！如果之前使用的人是你的话，把用过的令牌找来吧！",n.MAKAI_ERROR_UNKNOWN="Oops！发生了一些不该发生的问题！快去把友人♪B或者琳喊来！",n.MAKAI_INFO_SET_TOKKEN_SUCCESS="你的 Makai 令牌已经设置完毕啦！",n.MAKAI_INFO_CONFIRM_TOKEN="正在确认你的 Makai 令牌……",n.MAKAI_INFO_OBTAIN_TOKEN="正在获取 Makai 令牌……",n.MAKAI_GENERIC_AS="以 ",n.MAKAI_GENERIC_SUBMIT=" 的身份评论",n.MAKAI_GENERIC_SUBMITED_AT=" 的身份发表于 ",n.MAKAI_GENERIC_LAST_MODIFIED="（最后修改于 ",n.MAKAI_GENERIC_LAST_MODIFIED_SUFFIX=" ）",n.MAKAI_BUTTON_BLOCK="屏蔽此人",n.MAKAI_BUTTON_DELETE="删除评论",n.MAKAI_MODAL_TITLE_WARNING="警告！",n.MAKAI_MODAL_TITLE_INFO="提示",n.MAKAI_MODAL_TITLE_WAITING="请等一下",n.MAKAI_MODAL_TITLE_TOKEN="Makai 令牌",n.MAKAI_MODAL_TITLE_COMMENT="Makai - 添加评论",n.MAKAI_MODAL_OK="好的",n.MAKAI_MODAL_CONFIRM="是的",n.MAKAI_MODAL_CANCEL="算了",n.MAKAI_MODAL_SAVE="保存",n.MAKAI_MODAL_SUBMIT="发表",n.MAKAI_MODAL_CONTENT_COMMENT_HINT="想说些什么？直接写下来吧！",n.MAKAI_MODAL_CONTENT_NAME_INPUT_PREFIX="署名（必填）",n.MAKAI_MODAL_CONTENT_EMAIL_INPUT_PREFIX="邮箱（可选）：",n.MAKAI_MODAL_CONTENT_TOKEN_INPUT_PREFIX="令牌：",n.MAKAI_MODAL_CONTENT_DELETION_CONFIRMATION="你确定要删除这条评论吗？",n.MAKAI_MODAL_CONTENT_THIS_IS_YOUR_MAKAI_TOKEN="这是你的 Makai 令牌！",n.MAKAI_MODAL_CONTENT_MAKAI_TOKEN_IS_USED_TO_SUBMIT_COMMENTS="使用 Makai 令牌可以非常方便的在这里发表评论！",n.MAKAI_MODAL_CONTENT_YOU_WILL_GET_MAKAI_TOKEN_ONCE_YOU_SUBMIT_FIRST_COMMENT="当你发表第一个评论的时候，就会获得你的 Makai 令牌哟！",n.MAKAI_MODAL_CONTENT_DEVELOPMENT_HINT="WTCD 存档同步正在开发中！ —— 来自魔法☆少女的玩具 友人♪B"},{}],12:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.stylePreviewArticle="<h1>午饭</h1>\n<p><em>作者：友人♪B</em></p>\n<p>“午饭，午饭♪”</p>\n<p>阳伞下的琳，很是期待今天的午饭。</p>\n<p>或许是体质和别的血族不太一样，琳能够感知到食物的味道，似乎也保有着生物对食物的喜爱。</p>\n<p>虽然她并不能从这些食物中获取能量就是。</p>\n<p>学校食堂的夏季限定甜点今天也很是抢手，这点从队伍的长度就能看出来——队伍险些就要超出食堂的范围了。</p>\n<p>“你说我要有钱多好——”</p>\n<p>已经从隔壁窗口买下了普通，但是很便宜的营养餐的秋镜悬，看着队伍中兴致勃勃的琳。</p>\n<p>其实她并不是缺钱，大约是吝啬。</p>\n<p>这得怪她娘，穷养秋镜悬养习惯了，现在她光自己除灵退魔挣来的外快都够她奢侈上一把了，可却还保留着能不花钱绝对不花，必须花钱越少越好的吝啬习惯。</p>\n<p>少顷，琳已经带着她的甜品建筑——每块砖头都是一块蛋糕，堆成一个诡异的火柴盒——来到了桌前。</p>\n<p>“（吃不胖真好，有钱真好……”</p>\n<p>血族的听觉自然是捕捉到了秋镜悬的嘀咕，琳放下盘子，悄咪咪地将牙贴上了秋镜悬的脖颈。</p>\n<p>“嘻嘻♪”</p>\n<p>“呜——”</p>\n<p>盯——</p>\n<p>秋镜悬看了看盘中剩下的一块毛血旺，似是联系到了什么，将目光转向了琳的牙。</p>\n<p>正在享用蛋糕盛宴的琳以余光瞥见了她的视线，</p>\n<p>“盯着本小姐是要做什么呢？”</p>\n<p>“啊，没，没什么……”</p>\n<p>秋镜悬支支吾吾的说着，</p>\n<p>“就是好奇一个问题，血族为什么不吃毛血旺……”</p>\n<p>“噢☆毛血旺就是那个煮熟的血块是吧？太没有美感了这种血！而且吃了也没法儿恢复能量，简直就是血液的绝佳浪费☆！”</p>\n<p>琳发出了对这样美食的鄙视，不过这种鄙视大约只有血族和蚊子会出现吧……</p>\n<p>“血族需要摄入血，是因为血所具有的生命能量，如果煮熟了的话，超过九成的能量都被转化成其他的东西了，对我们来说实在是没什么用处，还白白浪费了作为原料的血，这种东西本小姐才不吃咧✘！饿死，死外边，从这边跳下去也不吃✘！”</p>\n<p>“欸，别这么说嘛，你能尝得到味道的吧，吃一块试试呗？”</p>\n<p>“真……真香♪”</p>\n<p>当晚，因为触发了真香定律而感到很火大的琳，把秋镜悬丢进了自己的高维空间里头放置了一晚上（高维时间三天）泄愤。</p>"},{}],13:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.thanks=[{name:"神楽坂 立音"},{name:"lgd_小翅膀"},{name:"青葉"},{name:"kn"},{name:"F74nk",link:"https://t.me/F74nk_K"},{name:"杨佳文"},{name:"不知名的N姓人士就好"},{name:"某不愿透露姓名的N性？"},{name:"神楽坂 萌绫"},{name:"Butby"},{name:"友人♪B"},{name:"NekoCaffeine"},{name:"RainSlide"},{name:"czp",link:"https://www.hiczp.com"},{name:"kookxiang"},{name:"櫻川 紗良"},{name:"Skimige"},{name:"TExL",link:"http://texas.penguin-logistics.cn"},{name:"路人乙"},{name:"pokemonchw",link:"https://github.com/pokemonchw"},{name:"帕蒂卡",link:"https://github.com/Patika-ailemait"},{name:"零件",link:"https://nekosc.com"},{name:"幻梦",link:"https://t.me/HuanmengQwQ"},{name:"acted咕咕喵",link:"https://acted.gitlab.io"},{name:"重水时雨",link:"https://t.me/boatmasteronD2O"},{name:"神楽坂 紫"},{name:"Runian Lee",link:"https://t.me/Runian"},{name:"琥珀"},{name:"为霜"},{name:"冰蓮音"},{name:"Testingdoll01"}].sort(()=>Math.random()-.5)},{}],14:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});class MakaiControl{static tokenToUsername(e){fetch(MakaiControl.url+"/username/"+e);return null}static validToken(e){return!(null==MakaiControl.tokenToUsername(e))}static saveToken(e){window.localStorage.setItem("token",e)}static saveUsername(e){window.localStorage.setItem("username",e)}static getToken(){return window.localStorage.getItem("token")}static getUsername(){return window.localStorage.getItem("username")}static hasToken(){return null!=window.localStorage.getItem("token")}}n.MakaiControl=MakaiControl,MakaiControl.url="https://c.makai.city"},{}],15:[function(e,t,n){"use strict";function solveQuad(e,t,n){const a=t**2-4*e*n;return(-t+function sign(e){return e>0?1:e<0?-1:0}(e)*a**.5)/(2*e)}Object.defineProperty(n,"__esModule",{value:!0});n.MonoDimensionTransitionControl=class MonoDimensionTransitionControl{constructor(e,t){this.lastValue=e,this.initialTime=0,this.reverseTime=0,this.reverseValue=0,this.reverseVelocity=0,this.lastStartingVelocity=0,this.finalTime=0,this.finalValue=0,this.acceleration=0,this.finalValue=e,this.acceleration=t/1e3/1e3}setTarget(e){this.lastValue=this.getValue();const t=e-this.lastValue;if(0===t)return;const n=Date.now(),a=this.getVelocity(n);let i=solveQuad(this.acceleration,2*a,.5*a**2/this.acceleration-t);(Number.isNaN(i)||i<0)&&(this.acceleration=-this.acceleration,i=solveQuad(this.acceleration,2*a,.5*a**2/this.acceleration-t));const s=this.acceleration;this.initialTime=n,this.reverseTime=this.initialTime+i,this.reverseValue=this.lastValue+.5*s*i**2+a*i,this.reverseVelocity=a+s*i,this.finalTime=this.reverseTime+i+a/s,this.lastStartingVelocity=a,this.finalValue=e}getVelocity(e=Date.now()){return e<this.reverseTime?this.lastStartingVelocity+(e-this.initialTime)*this.acceleration:e<this.finalTime?this.lastStartingVelocity+(2*this.reverseTime-this.initialTime-e)*this.acceleration:0}getValue(e=Date.now()){if(e<this.reverseTime){const t=e-this.initialTime;return this.lastValue+.5*this.acceleration*t**2+this.lastStartingVelocity*t}if(e<this.finalTime){const t=e-this.reverseTime;return this.reverseValue-.5*this.acceleration*t**2+this.reverseVelocity*t}return this.finalValue}isFinished(e=Date.now()){return e>=this.finalTime}}},{}],16:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../../wtcd/FeatureProvider"),i=e("../util/resolvePath"),s=e("../DebugLogger"),l=e("../data/AutoCache"),c=e("../util/loadGooleFonts"),u=new s.DebugLogger("WTCD Feature Provider"),d=new l.AutoCache(e=>new Promise((t,n)=>{const a=document.createElement("img");a.onload=()=>t(a),a.onerror=()=>n(new Error(`Failed to load ${e}.`)),a.src=e}),new s.DebugLogger("WTCD Image Cache")),p=new l.AutoCache(e=>{const t=e.indexOf(":");if(-1===t)return Promise.reject(new Error('Cannot find mode separator ":".'));const n=e.substr(0,t);return"googleFonts"!==n?Promise.reject(new Error(`Unknown mode: "${n}".`)):c.loadGoogleFonts(e.substr(t+1))},new s.DebugLogger("WTCD Font Cache"));class WTCDFeatureProvider extends a.FeatureProvider{constructor(e){super(),this.chapter=e}loadImage(e){if(!e.startsWith("./"))return Promise.reject(new Error("Path has to be relative and start "+`with "./". Received: "${e}"`));let t=i.resolvePath("chapters",this.chapter.htmlRelativePath,"..",e.substr(2));return null===t?Promise.reject(new Error(`Failed to resolve path: "${e}".`)):(t="/"+t,u.log("Resolved from:",e,"to:",t),d.get(t))}loadFont(e){return p.get(e)}}n.WTCDFeatureProvider=WTCDFeatureProvider},{"../../wtcd/FeatureProvider":58,"../DebugLogger":6,"../data/AutoCache":32,"../util/loadGooleFonts":52,"../util/resolvePath":54}],17:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../../wtcd/GameReader"),i=e("../constant/messages"),s=e("../data/settings"),l=e("../DebugLogger"),c=e("../hs"),u=e("../util/formatTime"),d=e("./createWTCDErrorMessageFromError"),p=e("./hintControl"),g=e("./modalControl"),f=e("../../wtcd/FeatureProvider"),m=new l.DebugLogger("WTCD Game Reader UI");n.WTCDGameReaderUI=class WTCDGameReaderUI{constructor(e,t,n,l=f.defaultFeatureProvider){this.content=e,this.mainBlock=null,this.started=!1,this.onClickRestart=()=>{const e=new g.Modal(c.h("div",[c.h("h1",i.WTCD_GAME_RESTART_TITLE),c.h("p",i.WTCD_GAME_RESTART_DESC),c.h("ul",[c.h("li",i.WTCD_GAME_RESTART_ALL_DESC),c.h("li",i.WTCD_GAME_RESTART_DECISION_ONLY_DESC)]),c.h(".button-container",[c.h("div",{onclick:()=>{this.reader.reset(!0),p.createHint(i.WTCD_GAME_RESTART_OK,1e3),e.close()}},i.WTCD_GAME_RESTART_ALL),c.h("div",{onclick:()=>{this.reader.reset(!1),p.createHint(i.WTCD_GAME_RESTART_OK,1e3),e.close()}},i.WTCD_GAME_RESTART_DECISION_ONLY),c.h("div",{onclick:()=>e.close()},i.WTCD_GAME_RESTART_CANCEL)])]));e.setDismissible(),e.open()},this.onClickSave=()=>{const e=new g.Modal(c.h("div",[c.h("h1",i.WTCD_GAME_SAVE_TITLE),c.h(".wtcd-save-button-list",this.reader.getSaves().map((t,n)=>0===n?null:null===t?c.h(".new",{onclick:()=>{this.reader.save(n),p.createHint(i.WTCD_GAME_SAVE_OK,1e3),e.close()}},i.WTCD_GAME_SAVE_NEW):c.h(".save",{onclick:()=>{g.confirm(i.WTCD_GAME_SAVE_OVERWRITE_TITLE,"",i.WTCD_GAME_SAVE_OVERWRITE_CONFIRM,i.WTCD_GAME_SAVE_OVERWRITE_CANCEL).then(t=>{t&&(this.reader.save(n),p.createHint(i.WTCD_GAME_SAVE_OK,1e3),e.close())})}},[c.h(".id",String(n)),c.h(".info",[c.h(".state-desc",""===t.desc?i.WTCD_GAME_NO_DESC:t.desc),c.h(".date",u.formatTimeSimple(t.date))])]))),c.h(".button-container",{style:{"margin-top":"1.2vh"}},[c.h("div",{onclick:()=>e.close()},i.WTCD_GAME_SAVE_CANCEL)])]));e.setDismissible(),e.open()},this.onClickLoad=()=>{const e=new g.Modal(c.h("div",[c.h("h1",i.WTCD_GAME_LOAD_TITLE),c.h(".wtcd-save-button-list",this.reader.getSaves().map((t,n)=>null===t?null:c.h(".save",{onclick:()=>{this.reader.load(n),p.createHint(i.WTCD_GAME_LOAD_OK,1e3),e.close()}},[0!==n?c.h(".id",String(n)):c.h(".small.id",i.WTCD_GAME_LOAD_QUICK),c.h(".info",[c.h(".state-desc",""===t.desc?i.WTCD_GAME_NO_DESC:t.desc),c.h(".date",u.formatTimeSimple(t.date))])]))),c.h(".button-container",{style:{"margin-top":"1.2vh"}},[c.h("div",{onclick:()=>e.close()},i.WTCD_GAME_LOAD_CANCEL)])]));e.setDismissible(),e.open()},this.onClickQuickSave=()=>{this.reader.save(0),p.createHint(i.WTCD_GAME_QUICK_SAVE_OK,1e3)},this.onClickQuickLoad=()=>{null!==this.reader.getSaves()[0]?s.wtcdGameQuickLoadConfirm.getValue()?g.confirm(i.WTCD_GAME_QUICK_LOAD_CONFIRM_TITLE,i.WTCD_GAME_QUICK_LOAD_CONFIRM_DESC,i.WTCD_GAME_QUICK_LOAD_CONFIRM_CONFIRM,i.WTCD_GAME_QUICK_LOAD_CONFIRM_CANCEL).then(e=>{e&&(this.reader.load(0),p.createHint(i.WTCD_GAME_QUICK_LOAD_OK,1e3))}):(this.reader.load(0),p.createHint(i.WTCD_GAME_QUICK_LOAD_OK,1e3)):p.createHint(i.WTCD_GAME_QUICK_LOAD_NOT_EXIST,3e3)},this.onOutput=e=>{null===this.mainBlock?(m.log("Initialize main block."),this.mainBlock=this.content.addBlock({initElement:e,slidable:!0})):(m.log("Updating main block."),this.content.scrollTo(this.controlsBlock.element.offsetTop),this.mainBlock.slideReplace(e))},this.onError=e=>{m.warn("Game reader reported error."),this.content.addBlock({initElement:d.createWTCDErrorMessageFromError(e)})},this.reader=new a.GameReader(t,n,this.onOutput,this.onError,l)}start(){if(this.started)throw new Error("Already started.");this.started=!0,this.controlsBlock=this.content.addBlock({initElement:c.h("div.wtcd-game-control",c.h(".button-container",[c.h("div",{onclick:this.onClickRestart},i.WTCD_GAME_RESTART),c.h("div",{onclick:this.onClickSave},i.WTCD_GAME_SAVE),c.h("div",{onclick:this.onClickLoad},i.WTCD_GAME_LOAD),c.h("div",{onclick:this.onClickQuickSave},i.WTCD_GAME_QUICK_SAVE),c.h("div",{onclick:this.onClickQuickLoad},i.WTCD_GAME_QUICK_LOAD)]))});const e=Date.now();this.reader.start(),m.log(`Game loaded in ${Date.now()-e}ms.`)}}},{"../../wtcd/FeatureProvider":58,"../../wtcd/GameReader":60,"../DebugLogger":6,"../constant/messages":11,"../data/settings":34,"../hs":36,"../util/formatTime":51,"./createWTCDErrorMessageFromError":23,"./hintControl":25,"./modalControl":28}],18:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../../wtcd/FlowReader"),i=e("../constant/loadingText"),s=e("../constant/messages"),l=e("../data/AutoCache"),c=e("../data/data"),u=e("../data/settings"),d=e("../data/state"),p=e("../DebugLogger"),g=e("../Event"),f=e("../hs"),m=e("../input/gestures"),v=e("../input/keyboard"),E=e("../util/DOM"),T=e("./commentsControl"),C=e("./contentControl"),y=e("./createWTCDErrorMessage"),b=e("./createWTCDErrorMessageFromError"),_=e("./history"),A=e("./layoutControl"),M=e("./modalControl"),w=e("./processElements"),L=e("./WTCDFeatureProvider"),I=e("./WTCDGameReaderUI"),S=new p.DebugLogger("Chapter Control");function closeChapter(){A.setLayout(A.Layout.OFF),d.state.currentChapter=null,d.state.chapterSelection=null,d.state.chapterTextNodes=null}n.loadChapterEvent=new g.Event,n.closeChapter=closeChapter;const select=([e,t,n,a])=>{if(null===d.state.chapterTextNodes)return;const i=d.state.chapterTextNodes[e],s=d.state.chapterTextNodes[n];if(void 0===i||void 0===s)return;document.getSelection().setBaseAndExtent(i,t,s,a);const l=i.parentElement;null!==l&&"function"==typeof l.scrollIntoView&&l.scrollIntoView()},canChapterShown=e=>(u.earlyAccess.getValue()||!e.isEarlyAccess)&&!e.hidden;function findNextChapter(e){const t=e.inFolderIndex,n=e.folder.chapters;for(let e=t+1;e<n.length;e++){const t=n[e];if(canChapterShown(t))return t}return null}function findPreviousChapter(e){const t=e.inFolderIndex,n=e.folder.chapters;for(let e=t-1;e>=0;e--){const t=n[e];if(canChapterShown(t))return t}return null}function loadPrevChapter(){const e=d.state.currentChapter;if(null===e)return;const t=findPreviousChapter(e);null!==t&&(loadChapter(t.htmlRelativePath,void 0,C.Side.LEFT),_.updateHistory(!0))}function loadNextChapter(){const e=d.state.currentChapter;if(null===e)return;const t=findNextChapter(e);null!==t&&(loadChapter(t.htmlRelativePath,void 0,C.Side.RIGHT),_.updateHistory(!0))}n.loadPrevChapter=loadPrevChapter,n.loadNextChapter=loadNextChapter;const D=new l.AutoCache(e=>{const t=`./chapters/${e}`;return S.log(`Loading chapter from ${t}.`),fetch(t).then(e=>e.text())},new p.DebugLogger("Chapters Cache"));function loadChapter(e,t,l=C.Side.LEFT){S.log("Load chapter",e,"with selection",t),n.loadChapterEvent.emit(e),window.localStorage.setItem("lastRead",e);const u=c.relativePathLookUpMap.get(e);d.state.currentChapter=u;const p=C.newContent(l);u.chapter.isEarlyAccess&&p.addBlock({initElement:f.h("div",[f.h("h1",s.EARLY_ACCESS_TITLE),f.h("p",s.EARLY_ACCESS_DESC)]),style:C.ContentBlockStyle.WARNING});const g=p.addBlock({initElement:f.h(".content")});A.setLayout(A.Layout.MAIN),g.element.innerText=i.loadingText,D.get(e).then(e=>{if(p.isDestroyed)return void S.log("Chapter loaded, but abandoned since the original content page is already destroyed.");S.log("Chapter loaded."),g.directRemove();const n=function insertContent(e,t,n){switch(n.type){case"Markdown":const i=e.addBlock();return i.element.innerHTML=t,w.processElements(i.element),i;case"WTCD":{const i=JSON.parse(t);if(!0===i.error){e.addBlock({initElement:y.createWTCDErrorMessage({errorType:O.COMPILE,message:i.message,internalStack:i.internalStack})});break}const s=new L.WTCDFeatureProvider(n);switch(n.preferredReader){case"flow":{const t=new a.FlowReader(n.htmlRelativePath,i.wtcdRoot,b.createWTCDErrorMessageFromError,w.processElements,s),l=e.addBlock().element;t.renderTo(l);break}case"game":new I.WTCDGameReaderUI(e,n.htmlRelativePath,i.wtcdRoot,s).start()}}}}(p,e,u.chapter)||p.addBlock();d.state.chapterTextNodes=E.getTextNodes(n.element),void 0!==t&&(null===E.id("warning")?select(t):E.id("warning").addEventListener("click",()=>{select(t)}));const i=findPreviousChapter(u),l=findNextChapter(u);n.element.appendChild(f.h("div.page-switcher",[null!==i?f.h("a.to-prev",{href:window.location.pathname+"#"+i.htmlRelativePath,onclick:e=>{e.preventDefault(),loadPrevChapter()}},s.PREVIOUS_CHAPTER):null,f.h("a.to-menu",{href:window.location.pathname,onclick:e=>{e.preventDefault(),closeChapter(),_.updateHistory(!0)}},s.GO_TO_MENU),null!==l?f.h("a.to-next",{href:window.location.pathname+"#"+l.htmlRelativePath,onclick:e=>{e.preventDefault(),loadNextChapter()}},s.NEXT_CHAPTER):null])),setTimeout(()=>{C.focus()},1),T.loadComments(p)}).catch(e=>{S.error("Failed to load chapter.",e),g.element.innerText=s.CHAPTER_FAILED})}var O;n.loadChapter=loadChapter,m.swipeEvent.on(e=>{u.gestureSwitchChapter.getValue()&&(e===m.SwipeDirection.TO_RIGHT?loadPrevChapter():e===m.SwipeDirection.TO_LEFT&&loadNextChapter())}),v.arrowKeyPressEvent.on(e=>{M.isAnyModalOpened()||(e===v.ArrowKey.LEFT?loadPrevChapter():e===v.ArrowKey.RIGHT&&loadNextChapter())}),v.escapeKeyPressEvent.on(()=>{M.isAnyModalOpened()||(closeChapter(),_.updateHistory(!0))}),function(e){e[e.COMPILE=0]="COMPILE",e[e.RUNTIME=1]="RUNTIME",e[e.INTERNAL=2]="INTERNAL"}(O=n.ErrorType||(n.ErrorType={}))},{"../../wtcd/FlowReader":59,"../DebugLogger":6,"../Event":7,"../constant/loadingText":9,"../constant/messages":11,"../data/AutoCache":32,"../data/data":33,"../data/settings":34,"../data/state":35,"../hs":36,"../input/gestures":38,"../input/keyboard":39,"../util/DOM":50,"./WTCDFeatureProvider":16,"./WTCDGameReaderUI":17,"./commentsControl":20,"./contentControl":21,"./createWTCDErrorMessage":22,"./createWTCDErrorMessageFromError":23,"./history":26,"./layoutControl":27,"./modalControl":28,"./processElements":29}],19:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../Event"),i=new Set(JSON.parse(window.localStorage.getItem("blockedUsers")||"[]"));function saveBlockedUsers(){window.localStorage.setItem("blockedUsers",JSON.stringify(Array.from(i))),n.blockedUserUpdateEvent.emit()}n.blockedUserUpdateEvent=new a.Event,n.blockUser=function blockUser(e){i.add(e),saveBlockedUsers()},n.unblockUser=function unblockUser(e){i.delete(e),saveBlockedUsers()},n.isUserBlocked=function isUserBlocked(e){return i.has(e)},n.getBlockedUsers=function getBlockedUsers(){return Array.from(i)}},{"../Event":7}],20:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constant/messages"),i=e("../data/AutoCache"),s=e("../data/settings"),l=e("../DebugLogger"),c=e("../hs"),u=e("../util/formatTime"),d=e("./commentBlockControl"),p=e("./contentControl"),g=e("./userControl"),f=e("../data/state"),m=e("./MakaiControl"),v=e("./modalControl"),E=new l.DebugLogger("Comments Control");function getApiUrl(){var e;return m.MakaiControl.url+"/comment/github/"+(null===(e=f.state.currentChapter)||void 0===e?void 0:e.chapter.htmlRelativePath.replace(/\//g,"."))+"/"}function loadComments(e){if(!1===s.useComments.getValue())return;const t=c.h("p",a.COMMENTS_LOADING),i=c.h(".comments",[c.h("h1",a.COMMENTS_SECTION),t]),l=e.addBlock({initElement:i});l.onEnteringView(()=>{const s=getApiUrl();n.commentsCache.get(s).then(n=>{e.isDestroyed?E.log("Comments loaded, but abandoned since the original content page is already destroyed."):(E.log("Comments loaded."),t.innerText=a.COMMENTS_LOADED,n.forEach(e=>{d.isUserBlocked(e.user.login)||i.appendChild(function createCommentElement(e,t,n,i,s,l,f,E,T){var C;const y=t===(null===(C=m.MakaiControl.getUsername())||void 0===C?void 0:C.toLowerCase())?c.h("a.block-user",{onclick:()=>{v.confirm(a.MAKAI_MODAL_TITLE_WARNING,a.MAKAI_MODAL_CONTENT_DELETION_CONFIRMATION,a.MAKAI_MODAL_CONFIRM,a.MAKAI_MODAL_CANCEL).then(e=>{if(e){const e=g.UserControl.showLoading(a.MAKAI_INFO_CONFIRM_TOKEN);fetch(m.MakaiControl.url+"/comment/"+f+"/"+m.MakaiControl.getToken(),{cache:"no-cache",credentials:"same-origin",headers:new Headers({"Content-Type":"application/json"}),method:"DELETE",mode:"cors",redirect:"follow",referrer:"no-referrer"}).then(e=>e.json()).then(t=>{e.close(),t.success?b.remove():g.UserControl.showMessage(a.MAKAI_ERROR_DELETE_COMMENT_INVALID_TOKEN)}).catch(t=>{e.close(),g.UserControl.showMessage(a.MAKAI_ERROR_INTERNET)})}})}},a.MAKAI_BUTTON_DELETE):null,b=c.h(".comment",[c.h("img.avatar",{src:e}),c.h("a.author",{target:"_blank",href:n,rel:"noopener noreferrer"},T),c.h(".time",a.MAKAI_GENERIC_AS+t+a.MAKAI_GENERIC_SUBMITED_AT+(i===s?u.formatTimeRelative(new Date(i)):`${u.formatTimeRelative(new Date(i))}`+a.MAKAI_GENERIC_LAST_MODIFIED+`${u.formatTimeRelative(new Date(s))}`+a.MAKAI_GENERIC_LAST_MODIFIED_SUFFIX)),null===y?c.h("a.block-user",{onclick:()=>{d.blockUser(t),E.directRemove(),loadComments(p.getCurrentContent())}},a.MAKAI_BUTTON_BLOCK):y,...l.split("\n\n").map(e=>c.h("p",e))]);return b}(e.user.avatar_url,e.user.login,e.user.html_url,e.created_at,e.updated_at,e.body,e.id,l,e.user.display))}),i.appendChild(c.h(".create-comment",{onclick:()=>{g.UserControl.showComment(l)}},a.COMMENTS_CREATE)))}).catch(()=>{t.innerText=a.COMMENTS_FAILED})})}n.getApiUrl=getApiUrl,n.commentsCache=new i.AutoCache(e=>(E.log(`Loading comments from ${e}.`),fetch(e).then(e=>e.json())),new l.DebugLogger("Comments Cache")),n.loadComments=loadComments},{"../DebugLogger":6,"../constant/messages":11,"../data/AutoCache":32,"../data/settings":34,"../data/state":35,"../hs":36,"../util/formatTime":51,"./MakaiControl":14,"./commentBlockControl":19,"./contentControl":21,"./modalControl":28,"./userControl":31}],21:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../data/settings"),i=e("../DebugLogger"),s=e("../hs"),l=e("../input/keyboard"),c=e("../util/DOM"),u=e("./layoutControl"),d=e("./MonoDimensionTransitionControl"),p=c.id("content-container"),g=new i.DebugLogger("Content Control");var f;function setSide(e,t){t===f.LEFT?(e.classList.add("left"),e.classList.remove("right")):(e.classList.add("right"),e.classList.remove("left"))}!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT"}(f=n.Side||(n.Side={}));let m=null;var v;n.getCurrentContent=function getCurrentContent(){return m},n.focus=function focus(){null!==m&&m.element.focus({preventScroll:!0})},n.newContent=function newContent(e){const t=new Content;if(u.getCurrentLayout()===u.Layout.OFF)null!==m&&m.destroy();else if(a.animation.getValue()){if(null!==m){setSide(m.element,function otherSide(e){return e===f.LEFT?f.RIGHT:f.LEFT}(e));const t=m;setTimeout(()=>{t.destroy()},2500)}setSide(t.element,e),t.element.offsetWidth,t.element.classList.remove("left","right")}else null!==m&&m.destroy();return m=t,t},function(e){e[e.REGULAR=0]="REGULAR",e[e.WARNING=1]="WARNING"}(v=n.ContentBlockStyle||(n.ContentBlockStyle={}));class Content{constructor(){this.isDestroyed=!1,this.blocks=[],this.scrollTransition=null,this.onKeyPress=e=>{e!==l.ArrowKey.UP&&e!==l.ArrowKey.DOWN||this.interruptScrolling()},this.interruptScrolling=()=>{null!==this.scrollTransition&&(this.scrollTransition=null,g.log("Transition interrupted."))},this.scrollAnimation=()=>{if(null===this.scrollTransition)return;const e=Date.now();this.element.scrollTop=this.scrollTransition.getValue(e),this.scrollTransition.isFinished(e)?(g.log("Transition finished."),this.scrollTransition=null):requestAnimationFrame(this.scrollAnimation)};const e=s.h("div.content",{tabIndex:-1});p.appendChild(e),this.element=e,window.addEventListener("wheel",this.interruptScrolling),l.arrowKeyPressEvent.on(this.onKeyPress)}addBlock(e={}){const t=new ContentBlock(this,e);return this.blocks.push(t),t}destroy(){this.isDestroyed=!0,this.element.remove(),window.removeEventListener("wheel",this.interruptScrolling),l.arrowKeyPressEvent.off(this.onKeyPress)}scrollTo(e){if(!a.animation.getValue()||u.getCurrentLayout()===u.Layout.OFF)return g.log(`Scroll to ${e}, no animation.`),void(this.element.scrollTop=e);null===this.scrollTransition?(g.log(`Scrolling to ${e}, new transition stared.`),this.scrollTransition=new d.MonoDimensionTransitionControl(this.element.scrollTop,2e4),this.scrollTransition.setTarget(e),requestAnimationFrame(this.scrollAnimation)):(g.log(`Scrolling to ${e}, existing transition updated.`),this.scrollTransition.setTarget(e))}}n.Content=Content;class ContentBlock{constructor(e,{initElement:t=s.h("div"),style:n=v.REGULAR,slidable:a=!1}){switch(this.slideContainer=null,this.heightHolder=null,this.sliding=0,this.element=t,t.classList.add("content-block"),n){case v.WARNING:t.classList.add("warning")}a?(this.slideContainer=s.h(".slide-container",t),e.element.appendChild(this.slideContainer)):e.element.appendChild(t)}onEnteringView(e){const t=new IntersectionObserver(n=>{n[0].isIntersecting&&(t.disconnect(),e())},{root:p,threshold:0});t.observe(this.element)}directRemove(){null!==this.slideContainer?this.slideContainer.remove():this.element.remove()}directReplace(e=s.h("div")){e.classList.add("content-block"),this.element.parentElement.replaceChild(e,this.element),this.element=e}slideReplace(e=s.h("div")){if(!a.animation.getValue())return void this.directReplace(e);const t=this.slideContainer;if(null===t)throw new Error("Content block is not slidable.");this.sliding++,t.classList.add("in-transition"),e.classList.add("content-block");const n=this.element;e.classList.add("right"),t.prepend(e);const i=e.offsetHeight;e.classList.remove("right"),null===this.heightHolder&&(this.heightHolder=s.h(".height-holder"),this.heightHolder.style.height=`${n.offsetHeight}px`,t.appendChild(this.heightHolder),this.heightHolder.offsetWidth),this.heightHolder.style.height=`${i}px`,n.classList.add("left"),this.element=e,setTimeout(()=>{n.remove(),this.sliding--,0===this.sliding&&(t.classList.remove("in-transition"),null!==this.heightHolder&&(this.heightHolder.remove(),this.heightHolder=null))},2500)}}n.ContentBlock=ContentBlock},{"../DebugLogger":6,"../data/settings":34,"../hs":36,"../input/keyboard":39,"../util/DOM":50,"./MonoDimensionTransitionControl":15,"./layoutControl":27}],22:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constant/messages"),i=e("./chapterControl");n.createWTCDErrorMessage=function createWTCDErrorMessage({errorType:e,message:t,internalStack:n,wtcdStack:s}){const l=document.createElement("div"),c=document.createElement("h1"),u=document.createElement("p");switch(e){case i.ErrorType.COMPILE:c.innerText=a.WTCD_ERROR_COMPILE_TITLE,u.innerText=a.WTCD_ERROR_COMPILE_TITLE;break;case i.ErrorType.RUNTIME:c.innerText=a.WTCD_ERROR_RUNTIME_TITLE,u.innerText=a.WTCD_ERROR_RUNTIME_DESC;break;case i.ErrorType.INTERNAL:c.innerText=a.WTCD_ERROR_INTERNAL_TITLE,u.innerText=a.WTCD_ERROR_INTERNAL_DESC}l.appendChild(c),l.appendChild(u);const d=document.createElement("p");if(d.innerText=a.WTCD_ERROR_MESSAGE+t,l.appendChild(d),void 0!==s){const e=document.createElement("h2");e.innerText=a.WTCD_ERROR_WTCD_STACK_TITLE,l.appendChild(e);const t=document.createElement("p");t.innerText=a.WTCD_ERROR_WTCD_STACK_DESC,l.appendChild(t);const n=document.createElement("pre"),i=document.createElement("code");i.innerText=s,n.appendChild(i),l.appendChild(n)}if(void 0!==n){const e=document.createElement("h2");e.innerText=a.WTCD_ERROR_INTERNAL_STACK_TITLE,l.appendChild(e);const t=document.createElement("p");t.innerText=a.WTCD_ERROR_INTERNAL_STACK_DESC,l.appendChild(t);const i=document.createElement("pre"),s=document.createElement("code");s.innerText=n,i.appendChild(s),l.appendChild(i)}return l}},{"../constant/messages":11,"./chapterControl":18}],23:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../../wtcd/WTCDError"),i=e("./chapterControl"),s=e("./createWTCDErrorMessage");n.createWTCDErrorMessageFromError=function createWTCDErrorMessageFromError(e){return s.createWTCDErrorMessage({errorType:e instanceof a.WTCDError?i.ErrorType.RUNTIME:i.ErrorType.INTERNAL,message:e.message,internalStack:e.stack,wtcdStack:e instanceof a.WTCDError?e.wtcdStack:void 0})}},{"../../wtcd/WTCDError":63,"./chapterControl":18,"./createWTCDErrorMessage":22}],24:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../data/data"),i=e("../data/state"),s=e("./chapterControl"),l=e("./contentControl"),c=e("./history");n.followQuery=function followQuery(){const e=decodeURIComponent(window.location.hash.substr(1)),t=a.relativePathLookUpMap.get(e);if(void 0===t)null!==i.state.currentChapter&&(s.closeChapter(),document.title=c.getTitle());else if(i.state.currentChapter!==t){const n=null!==i.state.currentChapter&&t.inFolderIndex>i.state.currentChapter.inFolderIndex?l.Side.RIGHT:l.Side.LEFT;if("function"!=typeof URLSearchParams)s.loadChapter(e,void 0,n);else{const t=new URLSearchParams(window.location.search).get("selection"),a=null!==t?t.split(",").map(e=>+e):[];4===a.length&&a.every(e=>e>=0&&e%1==0&&!Number.isNaN(e)&&Number.isFinite(e))?s.loadChapter(e,a,n):s.loadChapter(e,void 0,n),document.title=c.getTitle()}}c.updateHistory(!1)}},{"../data/data":33,"../data/state":35,"./chapterControl":18,"./contentControl":21,"./history":26}],25:[function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(i,s){function fulfilled(e){try{step(a.next(e))}catch(e){s(e)}}function rejected(e){try{step(a.throw(e))}catch(e){s(e)}}function step(e){e.done?i(e.value):function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}(e.value).then(fulfilled,rejected)}step((a=a.apply(e,t||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0});const i=e("../hs");let s=Promise.resolve();n.createHint=function createHint(e,t=2e3){s=s.then(()=>a(this,void 0,void 0,(function*(){const n=i.h(".hint",e);document.body.appendChild(n),n.style.opacity="0",n.offsetWidth,n.style.removeProperty("opacity"),yield new Promise(e=>setTimeout(e,t)),n.style.opacity="0",yield new Promise(e=>setTimeout(e,500)),n.remove()})))}},{"../hs":36}],26:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../data/state");function getTitle(){let e="可穿戴科技";return null!==a.state.currentChapter&&(e+=" - "+a.state.currentChapter.chapter.displayName),e}n.getTitle=getTitle,n.updateHistory=function updateHistory(e){const t=e?window.history.pushState:window.history.replaceState;let n=window.location.pathname;null!==a.state.currentChapter&&(null!==a.state.chapterSelection&&(n+=`?selection=${a.state.chapterSelection.join(",")}`),n+="#"+a.state.currentChapter.chapter.htmlRelativePath);const i=getTitle();document.title=i,t.call(window.history,null,i,n)}},{"../data/state":35}],27:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../DebugLogger"),i=e("../Event");var s;!function(e){e[e.SIDE=0]="SIDE",e[e.MAIN=1]="MAIN",e[e.OFF=2]="OFF"}(s=n.Layout||(n.Layout={}));const l=document.body,c=new a.DebugLogger("Layout");n.layoutChangeEvent=new i.Event,n.layoutChangeEvent.on(({newLayout:e})=>{switch(l.classList.remove("layout-side","layout-main","layout-off"),e){case s.SIDE:l.classList.add("layout-side");break;case s.MAIN:l.classList.add("layout-main");break;case s.OFF:l.classList.add("layout-off")}});let u=s.OFF;n.getCurrentLayout=function getCurrentLayout(){return u},n.setLayout=function setLayout(e){c.log(`${s[u]} -> ${s[e]}`),u!==e&&(n.layoutChangeEvent.emit({previousLayout:u,newLayout:e}),u=e)}},{"../DebugLogger":6,"../Event":7}],28:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../data/settings"),i=e("../hs"),s=e("../input/keyboard"),l=e("../util/DOM").id("modal-holder");class Modal{constructor(e=i.h("div")){this.dismissSet=!1,this.escKeyListener=null,e.classList.add("modal"),this.modal=e,this.modalContainer=i.h(".modal-container.closed",e),l.appendChild(this.modalContainer)}open(){this.modalContainer.offsetWidth,this.modalContainer.classList.remove("closed")}close(){a.animation.getValue()?(this.modalContainer.classList.add("closed"),setTimeout(()=>{this.modalContainer.remove()},400)):this.modalContainer.remove(),null!==this.escKeyListener&&s.escapeKeyPressEvent.off(this.escKeyListener)}setDismissible(e=(()=>{this.close()})){if(this.dismissSet)throw new Error("Dismissible already set.");this.dismissSet=!0,s.escapeKeyPressEvent.on(e),this.modalContainer.addEventListener("click",t=>{t.target===this.modalContainer&&e()})}}n.Modal=Modal,n.confirm=function confirm(e,t,n,a){let s=!1;return new Promise(l=>{const c=new Modal(i.h("div",[i.h("h1",e),""===t?null:i.h("p",t),i.h(".button-container",[i.h("div",{onclick:()=>{s||(s=!0,c.close(),l(!0))}},n),i.h("div",{onclick:()=>{s||(s=!0,c.close(),l(!1))}},a)])]));c.open()})},n.isAnyModalOpened=function isAnyModalOpened(){return l.childElementCount>0}},{"../data/settings":34,"../hs":36,"../input/keyboard":39,"../util/DOM":50}],29:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../util/DOM");n.processElements=function processElements(e){Array.from(e.getElementsByTagName("a")).forEach(e=>{e.target="_blank",e.rel="noopener noreferrer",e.className="regular"}),Array.from(e.getElementsByTagName("code")).forEach(e=>e.addEventListener("dblclick",()=>{e.parentNode instanceof HTMLPreElement||a.selectNode(e)})),Array.from(e.getElementsByTagName("img")).forEach(e=>{const t=e.src,n=t.lastIndexOf("."),a=t.substr(0,n);if(a.endsWith("_low")){const i=t.substr(n+1),s=a.substr(0,a.length-4);e.style.cursor="zoom-in",e.addEventListener("click",()=>window.open(s+"."+i))}})}},{"../util/DOM":50}],30:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../data/state"),i=e("./history");n.updateSelection=function updateSelection(){if(null===a.state.chapterTextNodes)return;const e=String(a.state.chapterSelection),t=document.getSelection();if(null===t)a.state.chapterSelection=null;else{const e=t.anchorNode instanceof HTMLElement?t.anchorNode.firstChild:t.anchorNode,n=a.state.chapterTextNodes.indexOf(e),i=t.focusNode instanceof HTMLElement?t.focusNode.firstChild:t.focusNode,s=a.state.chapterTextNodes.indexOf(i);-1===n||-1===s||n===s&&t.anchorOffset===t.focusOffset?a.state.chapterSelection=null:n<s||n===s&&t.anchorOffset<t.focusOffset?a.state.chapterSelection=[n,t.anchorOffset,s,t.focusOffset]:a.state.chapterSelection=[s,t.focusOffset,n,t.anchorOffset]}e!==String(a.state.chapterSelection)&&i.updateHistory(!1)}},{"../data/state":35,"./history":26}],31:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../hs"),i=e("./contentControl"),s=e("./modalControl"),l=e("./MakaiControl"),c=e("../data/state"),u=e("./commentsControl"),d=e("../constant/messages");class UserControl{static showMessage(e){const t=new s.Modal(a.h("div",[a.h("h1",d.MAKAI_MODAL_TITLE_INFO),a.h("p",e),a.h(".button-container",[a.h("div",{onclick:()=>{t.close()}},d.MAKAI_MODAL_OK)])]));t.setDismissible(),t.open()}static showLoading(e){const t=new s.Modal(a.h("div",[a.h("h1",d.MAKAI_MODAL_TITLE_WAITING),a.h("p",e)]));return t.open(),t}static showLogin(){let e;const t=new s.Modal(a.h("div",[a.h("h1",d.MAKAI_MODAL_TITLE_TOKEN),a.h("p",d.MAKAI_MODAL_CONTENT_THIS_IS_YOUR_MAKAI_TOKEN),a.h("p",d.MAKAI_MODAL_CONTENT_MAKAI_TOKEN_IS_USED_TO_SUBMIT_COMMENTS),a.h("p",d.MAKAI_MODAL_CONTENT_YOU_WILL_GET_MAKAI_TOKEN_ONCE_YOU_SUBMIT_FIRST_COMMENT),a.h("i",d.MAKAI_MODAL_CONTENT_DEVELOPMENT_HINT),a.h("ul",[d.MAKAI_MODAL_CONTENT_TOKEN_INPUT_PREFIX,e=a.h("input.makai-token",{value:void 0===l.MakaiControl.getToken()?"":l.MakaiControl.getToken()})]),a.h(".button-container",[a.h("div",{onclick:()=>{t.close()}},d.MAKAI_MODAL_CANCEL),a.h("div",{onclick:()=>{if(""===e.value)return void UserControl.showMessage(d.MAKAI_ERROR_EMPTY_TOKEN);const n=UserControl.showLoading(d.MAKAI_INFO_CONFIRM_TOKEN);fetch(l.MakaiControl.url+"/username/"+e.value).then(e=>e.json()).then(a=>{n.close(),null==a.username?UserControl.showMessage(d.MAKAI_ERROR_INVALID_TOKEN):(l.MakaiControl.saveToken(e.value),l.MakaiControl.saveUsername(a.username),t.close(),UserControl.showMessage(d.MAKAI_INFO_SET_TOKKEN_SUCCESS))}).catch(e=>{n.close(),UserControl.showMessage(d.MAKAI_ERROR_INTERNET)})}},d.MAKAI_MODAL_SAVE)])]));t.setDismissible(),t.open()}static sendComment(e,t,n){var a;if(!l.MakaiControl.hasToken())return void UserControl.showMessage(d.MAKAI_ERROR_INVALID_TOKEN);const s=UserControl.showLoading(d.MAKAI_INFO_CONFIRM_TOKEN);fetch(l.MakaiControl.url+"/comment/"+l.MakaiControl.getToken(),{body:JSON.stringify({pageName:null===(a=c.state.currentChapter)||void 0===a?void 0:a.chapter.htmlRelativePath.replace(/\//g,"."),content:e}),cache:"no-cache",credentials:"same-origin",headers:new Headers({"Content-Type":"application/json"}),method:"POST",mode:"cors",redirect:"follow",referrer:"no-referrer"}).then(e=>e.json()).then(e=>{s.close(),e.success?(t.directRemove(),u.commentsCache.delete(u.getApiUrl()),u.loadComments(i.getCurrentContent()),n.close()):UserControl.showMessage(d.MAKAI_ERROR_SUBMIT_COMMENT_INVALID_TOKEN)}).catch(e=>{s.close(),UserControl.showMessage(d.MAKAI_ERROR_INTERNET)})}static showComment(e){const t=a.h("input.makai-input"),n=a.h("input.makai-input"),i=l.MakaiControl.hasToken()?a.h("ul",[d.MAKAI_GENERIC_AS+l.MakaiControl.getUsername()+d.MAKAI_GENERIC_SUBMIT]):a.h("ul",[d.MAKAI_MODAL_CONTENT_NAME_INPUT_PREFIX,t,a.h("br"),d.MAKAI_MODAL_CONTENT_EMAIL_INPUT_PREFIX,n]),c=a.h("textarea.makai-comment"),u=new s.Modal(a.h("div",[a.h("h1",d.MAKAI_MODAL_TITLE_COMMENT),a.h("p",d.MAKAI_MODAL_CONTENT_COMMENT_HINT),c,i,a.h(".button-container",[a.h("div",{onclick:()=>{u.close()}},d.MAKAI_MODAL_CANCEL),a.h("div",{onclick:()=>{if(l.MakaiControl.hasToken())this.sendComment(c.value,e,u);else{const a=UserControl.showLoading(d.MAKAI_INFO_OBTAIN_TOKEN),i="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";fetch(l.MakaiControl.url+"/register/",{body:JSON.stringify({username:t.value,email:n.value,encodedPassword:new Array(20).fill(void 0).map(()=>i[Math.floor(Math.random()*i.length)]).join("")}),cache:"no-cache",headers:new Headers({"Content-Type":"application/json"}),credentials:"same-origin",method:"POST",mode:"cors",redirect:"follow",referrer:"no-referrer"}).then(e=>e.json()).then(n=>{if(a.close(),n.success)null==n.accessToken?UserControl.showMessage(d.MAKAI_ERROR_UNKNOWN):(l.MakaiControl.saveToken(n.accessToken),l.MakaiControl.saveUsername(t.value),UserControl.sendComment(c.value,e,u));else switch(n.errorMessage){case"Illegal email format.":UserControl.showMessage(d.MAKAI_ERROR_INVALID_EMAIL);break;case"User exist.":UserControl.showMessage(d.MAKAI_ERROR_USER_EXIST);break;default:UserControl.showMessage(d.MAKAI_ERROR_UNKNOWN)}}).catch(e=>{a.close(),UserControl.showMessage(d.MAKAI_ERROR_INTERNET)})}}},d.MAKAI_MODAL_SUBMIT)])]));u.setDismissible(),u.open()}}n.UserControl=UserControl},{"../constant/messages":11,"../data/state":35,"../hs":36,"./MakaiControl":14,"./commentsControl":20,"./contentControl":21,"./modalControl":28}],32:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.AutoCache=class AutoCache{constructor(e,t){this.loader=e,this.logger=t,this.map=new Map}delete(e){this.map.delete(e)}get(e){let t=this.map.get(e);return void 0===t?(this.logger.log(`Start loading for key=${e}.`),t=this.loader(e),this.map.set(e,t),t.catch(t=>{this.map.delete(e),this.logger.warn(`Loader failed for key=${e}. Cache removed.`,t)})):this.logger.log(`Cached value used for key=${e}.`),t}}},{}],33:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.data=window.DATA,n.relativePathLookUpMap=new Map,function iterateFolder(e){e.subFolders.forEach(e=>{iterateFolder(e)}),e.chapters.forEach((t,a)=>{n.relativePathLookUpMap.set(t.htmlRelativePath,{folder:e,chapter:t,inFolderIndex:a})})}(n.data.chapterTree)},{}],34:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const noop=()=>{};class BooleanSetting{constructor(e,t,n=noop){this.key=e,this.onUpdate=n,this.value=t?"false"!==window.localStorage.getItem(e):"true"===window.localStorage.getItem(e),this.updateLocalStorage(),this.onUpdate(this.value)}updateLocalStorage(){window.localStorage.setItem(this.key,String(this.value))}getValue(){return this.value}setValue(e){e!==this.value&&this.onUpdate(e),this.value=e,this.updateLocalStorage()}toggle(){this.setValue(!this.value)}}n.BooleanSetting=BooleanSetting;class EnumSetting{constructor(e,t,n,a=noop){if(this.key=e,this.options=t,this.defaultValue=n,this.onUpdate=a,!this.isCorrectValue(n))throw new Error(`Default value ${n} is not correct.`);this.value=+(window.localStorage.getItem(e)||n),this.correctValue(),this.onUpdate(this.value,this.options[this.value])}isCorrectValue(e){return!(Number.isNaN(e)||e%1!=0||e<0||e>=this.options.length)}correctValue(){this.isCorrectValue(this.value)||(this.value=this.defaultValue)}updateLocalStorage(){window.localStorage.setItem(this.key,String(this.value))}getValue(){return this.value}getValueName(){return this.options[this.value]}setValue(e){e!==this.value&&this.onUpdate(e,this.options[e]),this.value=e,this.updateLocalStorage()}}n.EnumSetting=EnumSetting,n.animation=new BooleanSetting("animation",!0,e=>{setTimeout(()=>{document.body.classList.toggle("animation-enabled",e)},1)}),n.warning=new BooleanSetting("warning",!1),n.earlyAccess=new BooleanSetting("earlyAccess",!1,e=>{document.body.classList.toggle("early-access-disabled",!e)}),n.useComments=new BooleanSetting("useComments",!0),n.gestureSwitchChapter=new BooleanSetting("gestureSwitchChapter",!0);const a=['-apple-system, "Noto Sans", "Helvetica Neue", Helvetica, "Nimbus Sans L", Arial, "Liberation Sans", "PingFang SC", "Hiragino Sans GB", "Noto Sans CJK SC", "Source Han Sans SC", "Source Han Sans CN", "Microsoft YaHei", "Wenquanyi Micro Hei", "WenQuanYi Zen Hei", "ST Heiti", SimHei, "WenQuanYi Zen Hei Sharp", sans-serif','Baskerville, Georgia, "Liberation Serif", "Kaiti SC", STKaiti, "AR PL UKai CN", "AR PL UKai HK", "AR PL UKai TW", "AR PL UKai TW MBE", "AR PL KaitiM GB", KaiTi, KaiTi_GB2312, DFKai-SB, "TW-Kai", serif','Georgia, "Nimbus Roman No9 L", "Songti SC", "Noto Serif CJK SC", "Source Han Serif SC", "Source Han Serif CN", STSong, "AR PL New Sung", "AR PL SungtiL GB", NSimSun, SimSun, "TW-Sung", "WenQuanYi Bitmap Song", "AR PL UMing CN", "AR PL UMing HK", "AR PL UMing TW", "AR PL UMing TW MBE", PMingLiU, MingLiU, serif','Baskerville, "Times New Roman", "Liberation Serif", STFangsong, FangSong, FangSong_GB2312, "CWTEX-F", serif'];n.fontFamily=new EnumSetting("fontFamily",["黑体","楷体","宋体","仿宋"],0,e=>{document.documentElement.style.setProperty("--font-family",a[e]),document.documentElement.style.setProperty("--font-family-mono",'"Fira Code", '+a[e])}),n.developerMode=new BooleanSetting("developerMode",!1),n.charCount=new BooleanSetting("charCount",!0,e=>{document.body.classList.toggle("char-count-disabled",!e)}),n.wtcdGameQuickLoadConfirm=new BooleanSetting("wtcdGameQuickLoadConfirm",!0)},{}],35:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.state={currentChapter:null,chapterSelection:null,chapterTextNodes:null}},{}],36:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("hyperscript");n.h=a},{hyperscript:4}],37:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./control/followQuery"),i=e("./control/updateSelection"),s=e("./data/data"),l=e("./data/settings"),c=e("./menu/MainMenu"),u=e("./util/DOM"),d=u.id("warning");null!==d&&d.addEventListener("click",()=>{d.style.opacity="0",l.animation.getValue()?d.addEventListener("transitionend",()=>{d.remove()}):d.remove()}),u.id("build-number").innerText=`Build ${s.data.buildNumber}`,(new c.MainMenu).setActive(!0),document.addEventListener("selectionchange",()=>{i.updateSelection()}),window.addEventListener("popstate",()=>{a.followQuery()}),a.followQuery()},{"./control/followQuery":24,"./control/updateSelection":30,"./data/data":33,"./data/settings":34,"./menu/MainMenu":43,"./util/DOM":50}],38:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../DebugLogger"),i=e("../Event"),s=e("../util/DOM");var l;!function(e){e[e.TO_TOP=0]="TO_TOP",e[e.TO_RIGHT=1]="TO_RIGHT",e[e.TO_BOTTOM=2]="TO_BOTTOM",e[e.TO_LEFT=3]="TO_LEFT"}(l=n.SwipeDirection||(n.SwipeDirection={}));n.swipeEvent=new i.Event;let c=0,u=0,d=0,p=null;window.addEventListener("touchstart",e=>{1===e.touches.length&&(p=e.target,c=e.touches[0].clientX,u=e.touches[0].clientY,d=Date.now())}),window.addEventListener("touchend",e=>{if(0!==e.touches.length)return;if(Date.now()-d>500)return;if(window.innerWidth>900)return;const t=e.changedTouches[0].clientX-c,a=e.changedTouches[0].clientY-u,i=Math.abs(t/window.innerWidth),g=Math.abs(a/window.innerHeight);if(i>.17&&g<.1){if(s.isAnyParent(p,e=>"hidden"!==window.getComputedStyle(e).getPropertyValue("overflow-x")&&e.scrollWidth>e.clientWidth))return;t>0?n.swipeEvent.emit(l.TO_RIGHT):n.swipeEvent.emit(l.TO_LEFT)}else if(g>.1&&i<.1){if(s.isAnyParent(p,e=>"hidden"!==window.getComputedStyle(e).getPropertyValue("overflow-y")&&e.scrollHeight>e.clientHeight))return;a>0?n.swipeEvent.emit(l.TO_BOTTOM):n.swipeEvent.emit(l.TO_TOP)}});const g=new a.DebugLogger("Swipe Event");n.swipeEvent.on(e=>{g.log(l[e])})},{"../DebugLogger":6,"../Event":7,"../util/DOM":50}],39:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../DebugLogger"),i=e("../Event");var s;!function(e){e[e.LEFT=0]="LEFT",e[e.UP=1]="UP",e[e.RIGHT=2]="RIGHT",e[e.DOWN=3]="DOWN"}(s=n.ArrowKey||(n.ArrowKey={})),n.arrowKeyPressEvent=new i.Event,n.escapeKeyPressEvent=new i.Event,document.addEventListener("keydown",e=>{if(!e.repeat)switch(e.keyCode){case 27:n.escapeKeyPressEvent.emit();break;case 37:n.arrowKeyPressEvent.emit(s.LEFT);break;case 38:n.arrowKeyPressEvent.emit(s.UP);break;case 39:n.arrowKeyPressEvent.emit(s.RIGHT);break;case 40:n.arrowKeyPressEvent.emit(s.DOWN)}});const l=new a.DebugLogger("Arrow Key Event");n.arrowKeyPressEvent.on(e=>{l.log(s[e])})},{"../DebugLogger":6,"../Event":7}],40:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constant/messages"),i=e("../control/commentBlockControl"),s=e("../Menu");class BlockMenu extends s.Menu{update(){this.clearItems();const e=i.getBlockedUsers();0===e.length?this.addItem(a.NO_BLOCKED_USERS,{small:!0}):this.addItem(a.CLICK_TO_UNBLOCK,{small:!0}),e.forEach(e=>{this.addItem(e,{small:!0,button:!0}).onClick(()=>{i.unblockUser(e)})})}constructor(e){super("屏蔽用户评论管理",e),this.update(),i.blockedUserUpdateEvent.on(this.update.bind(this))}}n.BlockMenu=BlockMenu},{"../Menu":8,"../constant/messages":11,"../control/commentBlockControl":19}],41:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../control/chapterControl"),i=e("../control/history"),s=e("../data/data"),l=e("../Menu"),c=e("../util/shortNumber"),u=new Map;let d=null;function attachLastReadLabelTo(e){void 0!==e&&(d=e.append("[上次阅读]"))}function getDecorationForChapterType(e){switch(e){case"Markdown":return l.ItemDecoration.ICON_FILE;case"WTCD":return l.ItemDecoration.ICON_GAME}}a.loadChapterEvent.on(e=>{null!==d&&d.remove(),attachLastReadLabelTo(u.get(e))});class ChaptersMenu extends l.Menu{constructor(e,t){void 0===t&&(t=s.data.chapterTree),super(t.isRoot?"章节选择":t.displayName,e);for(const e of t.subFolders){this.addLink(new ChaptersMenu(this,e),!0,l.ItemDecoration.ICON_FOLDER).append(`[${c.shortNumber(e.folderCharCount)}]`,"char-count")}for(const e of t.chapters){if(e.hidden)continue;const t=this.addItem(e.displayName,{small:!0,button:!0,decoration:getDecorationForChapterType(e.type)}).onClick(()=>{a.loadChapter(e.htmlRelativePath),i.updateHistory(!0)});e.isEarlyAccess&&(t.prepend("[编写中]"),t.addClass("early-access")),t.append(`[${c.shortNumber(e.chapterCharCount)}]`,"char-count"),window.localStorage.getItem("lastRead")===e.htmlRelativePath&&attachLastReadLabelTo(t),u.set(e.htmlRelativePath,t)}}}n.ChaptersMenu=ChaptersMenu},{"../Menu":8,"../control/chapterControl":18,"../control/history":26,"../data/data":33,"../util/shortNumber":55}],42:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../Menu");class ContactMenu extends a.Menu{constructor(e){super("订阅/讨论组",e),this.addItem("Telegram 更新推送频道",{small:!0,button:!0,link:"https://t.me/joinchat/AAAAAEpkRVwZ-3s5V3YHjA",decoration:a.ItemDecoration.ICON_LINK}),this.addItem("Telegram 讨论组",{small:!0,button:!0,link:"https://t.me/joinchat/Dt8_WlJnmEwYNbjzlnLyNA",decoration:a.ItemDecoration.ICON_LINK}),this.addItem("GitHub Repo",{small:!0,button:!0,link:"https://github.com/SCLeoX/Wearable-Technology",decoration:a.ItemDecoration.ICON_LINK}),this.addItem("原始 Google Docs",{small:!0,button:!0,link:"https://docs.google.com/document/d/1Pp5CtO8c77DnWGqbXg-3e7w9Q3t88P35FOl6iIJvMfo/edit?usp=sharing",decoration:a.ItemDecoration.ICON_LINK})}}n.ContactMenu=ContactMenu},{"../Menu":8}],43:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../Menu"),i=e("./ChaptersMenu"),s=e("./ContactMenu"),l=e("./SettingsMenu"),c=e("./StatsMenu"),u=e("./StyleMenu"),d=e("./ThanksMenu");class MainMenu extends a.Menu{constructor(){super("",null),this.addLink(new i.ChaptersMenu(this)),this.addLink(new d.ThanksMenu(this)),this.addLink(new u.StyleMenu(this)),this.addLink(new s.ContactMenu(this)),this.addItem("源代码",{button:!0,link:"https://github.com/SCLeoX/Wearable-Technology"}),this.addLink(new l.SettingsMenu(this)),this.addLink(new c.StatsMenu(this))}}n.MainMenu=MainMenu},{"../Menu":8,"./ChaptersMenu":41,"./ContactMenu":42,"./SettingsMenu":45,"./StatsMenu":47,"./StyleMenu":48,"./ThanksMenu":49}],44:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../Menu"),i=e("../control/userControl"),s=e("./SettingsMenu");class MakaiMenu extends a.Menu{constructor(e){super("Makai 评论系统管理",e),this.addItem("Makai 令牌",{small:!0,button:!0}).onClick(()=>{i.UserControl.showLogin()})}addBooleanSetting(e,t){const getText=()=>`${e}：${t.getValue()?"开":"关"}`,n=this.addItem(getText(),{small:!0,button:!0}).onClick(()=>{t.toggle(),n.setInnerText(getText())})}addEnumSetting(e,t,n){const getText=()=>`${e}：${t.getValueName()}`,a=this.addItem(getText(),{small:!0,button:!0}),i=new s.EnumSettingMenu(this,e,t,!0===n);a.linkTo(i).onClick(()=>{this.activateEvent.once(()=>{a.setInnerText(getText())})})}}n.MakaiMenu=MakaiMenu},{"../Menu":8,"../control/userControl":31,"./SettingsMenu":45}],45:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constant/stylePreviewArticle"),i=e("../control/contentControl"),s=e("../control/layoutControl"),l=e("../data/settings"),c=e("../Menu"),u=e("./BlockMenu"),d=e("./MakaiMenu");class EnumSettingMenu extends c.Menu{constructor(e,t,n,l){let u;super(`${t}设置`,e,l?s.Layout.SIDE:s.Layout.MAIN),l&&this.activateEvent.on(()=>{i.newContent(i.Side.RIGHT).addBlock().element.innerHTML=a.stylePreviewArticle}),n.options.forEach((e,t)=>{const a=this.addItem(e,{small:!0,button:!0,decoration:c.ItemDecoration.SELECTABLE}).onClick(()=>{u.setSelected(!1),a.setSelected(!0),n.setValue(t),u=a});t===n.getValue()&&(u=a,a.setSelected(!0))})}}n.EnumSettingMenu=EnumSettingMenu;class SettingsMenu extends c.Menu{constructor(e){super("设置",e),this.addLink(new d.MakaiMenu(this),!0),this.addBooleanSetting("NSFW 警告",l.warning),this.addBooleanSetting("使用动画",l.animation),this.addBooleanSetting("显示编写中章节",l.earlyAccess),this.addBooleanSetting("显示评论",l.useComments),this.addBooleanSetting("手势切换章节（仅限手机）",l.gestureSwitchChapter),this.addEnumSetting("字体",l.fontFamily,!0),this.addBooleanSetting("显示每个章节的字数",l.charCount),this.addBooleanSetting("WTCD 游戏快速读取前确认",l.wtcdGameQuickLoadConfirm),this.addBooleanSetting("开发人员模式",l.developerMode),this.addLink(new u.BlockMenu(this),!0)}addBooleanSetting(e,t){const getText=()=>`${e}：${t.getValue()?"开":"关"}`,n=this.addItem(getText(),{small:!0,button:!0}).onClick(()=>{t.toggle(),n.setInnerText(getText())})}addEnumSetting(e,t,n){const getText=()=>`${e}：${t.getValueName()}`,a=this.addItem(getText(),{small:!0,button:!0}),i=new EnumSettingMenu(this,e,t,!0===n);a.linkTo(i).onClick(()=>{this.activateEvent.once(()=>{a.setInnerText(getText())})})}}n.SettingsMenu=SettingsMenu},{"../Menu":8,"../constant/stylePreviewArticle":12,"../control/contentControl":21,"../control/layoutControl":27,"../data/settings":34,"./BlockMenu":40,"./MakaiMenu":44}],46:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../data/data"),i=e("../Menu");class StatsKeywordsCountMenu extends i.Menu{constructor(e){super("关键词统计",e),this.addItem("添加其他关键词",{small:!0,button:!0,link:"https://github.com/SCLeoX/Wearable-Technology/edit/master/src/builder/keywords.ts",decoration:i.ItemDecoration.ICON_LINK}),a.data.keywordsCount.forEach(([e,t])=>{this.addItem(`${e}：${t}`,{small:!0})})}}n.StatsKeywordsCountMenu=StatsKeywordsCountMenu},{"../Menu":8,"../data/data":33}],47:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../data/data"),i=e("../Menu"),s=e("./StatsKeywordsCountMenu");class StatsMenu extends i.Menu{constructor(e){super("统计",e),this.addItem("统计数据由构建脚本自动生成",{small:!0}),this.addLink(new s.StatsKeywordsCountMenu(this),!0,i.ItemDecoration.ICON_EQUALIZER),this.addItem(`总字数：${a.data.charsCount}`,{small:!0}),this.addItem(`总段落数：${a.data.paragraphsCount}`,{small:!0})}}n.StatsMenu=StatsMenu},{"../Menu":8,"../data/data":33,"./StatsKeywordsCountMenu":46}],48:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constant/stylePreviewArticle"),i=e("../control/contentControl"),s=e("../control/layoutControl"),l=e("../DebugLogger"),c=e("../hs"),u=e("../Menu");class Style{constructor(e,t){this.name=e,this.def=t,this.styleSheet=null,this.debugLogger=new l.DebugLogger(`Style (${e})`)}injectStyleSheet(){const e=document.createElement("style");document.head.appendChild(e);const t=e.sheet;t.disabled=!0;const attemptInsertRule=e=>{try{t.insertRule(e)}catch(t){this.debugLogger.error(`Failed to inject rule "${e}".`,t)}},n=`rgb(${this.def.keyColor.join(",")})`,keyAlpha=e=>`rgba(${this.def.keyColor.join(",")},${e})`;attemptInsertRule(`.container { color: ${n}; }`),attemptInsertRule(`.menu { color: ${n}; }`),attemptInsertRule(`.menu .button:active::after { background-color: ${n}; }`),attemptInsertRule(`.button::after { background-color: ${n}; }`),attemptInsertRule(`body { background-color: ${this.def.paperBgColor}; }`),attemptInsertRule(`:root { --comment-color:${this.def.commentColor}; }`),attemptInsertRule(`:root { --content-block-warning-color:${this.def.contentBlockWarningColor}; }`),attemptInsertRule(`:root { --rect-bg-color: ${this.def.rectBgColor}; }`),attemptInsertRule(`:root { --paper-bg-color: ${this.def.paperBgColor}; }`),attemptInsertRule(`:root { --link-color: ${this.def.linkColor}; }`),attemptInsertRule(`:root { --link-hover-color: ${this.def.linkHoverColor}; }`),attemptInsertRule(`:root { --link-active-color: ${this.def.linkActiveColor}; }`),attemptInsertRule(`:root { --key: ${n}; }`),attemptInsertRule(`:root { --key-opacity-01: ${keyAlpha(.1)}; }`),attemptInsertRule(`:root { --key-opacity-05: ${keyAlpha(.5)}; }`),attemptInsertRule(`:root { --key-opacity-007: ${keyAlpha(.07)}; }`),attemptInsertRule(`:root { --key-opacity-004: ${keyAlpha(.04)}; }`),attemptInsertRule(`:root { --button-color: ${this.def.commentColor}; }`),this.styleSheet=t}active(){if(null!==Style.currentlyEnabled){const e=Style.currentlyEnabled;null!==e.styleSheet&&(e.styleSheet.disabled=!0),e.itemHandle.setSelected(!1)}null===this.styleSheet&&this.injectStyleSheet(),this.styleSheet.disabled=!1,this.itemHandle.setSelected(!0),window.localStorage.setItem("style",this.name),null===Style.themeColorMetaTag?(Style.themeColorMetaTag=c.h("meta",{name:"theme-color",content:this.def.paperBgColor}),document.head.appendChild(Style.themeColorMetaTag)):Style.themeColorMetaTag.content=this.def.paperBgColor,Style.currentlyEnabled=this}}Style.currentlyEnabled=null,Style.themeColorMetaTag=null;const d={linkColor:"#00E",linkHoverColor:"#F00",linkActiveColor:"#00E"},p={linkColor:"#88F",linkHoverColor:"#F33",linkActiveColor:"#88F"},g=[new Style("可穿戴科技（默认）",Object.assign(Object.assign({rectBgColor:"#444",paperBgColor:"#333",keyColor:[221,221,221]},p),{contentBlockWarningColor:"#E65100",commentColor:"#444",keyIsDark:!1})),new Style("白纸",Object.assign(Object.assign({rectBgColor:"#EFEFED",paperBgColor:"#FFF",keyColor:[0,0,0]},d),{contentBlockWarningColor:"#FFE082",commentColor:"#F5F5F5",keyIsDark:!0})),new Style("夜间",Object.assign(Object.assign({rectBgColor:"#272B36",paperBgColor:"#38404D",keyColor:[221,221,221]},p),{contentBlockWarningColor:"#E65100",commentColor:"#272B36",keyIsDark:!1})),new Style("羊皮纸",Object.assign(Object.assign({rectBgColor:"#D8D4C9",paperBgColor:"#F8F4E9",keyColor:[85,40,48]},d),{contentBlockWarningColor:"#FFE082",commentColor:"#F9EFD7",keyIsDark:!0})),new Style("巧克力",Object.assign(Object.assign({rectBgColor:"#2E1C11",paperBgColor:"#3A2519",keyColor:[221,175,153]},p),{contentBlockWarningColor:"#E65100",commentColor:"#2C1C11",keyIsDark:!1}))];class StyleMenu extends u.Menu{constructor(e){super("阅读器样式",e,s.Layout.SIDE);for(const e of g)e.itemHandle=this.addItem(e.name,{small:!0,button:!0,decoration:u.ItemDecoration.SELECTABLE}).onClick(()=>{e.active()});const t=window.localStorage.getItem("style");let n=!1;for(const e of g)if(t===e.name){e.active(),n=!0;break}n||g[0].active(),this.activateEvent.on(()=>{i.newContent(i.Side.RIGHT).addBlock().element.innerHTML=a.stylePreviewArticle})}}n.StyleMenu=StyleMenu},{"../DebugLogger":6,"../Menu":8,"../constant/stylePreviewArticle":12,"../control/contentControl":21,"../control/layoutControl":27,"../hs":36}],49:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constant/thanks"),i=e("../Menu");class ThanksMenu extends i.Menu{constructor(e){super("鸣谢列表",e);for(const e of a.thanks)this.addItem(e.name,void 0===e.link?{small:!0}:{small:!0,button:!0,link:e.link,decoration:i.ItemDecoration.ICON_LINK})}}n.ThanksMenu=ThanksMenu},{"../Menu":8,"../constant/thanks":13}],50:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../DebugLogger");n.id=function id(e){return document.getElementById(e)},n.getTextNodes=function getTextNodes(e,t){const n=t||[];let a=e.firstChild;for(;null!==a;)a instanceof HTMLElement&&getTextNodes(a,n),a instanceof Text&&n.push(a),a=a.nextSibling;return n};const i=new a.DebugLogger("Select Node");n.selectNode=function selectNode(e){try{const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}catch(t){i.log("Failed to select node: ",e,"; Error: ",t)}},n.isAnyParent=function isAnyParent(e,t){for(;null!==e;){if(t(e))return!0;e=e.parentElement}return!1},n.insertAfter=function insertAfter(e,t){t.parentElement.insertBefore(e,t.nextSibling)}},{"../DebugLogger":6}],51:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=864e5;n.formatTimeRelative=function formatTimeRelative(e){const t=Date.now()-e.getTime();return t>6048e5?`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()}`:t>a?`${Math.floor(t/a)} 天前`:t>36e5?`${Math.floor(t/36e5)} 小时前`:t>6e4?`${Math.floor(t/6e4)} 分钟前`:`${Math.floor(t/1e3)} 秒前`},n.formatTimeSimple=function formatTimeSimple(e){return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} `+`${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`}},{}],52:[function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(i,s){function fulfilled(e){try{step(a.next(e))}catch(e){s(e)}}function rejected(e){try{step(a.throw(e))}catch(e){s(e)}}function step(e){e.done?i(e.value):function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}(e.value).then(fulfilled,rejected)}step((a=a.apply(e,t||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0});const i=e("../DebugLogger"),s=e("./matchAll"),l=new i.DebugLogger("Load Google Fonts"),c=/@font-face {[^}]*?font-family:\s*['"]?([^;'"]+?)['"]?;[^}]*?font-style:\s*([^;]+);[^}]*?font-weight:\s*([^;]+);[^}]*?src:\s*([^;]+);[^}]*?(?:unicode-range:\s*([^;]+))?;/g;n.loadGoogleFonts=function loadGoogleFonts(e){return a(this,void 0,void 0,(function*(){const t=`https://fonts.googleapis.com/css2?family=${e.replace(/ /g,"+")}`;l.log(`Loading font: "${e}" from "${t}".`);const n=yield fetch(t),a=yield n.text(),i=s.matchAll(a,c);return Promise.all(i.map(e=>new FontFace(e[1],e[4],{style:e[2],weight:e[3],unicodeRange:e[5]}).load())).then(e=>e.map(e=>document.fonts.add(e))).then(()=>e)}))}},{"../DebugLogger":6,"./matchAll":53}],53:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.matchAll=function matchAll(e,t){if(!0!==t.global)throw new Error("Global flag is required.");const n=[];let a;for(;null!==(a=t.exec(e));)n.push(a);return n}},{}],54:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.resolvePath=function resolvePath(...e){const t=[];for(const n of e){const e=n.split("/");for(const n of e)switch(n){case"":case".":return null;case"..":if(0===t.length)return null;t.pop();break;default:t.push(n)}}return t.join("/")}},{}],55:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.shortNumber=function shortNumber(e){return e<1e3?String(e):e<1e6?(e/1e3).toFixed(1)+"k":(e/1e6).toFixed(1)+"M"}},{}],56:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.stringHash=function stringHash(e){let t=0;if(0===e.length)return t;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}},{}],57:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.ChainedCanvas=class ChainedCanvas{constructor(e,t){this.promise=Promise.resolve(),this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.ctx=this.canvas.getContext("2d")}updatePromise(e){this.promise=this.promise.then(e)}onResolve(e){this.promise.then(e)}getWidth(){return this.canvas.width}getHeight(){return this.canvas.height}}},{}],58:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});class FeatureProvider{loadImage(e){return Promise.reject("Loading images is not allowed.")}loadFont(e){return Promise.reject("Loading fonts is not allowed.")}}n.FeatureProvider=FeatureProvider,n.defaultFeatureProvider=new FeatureProvider},{}],59:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./Interpreter"),i=e("./Random"),s=e("./FeatureProvider");n.FlowReader=class FlowReader{constructor(e,t,n,a,i=s.defaultFeatureProvider){this.wtcdRoot=t,this.errorMessageCreator=n,this.elementPreprocessor=a,this.featureProvider=i,this.currentDecisionIndex=0,this.buttons=[],this.contents=[],this.started=!1,this.storageKey=`wtcd.fr.${e}`,this.data=this.parseData(window.localStorage.getItem(this.storageKey))||{random:String(Math.random()),decisions:[]},this.resetInterpreter()}parseData(e){if("string"!=typeof e)return null;let t;try{t=JSON.parse(e)}catch(e){return null}return"string"!=typeof t.random?null:Array.isArray(t.decisions)?t.decisions.some(e=>"number"!=typeof e)?null:t:null}persist(){window.localStorage.setItem(this.storageKey,JSON.stringify(this.data))}next(e){try{return this.interpreterIterator.next(e)}catch(e){const t=this.errorMessageCreator(e);return this.target.appendChild(t),this.contents.push(t),{done:!0,value:{choices:[],content:[]}}}}resetInterpreter(){this.interpreter=new a.Interpreter(this.wtcdRoot,new i.Random(this.data.random),this.featureProvider),this.interpreterIterator=this.interpreter.start()}decide(e,t=!1){this.buttons[this.currentDecisionIndex].forEach((t,n)=>{t.classList.contains("disabled")||(t.classList.remove("candidate"),n===e?t.classList.add("selected"):t.classList.add("unselected"))}),t||this.data.decisions.push(e),this.currentDecisionIndex++;const n=this.next(e);return this.handleOutput(n.value),n.done}undecide(e){this.resetInterpreter(),this.data.decisions.splice(e),this.buttons.splice(e+1),this.contents.splice(e+1).forEach(e=>e.remove()),this.next();for(const e of this.data.decisions)this.next(e);this.buttons[e].forEach(e=>{e.classList.contains("disabled")||(e.classList.remove("selected","unselected"),e.classList.add("candidate"))}),this.currentDecisionIndex=e}handleOutput(e){const t=document.createElement("div");t.classList.add("wtcd-group-container"),e.content.forEach(e=>t.appendChild(e)),this.interpreter.getPinned().forEach(e=>t.appendChild(e));const n=this.currentDecisionIndex;this.buttons.push(e.choices.map((e,a)=>{const i=document.createElement("div");return i.classList.add("wtcd-button"),i.innerText=e.content,e.disabled?i.classList.add("disabled"):(i.classList.add("candidate"),i.addEventListener("click",()=>{this.data.decisions[n]===a?(this.undecide(n),this.persist()):this.currentDecisionIndex===n&&(this.decide(a),this.persist())})),t.appendChild(i),i})),this.contents.push(t),this.target.appendChild(t),this.elementPreprocessor(t)}renderTo(e){if(this.started)throw new Error("Flow reader already started.");this.started=!0,this.target=e;const t=this.next();let n=t.done;this.handleOutput(t.value);for(const e of this.data.decisions){if(n)return;n=this.decide(e,!0)}}}},{"./FeatureProvider":58,"./Interpreter":61,"./Random":62}],60:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./Interpreter"),i=e("./Random"),s=e("./FeatureProvider");function isGameData(e){return"object"==typeof e&&null!==e&&("string"==typeof e.random&&(!!Array.isArray(e.decisions)&&!e.decisions.some(e=>"number"!=typeof e)))}function isData(e){return"object"==typeof e&&null!==e&&(!!isGameData(e.current)&&(!!Array.isArray(e.saves)&&!!e.saves.every(e=>null===e||function isSaveData(e){return!!isGameData(e)&&("number"==typeof e.date&&"string"==typeof e.desc)}(e))))}n.GameReader=class GameReader{constructor(e,t,n,a,i=s.defaultFeatureProvider){this.wtcdRoot=t,this.onOutput=n,this.onError=a,this.featureProvider=i,this.started=!1,this.storageKey=`wtcd.gr.${e}`,this.data=this.parseData(window.localStorage.getItem(this.storageKey))||{saves:[null,null,null],current:{random:String(Math.random()),decisions:[]}}}parseData(e){if("string"!=typeof e)return null;let t;try{t=JSON.parse(e)}catch(e){return null}return isData(t)?t:null}persist(){window.localStorage.setItem(this.storageKey,JSON.stringify(this.data))}getSaves(){return this.data.saves.map(e=>null===e?null:{desc:e.desc,date:new Date(e.date)})}reset(e){this.data.current.decisions=[],e&&(this.data.current.random=String(Math.random())),this.restoreGameState(),this.persist()}save(e){if(void 0===this.data.saves[e])throw new Error(`Illegal save index: ${e}`);this.data.saves[e]={date:Date.now(),desc:this.interpreter.getStateDesc()||"",random:this.data.current.random,decisions:this.data.current.decisions.slice()},null!==this.data.saves[this.data.saves.length-1]&&this.data.saves.push(null),this.persist()}load(e){const t=this.data.saves[e];if(null==t)throw new Error(`Illegal save index: ${e}.`);this.data.current.random=t.random,this.data.current.decisions=t.decisions.slice(),this.restoreGameState(),this.persist()}next(e){try{return this.interpreterIterator.next(e)}catch(e){return this.onError(e),{done:!0,value:{choices:[],content:[]}}}}restoreGameState(){this.interpreter=new a.Interpreter(this.wtcdRoot,new i.Random(this.data.current.random),this.featureProvider),this.interpreterIterator=this.interpreter.start();let e=this.next();this.data.current.decisions.forEach(t=>e=this.next(t)),this.handleOutput(e.value)}handleOutput(e){const t=document.createElement("div");e.content.forEach(e=>t.appendChild(e)),this.interpreter.getPinned().forEach(e=>t.appendChild(e));const n=this.data.current.decisions.length,a=e.choices.map((e,i)=>{const s=document.createElement("div");return s.classList.add("wtcd-button"),s.innerText=e.content,e.disabled?s.classList.add("disabled"):(s.classList.add("candidate"),s.addEventListener("click",()=>{n===this.data.current.decisions.length&&(this.data.current.decisions.push(i),a.forEach(e=>{e===s?e.classList.add("selected"):e.classList.add("unselected")}),this.handleOutput(this.next(i).value),this.persist())})),t.appendChild(s),s});this.onOutput(t)}start(){if(this.started)throw new Error("Game reader already started.");this.started=!0,this.restoreGameState()}}},{"./FeatureProvider":58,"./Interpreter":61,"./Random":62}],61:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./constantsPool"),i=e("./invokeFunction"),s=e("./operators"),l=e("./std"),c=e("./utils"),u=e("./WTCDError");function isEqual(e,t){if(e.type!==t.type)return!1;switch(e.type){case"null":return!0;case"number":case"boolean":case"string":return e.value===t.value;case"action":if(e.value.action!==t.value.action)return!1;switch(e.value.action){case"exit":return!0;case"goto":return c.arrayEquals(e.value.target,t.value.target);case"selection":return e.value.choices.length===t.value.choices.length&&e.value.choices.every((e,n)=>isEqual(e,t.value.choices[n]))}throw new Error("Shouldn't fall through.");case"choice":return e.value.text===t.value.text&&isEqual(e.value.action,t.value.action);case"function":return e.value.fnType===t.value.fnType&&("native"===e.value.fnType?e.value.nativeFn===t.value.nativeFn:"wtcd"===e.value.fnType?e.value.expr===t.value.expr&&e.value.captured.every((e,n)=>{const a=t.value.captured[n];return e.name===a.name&&e.value===a.value}):e.value.isLeft===t.value.isLeft&&isEqual(e.value.targetFn,t.value.targetFn)&&c.arrayEquals(e.value.applied,t.value.applied,isEqual));case"list":return e.value.length===t.value.length&&e.value.every((e,n)=>isEqual(e,t.value[n]))}}var d;n.isEqual=isEqual,function(e){e[e.YIELD=0]="YIELD",e[e.RETURN=1]="RETURN",e[e.BREAK=2]="BREAK",e[e.CONTINUE=3]="CONTINUE"}(d=n.BubbleSignalType||(n.BubbleSignalType={}));class BubbleSignal extends Error{constructor(e){super("Uncaught Bubble Signal."),this.type=e,Object.setPrototypeOf(this,new.target.prototype)}}function describe(e){switch(e.type){case"number":case"boolean":return`${e.type} (value = ${e.value})`;case"string":return`string (value = "${e.value}")`;case"choice":return`choice (action = ${describe(e.value.action)}, label = `+`"${e.value.text}")`;case"action":switch(e.value.action){case"goto":return`action (type = goto, target = ${e.value.target})`;case"exit":return"action (type = exit)";case"selection":return`action (type = selection, choices = [${e.value.choices.map(describe).join(", ")}])`}case"null":return"null";case"list":return`list (elements = [${e.value.map(describe).join(", ")}])`;case"function":return"native"===e.value.fnType?`function (native ${e.value.nativeFn.name})`:"wtcd"===e.value.fnType?`function (arguments = [${e.value.expr.arguments.map(e=>e.name).join(", ")}])`:`function (partial ${e.value.isLeft?"left":"right"}, `+`applied = [${e.value.applied.map(describe).join(", ")}], `+`targetFn = ${describe(e.value.targetFn)})`}}function isTypeAssignableTo(e,t){return null===t||t.includes(e)}n.BubbleSignal=BubbleSignal,n.describe=describe,n.isTypeAssignableTo=isTypeAssignableTo,n.assignValueToVariable=function assignValueToVariable(e,t,n,a){if(!isTypeAssignableTo(t.type,e.types))throw u.WTCDError.atLocation(n,"Cannot assign value ("+`${describe(t)}) to variable "${a}". "${a}" `+`can only store these types: ${e.types.join(", ")}`);e.value=t};class RuntimeScope{constructor(){this.variables=new Map,this.registers=null}resolveVariableReference(e){return this.variables.get(e)||null}addVariable(e,t){this.variables.set(e,t)}addRegister(e){null===this.registers&&(this.registers=new Map),this.registers.set(e,a.getMaybePooled("null",null))}setRegisterIfExist(e,t){return null!==this.registers&&(!!this.registers.has(e)&&(this.registers.set(e,t),!0))}getRegister(e){return this.registers&&this.registers.get(e)||null}}class InvalidChoiceError extends Error{constructor(e){super(`Invalid choice ${e}.`),this.choiceId=e}}n.InvalidChoiceError=InvalidChoiceError;n.Interpreter=class Interpreter{constructor(e,t,n){this.wtcdRoot=e,this.random=t,this.featureProvider=n,this.timers=new Map,this.interpreterHandle={evaluator:this.evaluator.bind(this),pushScope:this.pushScope.bind(this),popScope:this.popScope.bind(this),resolveVariableReference:this.resolveVariableReference.bind(this),getRandom:()=>this.random,pushContent:this.pushContent.bind(this),timers:this.timers,setPinnedFunction:this.setPinnedFunction.bind(this),setStateDesc:this.setStateDesc.bind(this),featureProvider:this.featureProvider,canvases:new Map},this.pinnedFunction=null,this.pinned=[],this.stateDesc=null,this.scopes=[],this.sectionStack=[],this.started=!1,this.sectionEnterTimes=new Map,this.currentlyBuilding=[],this.sectionStack.push(this.wtcdRoot.sections[0])}setPinnedFunction(e){this.pinnedFunction=e}setStateDesc(e){this.stateDesc=e}resolveVariableReference(e){for(let t=this.scopes.length-1;t>=0;t--){const n=this.scopes[t].resolveVariableReference(e);if(null!==n)return n}throw u.WTCDError.atUnknown("Cannot resolve variable reference "+`"${e}". This is most likely caused by WTCD compiler's `+"error or the compiled output has been modified")}setRegister(e,t){for(let n=this.scopes.length-1;n>=0;n--)if(this.scopes[n].setRegisterIfExist(e,t))return;throw u.WTCDError.atUnknown(`Cannot resolve register reference "${e}". `+"This is mostly likely caused by WTCD compiler's error or the compiled output has been modified")}getCurrentScope(){return this.scopes[this.scopes.length-1]}pushScope(){const e=new RuntimeScope;return this.scopes.push(e),e}popScope(){return this.scopes.pop()}evaluateChoiceExpression(e){const t=this.evaluator(e.text);if("string"!==t.type)throw u.WTCDError.atLocation(e,"First argument of choice is expected to be a string, "+`received: ${describe(t)}`);let n=this.evaluator(e.action);if("action"!==n.type&&"function"!==n.type&&"null"!==n.type)throw u.WTCDError.atLocation(e,"Second argument of choice is expected to be an action, a function, "+`or null, received: ${describe(t)}`);return"function"===n.type&&(n={type:"action",value:{action:"function",fn:n,creator:e}}),{type:"choice",value:{text:t.value,action:n}}}evaluateConditionalExpression(e){const t=this.evaluator(e.condition);if("boolean"!==t.type)throw u.WTCDError.atLocation(e,"First argument of a conditional expression is expected to "+`be a boolean, received: ${describe(t)}`);return t.value?this.evaluator(e.then):this.evaluator(e.otherwise)}executeDeclarationStatement(e){for(const t of e.declarations){let n;if(null!==t.initialValue)n=this.evaluator(t.initialValue);else if(null===t.variableType)n=a.getMaybePooled("null",null);else if(1===t.variableType.length)switch(t.variableType[0]){case"boolean":n=a.getMaybePooled("boolean",!1);break;case"number":n=a.getMaybePooled("number",0);break;case"string":n=a.getMaybePooled("string","");break;case"list":n={type:"list",value:[]};break;default:throw u.WTCDError.atLocation(e,"Variable type "+`"${t.variableType[0]}" `+"does not have a default initial value")}else{if(!t.variableType.includes("null"))throw u.WTCDError.atLocation(e,"Variable type "+`"${t.variableType.join(" ")}" does not have a `+"default initial value");n=a.getMaybePooled("null",null)}if(!isTypeAssignableTo(n.type,t.variableType))throw u.WTCDError.atLocation(e,"The type of variable "+`${t.variableName} is `+`${t.variableType}, thus cannot hold `+`${describe(n)}`);this.getCurrentScope().addVariable(t.variableName,{types:t.variableType,value:n})}}evaluateBlockExpression(e){const t=this.pushScope();try{t.addRegister("yield");for(const t of e.statements)this.executeStatement(t);return t.getRegister("yield")}catch(e){if(e instanceof BubbleSignal&&e.type===d.YIELD)return t.getRegister("yield");throw e}finally{this.popScope()}}evaluateSelectionExpression(e){const t=this.evaluator(e.choices);if("list"!==t.type)throw u.WTCDError.atLocation(e,"Expression after selection is expected to be a list of choices, received: "+`${describe(t)}`);const n=t.value.filter(e=>"null"!==e.type);for(let t=0;t<n.length;t++)if("choice"!==n[t].type)throw u.WTCDError.atLocation(e,`Choice at index ${t} is expected `+`to be a choice, received: ${describe(n[t])}`);return{type:"action",value:{action:"selection",choices:n}}}evaluateListExpression(e){return{type:"list",value:c.flat(e.elements.map(e=>{if("spread"!==e.type)return this.evaluator(e);const t=this.evaluator(e.expression);if("list"!==t.type)throw u.WTCDError.atLocation(e,'Spread operator "..." can only '+`be used before a list, received: ${describe(t)}`);return t.value}))}}evaluateFunctionExpression(e){return{type:"function",value:{fnType:"wtcd",expr:e,captured:e.captures.map(e=>({name:e,value:this.resolveVariableReference(e)}))}}}evaluateSwitchExpression(e){const t=this.evaluator(e.expression);for(const n of e.cases){const e=this.evaluator(n.matches);if("list"!==e.type)throw u.WTCDError.atLocation(n.matches,"Value to match for each case is expected to be a list, received: "+`${describe(e)}`);if(e.value.some(e=>isEqual(e,t)))return this.evaluator(n.returns)}if(null===e.defaultCase)throw u.WTCDError.atLocation(e,"None of the cases matched and no default case is provided");return this.evaluator(e.defaultCase)}evaluateWhileExpression(e){const t=this.pushScope();t.addRegister("break");let n=!1;try{for(;;){if(!n&&null!==e.preExpr)try{this.evaluator(e.preExpr)}catch(e){if(!(e instanceof BubbleSignal&&e.type===d.CONTINUE))throw e}n=!1;const t=this.evaluator(e.condition);if("boolean"!==t.type)throw u.WTCDError.atLocation(e,"Condition expression of a while loop is expected to return a boolean. Received: "+`${describe(t)}`);if(!1===t.value)break;if(null!==e.postExpr)try{this.evaluator(e.postExpr)}catch(e){if(!(e instanceof BubbleSignal&&e.type===d.CONTINUE))throw e;n=!0}}}catch(e){if(e instanceof BubbleSignal&&e.type===d.BREAK)return t.getRegister("break");throw e}finally{this.popScope()}return t.getRegister("break")}evaluateIfExpression(e){const t=this.evaluator(e.condition);if("boolean"!==t.type)throw u.WTCDError.atLocation(e,"The condition of an if expression is "+`expected to be a boolean. Received: ${describe(t)}`);return t.value?this.evaluator(e.then):null!==e.otherwise?this.evaluator(e.otherwise):a.getMaybePooled("null",null)}evaluator(e){switch(e.type){case"unaryExpression":return s.unaryOperators.get(e.operator).fn(e,this.interpreterHandle);case"binaryExpression":return s.binaryOperators.get(e.operator).fn(e,this.interpreterHandle);case"booleanLiteral":return a.getMaybePooled("boolean",e.value);case"numberLiteral":return a.getMaybePooled("number",e.value);case"stringLiteral":return a.getMaybePooled("string",e.value);case"nullLiteral":return a.getMaybePooled("null",null);case"list":return this.evaluateListExpression(e);case"choiceExpression":return this.evaluateChoiceExpression(e);case"conditionalExpression":return this.evaluateConditionalExpression(e);case"block":return this.evaluateBlockExpression(e);case"gotoAction":return{type:"action",value:{action:"goto",target:e.sections}};case"exitAction":return{type:"action",value:{action:"exit"}};case"selection":return this.evaluateSelectionExpression(e);case"variableReference":return this.resolveVariableReference(e.variableName).value;case"function":return this.evaluateFunctionExpression(e);case"switch":return this.evaluateSwitchExpression(e);case"while":return this.evaluateWhileExpression(e);case"if":return this.evaluateIfExpression(e);case"tag":return{type:"list",value:[a.getMaybePooled("string",e.name)]}}}executeStatement(e){switch(e.type){case"declaration":return void this.executeDeclarationStatement(e);case"expression":return void this.evaluator(e.expression);case"yield":throw this.setRegister("yield",this.evaluator(e.value)),new BubbleSignal(d.YIELD);case"setYield":return void this.setRegister("yield",this.evaluator(e.value));case"return":throw this.setRegister("return",this.evaluator(e.value)),new BubbleSignal(d.RETURN);case"setReturn":return void this.setRegister("return",this.evaluator(e.value));case"break":throw this.setRegister("break",this.evaluator(e.value)),new BubbleSignal(d.BREAK);case"setBreak":return void this.setRegister("break",this.evaluator(e.value));case"continue":throw new BubbleSignal(d.CONTINUE)}}addToSectionStack(e){for(const t of this.wtcdRoot.sections)if(t.name===e)return void this.sectionStack.push(t);throw u.WTCDError.atUnknown(`Unknown section "${e}"`)}updatePinned(){if(null!==this.pinnedFunction){try{i.invokeFunctionRaw(this.pinnedFunction.value,[],this.interpreterHandle)}catch(e){if(e instanceof i.FunctionInvocationError)throw u.WTCDError.atUnknown("Failed to invoke the pinned "+`function (${describe(this.pinnedFunction)}): `+e.message);throw e instanceof u.WTCDError&&e.pushWTCDStack("Pinned function ("+`${describe(this.pinnedFunction)})`),e}this.pinned=this.currentlyBuilding,this.currentlyBuilding=[]}else 0!==this.pinned.length&&(this.pinned=[])}*executeAction(e){switch(e.value.action){case"goto":for(let t=e.value.target.length-1;t>=0;t--)this.addToSectionStack(e.value.target[t]);break;case"exit":this.sectionStack.length=0;break;case"selection":{const t=e.value.choices,n=t.map(e=>({content:e.value.text,disabled:"null"===e.value.action.type})),a={content:this.currentlyBuilding,choices:n};this.currentlyBuilding=[],this.updatePinned();const i=yield a,s=t[i];if(void 0===s||"null"===s.value.action.type)throw new InvalidChoiceError(i);yield*this.executeAction(s.value.action);break}case"function":{let t;try{t=i.invokeFunctionRaw(e.value.fn.value,[],this.interpreterHandle)}catch(t){if(t instanceof i.FunctionInvocationError)throw u.WTCDError.atLocation(e.value.creator,"Failed to evaluate the function action for this choice: "+`${t.message}`);throw t instanceof u.WTCDError&&t.pushWTCDStack("Function action",e.value.creator),t}if("action"===t.type)yield*this.executeAction(t);else if("null"!==t.type)throw u.WTCDError.atLocation(e.value.creator,"Value returned an function action is expected to be an action or null. "+`Received: ${describe(t)}`);break}}}pushContent(e){this.currentlyBuilding.push(e)}runSection(e){const t=document.createElement("div");null!==e.executes&&this.evaluator(e.executes);const n=this.sectionEnterTimes.has(e.name)?this.sectionEnterTimes.get(e.name)+1:1;this.sectionEnterTimes.set(e.name,n);const a=e.content.filter(e=>(void 0===e.lowerBound||e.lowerBound<=n)&&(void 0===e.upperBound||e.upperBound>=n));if(0!==a.length){const e=a[this.random.nextInt(0,a.length)];t.innerHTML=e.html;for(const n of e.variables)t.getElementsByClassName(n.elementClass)[0].innerText=String(this.resolveVariableReference(n.variableName).value.value);let n=t.firstChild;for(;null!==n;)n instanceof HTMLElement&&this.pushContent(n),n=n.nextSibling}return this.evaluator(e.then)}getPinned(){return this.pinned}getStateDesc(){return this.stateDesc}*start(){const e=this.pushScope();for(const t of l.stdFunctions)e.addVariable(t.name,{types:["function"],value:{type:"function",value:{fnType:"native",nativeFn:t}}});if(this.pushScope(),this.started)throw new Error("Interpretation has already started.");this.started=!0;let t=null;try{for(const e of this.wtcdRoot.initStatements)this.executeStatement(e);for(;0!==this.sectionStack.length;){const e=this.sectionStack.pop();t=e;const n=this.runSection(e);if("action"===n.type)yield*this.executeAction(n);else if("null"!==n.type)throw u.WTCDError.atLocation(e.then,"Expression after then is expected to return an action, or null, "+`received: ${describe(n)}`)}}catch(e){if(e instanceof BubbleSignal)throw u.WTCDError.atUnknown(`Uncaught BubbleSignal with type "${e.type}".`);throw e instanceof u.WTCDError&&(null===t?e.pushWTCDStack("initialization"):e.pushWTCDStack(`section "${t.name}"`,t)),e}const n={content:this.currentlyBuilding,choices:[]};return this.updatePinned(),n}}},{"./WTCDError":63,"./constantsPool":65,"./invokeFunction":66,"./operators":67,"./std":71,"./utils":78}],62:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.Random=class Random{constructor(e){const t=function xmur3(e){let t=1779033703^e.length;for(let n=0;n<e.length;n++)t=Math.imul(t^e.charCodeAt(n),3432918353),t=t<<13|t>>>19;return()=>(t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0)}(e);this.rng=function sfc32(e,t,n,a){return()=>{let i=(e>>>=0)+(t>>>=0)|0;return e=t^t>>>9,t=(n>>>=0)+(n<<3)|0,i=i+(a=(a>>>=0)+1|0)|0,n=(n=n<<21|n>>>11)+i|0,(i>>>0)/4294967296}}(t(),t(),t(),t())}next(e=0,t=1){return this.rng()*(t-e)+e}nextBool(){return this.rng()<.5}nextInt(e,t){return Math.floor(this.next(e,t))}}},{}],63:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a={};class WTCDError extends Error{constructor(e,t,n){super(e),this.line=t,this.column=n,this.wtcdStackArray=[],this.name="WTCDError"}get wtcdStack(){return this.message+"\n"+this.wtcdStackArray.join("\n")}pushWTCDStack(e,t=a){this.wtcdStackArray.push(`    at ${e}`+(t.line?":"+t.line+(t.column?":"+t.column:""):""))}static atUnknown(e){return new WTCDError(e+" at unknown location. (Location info is not available for this type of error)",null,null)}static atLineColumn(e,t,n){return new WTCDError(n+` at ${e}:${t}.`,e,t)}static atLocation(e,t){return null===e?WTCDError.atUnknown(t):void 0===e.line?new WTCDError(t+" at unknown location. (Try recompile in debug mode to enable source map)",null,null):WTCDError.atLineColumn(e.line,e.column,t)}}n.WTCDError=WTCDError},{}],64:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.autoEvaluated=function autoEvaluated(e){return(t,n)=>{const a=n.evaluator(t.arg0),i=n.evaluator(t.arg1);return e(a,i,t,n)}}},{}],65:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.nullValue={type:"null",value:null},n.trueValue={type:"boolean",value:!0},n.falseValue={type:"boolean",value:!1},n.smallIntegers=[];for(let e=0;e<=100;e++)n.smallIntegers.push({type:"number",value:e});function booleanValue(e){return e?n.trueValue:n.falseValue}n.booleanValue=booleanValue,n.getMaybePooled=function getMaybePooled(e,t){return"null"===e?n.nullValue:"boolean"===e?booleanValue(t):"number"===e&&t>=0&&t<=100&&t%1==0?n.smallIntegers[t]:{type:e,value:t}}},{}],66:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./autoEvaluated"),i=e("./constantsPool"),s=e("./Interpreter"),l=e("./std/utils"),c=e("./WTCDError");class FunctionInvocationError extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}}function invokeFunctionRaw(e,t,n){const{evaluator:a,pushScope:c,popScope:u}=n;if("native"===e.fnType)try{return e.nativeFn(t,n)}catch(t){throw t instanceof l.NativeFunctionError?new FunctionInvocationError("Failed to call native function "+`"${e.nativeFn.name}". Reason: ${t.message}`):t}else{if("wtcd"!==e.fnType){let a=e;const i=[],s=[];do{a.isLeft?i.unshift(...a.applied):s.push(...a.applied),a=a.targetFn.value}while("partial"===a.fnType);return invokeFunctionRaw(a,[...i,...t,...s],n)}{const n=c();try{n.addRegister("return"),e.expr.arguments.forEach((e,l)=>{let c=t[l];if(void 0===c||"null"===c.type)if(null!==e.defaultValue)c=a(e.defaultValue);else{if(!s.isTypeAssignableTo("null",e.type))throw new FunctionInvocationError("The argument with index = "+`${l} of invocation is omitted, but it does not have a `+"default value and it does not allow null values");c=i.getMaybePooled("null",null)}if(!s.isTypeAssignableTo(c.type,e.type))throw new FunctionInvocationError("The argument with index = "+`${l} of invocation has wrong type. Expected: `+`${e.type}, received: ${s.describe(c)}`);n.addVariable(e.name,{types:[c.type],value:c})}),null!==e.expr.restArgName&&n.addVariable(e.expr.restArgName,{types:["list"],value:{type:"list",value:t.slice(e.expr.arguments.length)}}),e.captured.forEach(e=>{n.addVariable(e.name,e.value)});const l=a(e.expr.expression),c=n.getRegister("return");return"null"===c.type?l:c}catch(e){if(e instanceof s.BubbleSignal&&e.type===s.BubbleSignalType.RETURN)return n.getRegister("return");throw e}finally{u()}}}}function handleError(e,t){if(t instanceof FunctionInvocationError)throw c.WTCDError.atLocation(e,t.message);throw t instanceof c.WTCDError&&t.pushWTCDStack(`"${e.operator}" invocation`,e),t}n.FunctionInvocationError=FunctionInvocationError,n.invokeFunctionRaw=invokeFunctionRaw,n.regularInvocationRaw=(e,t,n,a)=>{if("function"!==e.type)throw c.WTCDError.atLocation(n,"Left side of function invocation "+`"${n.operator}" is expected to be a function, received: `+`${s.describe(e)}`);if("list"!==t.type)throw c.WTCDError.atLocation(n,"Right side of function invocation "+`"${n.operator}" is expected to be a list, received: `+`${s.describe(t)}`);try{return invokeFunctionRaw(e.value,t.value,a)}catch(e){return handleError(n,e)}},n.regularInvocation=a.autoEvaluated(n.regularInvocationRaw),n.pipelineInvocation=a.autoEvaluated((e,t,n,a)=>{if("function"!==t.type)throw c.WTCDError.atLocation(n,'Right side of pipeline invocation "|>" '+`is expected to be a function, received: ${s.describe(t)}`);try{return invokeFunctionRaw(t.value,[e],a)}catch(e){return handleError(n,e)}}),n.reverseInvocation=a.autoEvaluated((e,t,n,a)=>{if("list"!==e.type)throw c.WTCDError.atLocation(n,'Left side of reverse invocation "|::" '+`is expected to be a list, received: ${s.describe(e)}`);if("function"!==t.type)throw c.WTCDError.atLocation(n,'Right side of reverse invocation "|::" '+`is expected to be a function, received: ${s.describe(t)}`);try{return invokeFunctionRaw(t.value,e.value,a)}catch(e){return handleError(n,e)}})},{"./Interpreter":61,"./WTCDError":63,"./autoEvaluated":64,"./constantsPool":65,"./std/utils":77}],67:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./autoEvaluated"),i=e("./constantsPool"),s=e("./Interpreter"),l=e("./invokeFunction"),c=e("./WTCDError");function autoEvaluatedSameTypeArg(e,t,n){return a.autoEvaluated((a,l,u,d)=>{if(a.type===e&&l.type===e)return i.getMaybePooled(t,n(a.value,l.value,u,d));throw c.WTCDError.atLocation(u,`Binary operator "${u.operator}" can only be `+`applied to two ${e}s, received: ${s.describe(a)} (left) and `+`${s.describe(l)} (right)`)})}function opAssignment(e,t,n){return(a,l)=>{if("variableReference"!==a.arg0.type)throw c.WTCDError.atLocation(a,`Left side of binary operator "${a.operator}" `+"has to be a variable reference");const u=l.resolveVariableReference(a.arg0.variableName);if(u.value.type!==e)throw c.WTCDError.atLocation(a,`Left side of binary operator "${a.operator}" has to be a `+`variable of type ${e}, actual type: ${u.value.type}`);const d=l.evaluator(a.arg1);if(d.type!==t)throw c.WTCDError.atLocation(a,`Right side of binary operator "${a.operator}" `+` has to be a ${t}, received: ${s.describe(d)}`);const p=i.getMaybePooled(e,n(u.value.value,d.value,a,l));return u.value=p,p}}n.unaryOperators=new Map([["-",{precedence:17,fn:(e,{evaluator:t})=>{const n=t(e.arg);if("number"!==n.type)throw c.WTCDError.atLocation(e,'Unary operator "-" can only be applied '+`to a number, received: ${s.describe(n)}`);return i.getMaybePooled("number",-n.value)}}],["!",{precedence:17,fn:(e,{evaluator:t})=>{const n=t(e.arg);if("boolean"!==n.type)throw c.WTCDError.atLocation(e,'Unary operator "!" can only be applied '+`to a boolean, received: ${s.describe(n)}`);return i.getMaybePooled("boolean",!n.value)}}]]),n.binaryOperators=new Map([["=",{precedence:3,fn:(e,{evaluator:t,resolveVariableReference:n})=>{if("variableReference"!==e.arg0.type)throw c.WTCDError.atLocation(e,'Left side of binary operator "=" has to be a variable reference');const a=n(e.arg0.variableName),i=t(e.arg1);return s.assignValueToVariable(a,i,e,e.arg0.variableName),i}}],["+=",{precedence:3,fn:(e,{evaluator:t,resolveVariableReference:n})=>{if("variableReference"!==e.arg0.type)throw c.WTCDError.atLocation(e,'Left side of binary operator "+=" has to be a variable reference');const a=n(e.arg0.variableName);if("string"!==a.value.type&&"number"!==a.value.type)throw c.WTCDError.atLocation(e,'Left side of binary operator "+=" has to be a '+`variable of type number or string, actual type: ${a.value.type}`);const l=t(e.arg1);if(l.type!==a.value.type)throw c.WTCDError.atLocation(e,'Right side of binary operator "+=" has to '+` be a ${a.value.type}, received: ${s.describe(l)}`);const u=i.getMaybePooled(a.value.type,a.value.value+l.value);return a.value=u,u}}],["-=",{precedence:3,fn:opAssignment("number","number",(e,t)=>e-t)}],["*=",{precedence:3,fn:opAssignment("number","number",(e,t)=>e*t)}],["/=",{precedence:3,fn:opAssignment("number","number",(e,t)=>e/t)}],["~/=",{precedence:3,fn:opAssignment("number","number",(e,t)=>Math.trunc(e/t))}],["%=",{precedence:3,fn:opAssignment("number","number",(e,t)=>e%t)}],["|>",{precedence:5,fn:l.pipelineInvocation}],["|::",{precedence:5,fn:l.reverseInvocation}],["||",{precedence:6,fn:(e,{evaluator:t})=>{const n=t(e.arg0);if("boolean"!==n.type)throw c.WTCDError.atLocation(e,'Left side of binary operator "||" has to be a boolean. '+`Received ${s.describe(n)}`);if(!0===n.value)return i.getMaybePooled("boolean",!0);const a=t(e.arg1);if("boolean"!==a.type)throw c.WTCDError.atLocation(e,'Right side of binary operator "||" has to be a boolean. '+`Received ${s.describe(a)}`);return i.getMaybePooled("boolean",a.value)}}],["?!",{precedence:6,fn:(e,{evaluator:t})=>{const n=t(e.arg0);if("null"!==n.type)return n;const a=t(e.arg1);if("null"===a.type)throw c.WTCDError.atLocation(e,'Right side of binary operator "??" cannot be null. If returning null is desired in this case, please use "???" instead');return a}}],["??",{precedence:6,fn:(e,{evaluator:t})=>{const n=t(e.arg0);return"null"!==n.type?n:t(e.arg1)}}],["&&",{precedence:7,fn:(e,{evaluator:t})=>{const n=t(e.arg0);if("boolean"!==n.type)throw c.WTCDError.atLocation(e,'Left side of binary operator "&&" has to be a boolean. '+`Received ${s.describe(n)}`);if(!1===n.value)return i.getMaybePooled("boolean",!1);const a=t(e.arg1);if("boolean"!==a.type)throw c.WTCDError.atLocation(e,'Right side of binary operator "&&" has to be a boolean. '+`Received ${s.describe(a)}`);return i.getMaybePooled("boolean",a.value)}}],["==",{precedence:11,fn:a.autoEvaluated((e,t)=>i.getMaybePooled("boolean",s.isEqual(e,t)))}],["!=",{precedence:11,fn:a.autoEvaluated((e,t)=>i.getMaybePooled("boolean",!s.isEqual(e,t)))}],["<",{precedence:12,fn:autoEvaluatedSameTypeArg("number","boolean",(e,t)=>e<t)}],["<=",{precedence:12,fn:autoEvaluatedSameTypeArg("number","boolean",(e,t)=>e<=t)}],[">",{precedence:12,fn:autoEvaluatedSameTypeArg("number","boolean",(e,t)=>e>t)}],[">=",{precedence:12,fn:autoEvaluatedSameTypeArg("number","boolean",(e,t)=>e>=t)}],["+",{precedence:14,fn:a.autoEvaluated((e,t,n)=>{if("number"===e.type&&"number"===t.type)return i.getMaybePooled("number",e.value+t.value);if("string"===e.type&&"string"===t.type)return i.getMaybePooled("string",e.value+t.value);throw c.WTCDError.atLocation(n,'Binary operator "+" can only be applied to two '+`strings or two numbers, received: ${s.describe(e)} (left) and `+`${s.describe(t)} (right)`)})}],["-",{precedence:14,fn:autoEvaluatedSameTypeArg("number","number",(e,t)=>e-t)}],["*",{precedence:15,fn:autoEvaluatedSameTypeArg("number","number",(e,t)=>e*t)}],["/",{precedence:15,fn:autoEvaluatedSameTypeArg("number","number",(e,t)=>e/t)}],["~/",{precedence:15,fn:autoEvaluatedSameTypeArg("number","number",(e,t)=>Math.trunc(e/t))}],["%",{precedence:15,fn:autoEvaluatedSameTypeArg("number","number",(e,t)=>e%t)}],["**",{precedence:16,fn:autoEvaluatedSameTypeArg("number","number",(e,t)=>e**t)}],[".",{precedence:19,fn:a.autoEvaluated((e,t,n)=>{if("list"!==e.type)throw c.WTCDError.atLocation(n,'Left side of binary operator "." '+`is expected to be a list. Received: ${s.describe(e)}`);if("number"!==t.type||t.value%1!=0)throw c.WTCDError.atLocation(n,'Right side of binary operator "." '+`is expected to be an integer. Received: ${s.describe(t)}`);const a=e.value[t.value];if(void 0===a)throw c.WTCDError.atLocation(n,"List does not have an element at "+`${t.value}. If return null is desired, use ".?" instead. List `+`contents: ${s.describe(e)}`);return a})}],[".?",{precedence:19,fn:a.autoEvaluated((e,t,n)=>{if("list"!==e.type)throw c.WTCDError.atLocation(n,'Left side of binary operator ".?" '+`is expected to be a list. Received: ${s.describe(e)}`);if("number"!==t.type||t.value%1!=0)throw c.WTCDError.atLocation(n,'Right side of binary operator ".?" '+`is expected to be an integer. Received: ${s.describe(t)}`);const a=e.value[t.value];return void 0===a?i.getMaybePooled("null",null):a})}],["?.",{precedence:19,fn:(e,{evaluator:t})=>{const n=t(e.arg0);if("null"===n.type)return n;if("list"!==n.type)throw c.WTCDError.atLocation(e,'Left side of binary operator "?." '+`is expected to be a list or null. Received: ${s.describe(n)}`);const a=t(e.arg1);if("number"!==a.type||a.value%1!=0)throw c.WTCDError.atLocation(e,'Right side of binary operator "?." '+`is expected to be an integer. Received: ${s.describe(a)}`);const i=n.value[a.value];if(void 0===i)throw c.WTCDError.atLocation(e,"List does not have an element at "+`${a.value}. If return null is desired, use "?.?" instead. `+`List contents: ${s.describe(n)}`);return i}}],["?.?",{precedence:19,fn:(e,{evaluator:t})=>{const n=t(e.arg0);if("null"===n.type)return n;if("list"!==n.type)throw c.WTCDError.atLocation(e,'Left side of binary operator "?.?" '+`is expected to be a list or null. Received: ${s.describe(n)}`);const a=t(e.arg1);if("number"!==a.type||a.value%1!=0)throw c.WTCDError.atLocation(e,"Right side of binary operator "+`"?.?" is expected to be an integer. Received: ${s.describe(a)}`);const l=n.value[a.value];return void 0===l?i.getMaybePooled("null",null):l}}],["::",{precedence:20,fn:l.regularInvocation}],["?::",{precedence:20,fn:(e,t)=>{const{evaluator:n}=t,a=n(e.arg0);return"null"===a.type?a:l.regularInvocationRaw(a,n(e.arg1),e,t)}}],[".:",{precedence:20,fn:a.autoEvaluated((e,t,n)=>{if("function"!==e.type)throw c.WTCDError.atLocation(n,'Left side of binary operator ".:" '+`is expected to be a function. Received: ${s.describe(e)}`);if("list"!==t.type)throw c.WTCDError.atLocation(n,'Right side of binary operator ".:" '+`is expected to be a list. Received: ${s.describe(t)}`);return 0===t.value.length?e:{type:"function",value:{fnType:"partial",isLeft:!1,applied:t.value,targetFn:e}}})}],[":.",{precedence:20,fn:a.autoEvaluated((e,t,n)=>{if("function"!==e.type)throw c.WTCDError.atLocation(n,'Left side of binary operator ":." '+`is expected to be a function. Received: ${s.describe(e)}`);if("list"!==t.type)throw c.WTCDError.atLocation(n,'Right side of binary operator ":." '+`is expected to be a list. Received: ${s.describe(t)}`);return 0===t.value.length?e:{type:"function",value:{fnType:"partial",isLeft:!0,applied:t.value,targetFn:e}}})}]]),n.conditionalOperatorPrecedence=4,n.operators=new Set([...n.unaryOperators.keys(),...n.binaryOperators.keys(),"?",":","..."])},{"./Interpreter":61,"./WTCDError":63,"./autoEvaluated":64,"./constantsPool":65,"./invokeFunction":66}],68:[function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(i,s){function fulfilled(e){try{step(a.next(e))}catch(e){s(e)}}function rejected(e){try{step(a.throw(e))}catch(e){s(e)}}function step(e){e.done?i(e.value):function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}(e.value).then(fulfilled,rejected)}step((a=a.apply(e,t||[])).next())}))};Object.defineProperty(n,"__esModule",{value:!0});const i=e("../constantsPool"),s=e("./utils"),l=e("../ChainedCanvas");function obtainCanvas(e,t){const n=e.canvases.get(t);if(void 0===n)throw new s.NativeFunctionError(`Canvas with id="${t}" does not exist.`);return n}n.canvasStdFunctions=[function canvasCreate(e,t){s.assertArgsLength(e,3);const n=s.assertArgType(e,0,"string"),a=s.assertArgType(e,1,"number"),c=s.assertArgType(e,2,"number");if(t.canvases.has(n))throw new s.NativeFunctionError(`Canvas with id="${n}" already exists`);if(a%1!=0)throw new s.NativeFunctionError(`Width (${a}) has to be an integer`);if(a<=0)throw new s.NativeFunctionError(`Width (${a}) must be positive`);if(c%1!=0)throw new s.NativeFunctionError(`Height (${c}) has to be an integer`);if(c<=0)throw new s.NativeFunctionError(`Height (${c}) must be positive`);return t.canvases.set(n,new l.ChainedCanvas(a,c)),i.getMaybePooled("null",null)},function canvasOutput(e,t){const n=obtainCanvas(t,s.assertArgType(e,0,"string")),a=document.createElement("canvas");return a.width=n.getWidth(),a.height=n.getHeight(),t.pushContent(a),n.onResolve(()=>{document.body.contains(a)&&a.getContext("2d").drawImage(n.canvas,0,0)}),i.getMaybePooled("null",null)},function canvasClear(e,t){const n=obtainCanvas(t,s.assertArgType(e,0,"string"));return n.updatePromise(()=>a(this,void 0,void 0,(function*(){n.ctx.clearRect(0,0,n.getWidth(),n.getHeight())}))),i.getMaybePooled("null",null)},function canvasPutImage(e,t){s.assertArgsLength(e,4);const n=s.assertArgType(e,0,"string"),l=s.assertArgType(e,1,"string"),c=s.assertArgType(e,2,"number"),u=s.assertArgType(e,3,"number"),d=obtainCanvas(t,n);return d.updatePromise(()=>a(this,void 0,void 0,(function*(){try{const e=yield t.featureProvider.loadImage(l);d.ctx.drawImage(e,c,u)}catch(e){console.error(`WTCD failed to load image with path="${l}".`,e)}}))),i.getMaybePooled("null",null)},function canvasSetFont(e,t){s.assertArgsLength(e,3);const n=s.assertArgType(e,0,"string"),l=s.assertArgType(e,1,"number"),c=s.assertArgType(e,2,"string"),u=obtainCanvas(t,n);return u.updatePromise(()=>a(this,void 0,void 0,(function*(){try{const e=yield t.featureProvider.loadFont(c);u.ctx.font=`${l}px ${e}`}catch(e){console.error("WTCD failed to load font with "+`identifier="${c}".`,e)}}))),i.getMaybePooled("null",null)},function canvasSetFillStyle(e,t){s.assertArgsLength(e,2);const n=s.assertArgType(e,0,"string"),l=s.assertArgType(e,1,"string"),c=obtainCanvas(t,n);return c.updatePromise(()=>a(this,void 0,void 0,(function*(){c.ctx.fillStyle=l}))),i.getMaybePooled("null",null)},function canvasFillText(e,t){s.assertArgsLength(e,4,6);const n=s.assertArgType(e,0,"string"),l=s.assertArgType(e,1,"string"),c=s.assertArgType(e,2,"number"),u=s.assertArgType(e,3,"number"),d=s.assertArgType(e,4,"string","start"),p=s.assertArgType(e,5,"string","alphabetic"),g=obtainCanvas(t,n);switch(d){case"left":case"center":case"right":case"start":case"end":break;default:throw new s.NativeFunctionError(`Unknown text hAlign: ${d}`)}switch(p){case"top":case"hanging":case"middle":case"alphabetic":case"ideographic":case"bottom":break;default:throw new s.NativeFunctionError(`Unknown text vAlign: ${p}`)}return g.updatePromise(()=>a(this,void 0,void 0,(function*(){const e=g.ctx;e.textAlign=d,e.textBaseline=p,e.fillText(l,c,u)}))),i.getMaybePooled("null",null)},function canvasFillRect(e,t){s.assertArgsLength(e,5);const n=s.assertArgType(e,0,"string"),l=s.assertArgType(e,1,"number"),c=s.assertArgType(e,2,"number"),u=s.assertArgType(e,3,"number"),d=s.assertArgType(e,4,"number"),p=obtainCanvas(t,n);return p.updatePromise(()=>a(this,void 0,void 0,(function*(){p.ctx.fillRect(l,c,u,d)}))),i.getMaybePooled("null",null)}]},{"../ChainedCanvas":57,"../constantsPool":65,"./utils":77}],69:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constantsPool"),i=e("../Interpreter"),s=e("./utils");n.contentStdFunctions=[function contentAddParagraph(e,t){s.assertArgsLength(e,1);const n=document.createElement("p");return n.innerText=s.assertArgType(e,0,"string"),t.pushContent(n),a.getMaybePooled("null",null)},function contentAddImage(e,t){s.assertArgsLength(e,1);const n=document.createElement("img");return n.src=s.assertArgType(e,0,"string"),t.pushContent(n),a.getMaybePooled("null",null)},function contentAddUnorderedList(e,t){const n=document.createElement("ul");for(let t=0;t<e.length;t++){const a=s.assertArgType(e,t,"string"),i=document.createElement("li");i.innerText=a,n.appendChild(i)}return t.pushContent(n),a.getMaybePooled("null",null)},function contentAddOrderedList(e,t){const n=document.createElement("ol");for(let t=0;t<e.length;t++){const a=s.assertArgType(e,t,"string"),i=document.createElement("li");i.innerText=a,n.appendChild(i)}return t.pushContent(n),a.getMaybePooled("null",null)},function contentAddHeader(e,t){s.assertArgsLength(e,1,2);const n=s.assertArgType(e,1,"number",1);if(![1,2,3,4,5,6].includes(n))throw new s.NativeFunctionError(`There is no header with level ${n}`);const i=document.createElement("h"+n);return i.innerText=s.assertArgType(e,0,"string"),t.pushContent(i),a.getMaybePooled("null",null)},function contentAddTable(e,t){s.assertArgsLength(e,1,1/0);const n=e.map((t,n)=>s.assertArgType(e,n,"list"));n.forEach((e,t)=>{if(e.length!==n[0].length)throw new s.NativeFunctionError(`Row with index = ${t} has `+`incorrect number of items. Expecting ${n[0].length}, received `+`${e.length}`);e.forEach((e,n)=>{if("string"!==e.type)throw new s.NativeFunctionError(`Item in row with index = ${t}`+`, and column with index = ${n} is expected to be a `+`string, received: ${i.describe(e)}`)})});const l=document.createElement("table"),c=document.createElement("thead"),u=document.createElement("tr");n.shift().forEach(e=>{const t=document.createElement("th");t.innerText=e.value,u.appendChild(t)}),c.appendChild(u),l.appendChild(c);const d=document.createElement("tbody");return n.forEach(e=>{const t=document.createElement("tr");e.forEach(e=>{const n=document.createElement("td");n.innerText=e.value,t.appendChild(n)}),d.appendChild(t)}),l.appendChild(d),t.pushContent(l),a.getMaybePooled("null",null)},function contentAddHorizontalRule(e,t){return s.assertArgsLength(e,0),t.pushContent(document.createElement("hr")),a.getMaybePooled("null",null)}]},{"../Interpreter":61,"../constantsPool":65,"./utils":77}],70:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constantsPool"),i=e("../Interpreter"),s=e("../invokeFunction"),l=e("../WTCDError"),c=e("./utils");n.debugStdFunctions=[function print(e){return console.group("WTCD print call"),e.forEach((e,t)=>console.info(`[${t}] ${i.describe(e)}`)),console.groupEnd(),a.getMaybePooled("null",null)},function assert(e){if(c.assertArgsLength(e,1),!c.assertArgType(e,0,"boolean"))throw new c.NativeFunctionError("Assertion failed");return a.getMaybePooled("null",null)},function assertError(e,t){c.assertArgsLength(e,1);const n=c.assertArgType(e,0,"function");try{s.invokeFunctionRaw(n,[],t)}catch(e){if(e instanceof l.WTCDError||e instanceof s.FunctionInvocationError)return a.getMaybePooled("null",null);throw e}throw new c.NativeFunctionError("Assertion failed, no error is thrown")},function timeStart(e,t){c.assertArgsLength(e,0,1);const n=c.assertArgType(e,0,"string","default");if(t.timers.has(n))throw new c.NativeFunctionError(`Timer "${n}" already existed.`);return t.timers.set(n,Date.now()),a.getMaybePooled("null",null)},function timeEnd(e,t){c.assertArgsLength(e,0,1);const n=c.assertArgType(e,0,"string","default");if(!t.timers.has(n))throw new c.NativeFunctionError(`Cannot find timer "${n}".`);const i=t.timers.get(n);t.timers.delete(n);const s=Date.now();return console.group("WTCD timeEnd call"),console.info(`Timer        : ${n}`),console.info(`Start time   : ${i}`),console.info(`End time     : ${s}`),console.info(`Time elapsed : ${s-i}ms`),console.groupEnd(),a.getMaybePooled("null",null)}]},{"../Interpreter":61,"../WTCDError":63,"../constantsPool":65,"../invokeFunction":66,"./utils":77}],71:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("./content"),i=e("./debug"),s=e("./list"),l=e("./math"),c=e("./random"),u=e("./reader"),d=e("./string"),p=e("./canvas");n.stdFunctions=[...a.contentStdFunctions,...i.debugStdFunctions,...s.listStdFunctions,...l.mathStdFunctions,...c.randomStdFunctions,...u.readerStdFunctions,...d.stringStdFunctions,...p.canvasStdFunctions]},{"./canvas":68,"./content":69,"./debug":70,"./list":72,"./math":73,"./random":74,"./reader":75,"./string":76}],72:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constantsPool"),i=e("../Interpreter"),s=e("../invokeFunction"),l=e("../WTCDError"),c=e("./utils");n.listStdFunctions=[function listSet(e){c.assertArgsLength(e,3);const t=c.assertArgType(e,0,"list"),n=c.assertArgType(e,1,"number"),a=e[2];if(n%1!=0)throw new c.NativeFunctionError(`Index (${n}) has to be an integer`);if(n<0)throw new c.NativeFunctionError(`Index (${n}) cannot be negative`);if(n>=t.length)throw new c.NativeFunctionError(`Index (${n}) out of bounds. List `+`length is ${t.length}`);const i=t.slice();return i[n]=a,{type:"list",value:i}},function listForEach(e,t){c.assertArgsLength(e,2);const n=c.assertArgType(e,0,"list"),i=c.assertArgType(e,1,"function");return n.forEach((e,n)=>{try{s.invokeFunctionRaw(i,[e,a.getMaybePooled("number",n)],t)}catch(e){if(e instanceof s.FunctionInvocationError)throw new c.NativeFunctionError("Failed to apply function to the "+`element with index = ${n} of list: ${e.message}`);throw e instanceof l.WTCDError&&e.pushWTCDStack(`listForEach (index = ${n})`),e}}),a.getMaybePooled("null",null)},function listMap(e,t){c.assertArgsLength(e,2);const n=c.assertArgType(e,0,"list"),i=c.assertArgType(e,1,"function");return{type:"list",value:n.map((e,n)=>{try{return s.invokeFunctionRaw(i,[e,a.getMaybePooled("number",n)],t)}catch(e){if(e instanceof s.FunctionInvocationError)throw new c.NativeFunctionError("Failed to apply function to the "+`element with index = ${n} of list: ${e.message}`);throw e instanceof l.WTCDError&&e.pushWTCDStack(`listForMap (index = ${n})`),e}})}},function listCreateFilled(e){c.assertArgsLength(e,1,2);const t=c.assertArgType(e,0,"number"),n=1===e.length?a.getMaybePooled("null",null):e[1];if(t%1!=0)throw new c.NativeFunctionError(`Length (${t}) has to be an integer.`);if(t<0)throw new c.NativeFunctionError(`Length (${t}) cannot be negative.`);return{type:"list",value:new Array(t).fill(n)}},function listChunk(e){c.assertArgsLength(e,2);const t=c.assertArgType(e,0,"list"),n=c.assertArgType(e,1,"number");if(n%1!=0||n<1)throw new c.NativeFunctionError(`Chunk size (${n} has to be a `+"positive integer.");const a=[];for(let e=0;e<t.length;e+=n)a.push({type:"list",value:t.slice(e,e+n)});return{type:"list",value:a}},function listFilter(e,t){c.assertArgsLength(e,2);const n=c.assertArgType(e,0,"list"),u=c.assertArgType(e,1,"function");return{type:"list",value:n.filter((e,n)=>{try{const l=s.invokeFunctionRaw(u,[e,a.getMaybePooled("number",n)],t);if("boolean"!==l.type)throw new c.NativeFunctionError("Predicate is expected to return "+`booleans, but ${i.describe(l)} is returned for element `+`with index = ${n}`);return l.value}catch(e){if(e instanceof s.FunctionInvocationError)throw new c.NativeFunctionError("Failed to apply function to the "+`element with index = ${n} of list: ${e.message}`);throw e instanceof l.WTCDError&&e.pushWTCDStack(`listFilter (index = ${n})`),e}})}},function listSplice(e){c.assertArgsLength(e,3,4);const t=c.assertArgType(e,0,"list"),n=c.assertArgType(e,1,"number"),a=c.assertArgType(e,2,"number"),i=c.assertArgType(e,3,"list",[]);if(n%1!=0)throw new c.NativeFunctionError("Start index must be an integer, "+`provided: ${n}`);if(n<0||n>t.length)throw new c.NativeFunctionError("Start index must be in the bounds of "+`the list given (0 - ${t.length}), provided: ${n}`);if(a%1!=0)throw new c.NativeFunctionError("Start must be an integer.");if(a<0)throw new c.NativeFunctionError("Length must be nonnegative.");if(n+a>t.length)throw new c.NativeFunctionError("Length is too large and causes overflow.");const s=t.slice();return s.splice(n,a,...i),{type:"list",value:s}},function listSlice(e){c.assertArgsLength(e,2,3);const t=c.assertArgType(e,0,"list"),n=c.assertArgType(e,1,"number"),a=c.assertArgType(e,2,"number",t.length);if(n%1!=0)throw new c.NativeFunctionError("Start index must be an integer, "+`provided: ${n}`);if(n<0||n>t.length)throw new c.NativeFunctionError("Start index must be in the bounds of "+`the list given (0 - ${t.length}), provided: ${n}`);if(a%1!=0)throw new c.NativeFunctionError("End index must be an integer, "+`provided: ${a}`);if(a<0||a>t.length)throw new c.NativeFunctionError("End index must be in the bounds of "+`the list given (0 - ${t.length}), provided: ${a}`);if(a<n)throw new c.NativeFunctionError("End index must be larger or equal to "+`start index. Provided start = ${n}, end = ${a}`);return{type:"list",value:t.slice(n,a)}},function listLength(e){return c.assertArgsLength(e,1),a.getMaybePooled("number",c.assertArgType(e,0,"list").length)},function listIndexOf(e){c.assertArgsLength(e,2);const t=c.assertArgType(e,0,"list");for(let n=0;n<t.length;n++)if(i.isEqual(t[n],e[1]))return a.getMaybePooled("number",n);return a.getMaybePooled("number",-1)},function listIncludes(e){c.assertArgsLength(e,2);const t=c.assertArgType(e,0,"list");return a.getMaybePooled("boolean",t.some(t=>i.isEqual(t,e[1])))},function listFindIndex(e,t){c.assertArgsLength(e,2);const n=c.assertArgType(e,0,"list"),u=c.assertArgType(e,1,"function");for(let e=0;e<n.length;e++){const d=n[e];try{const n=s.invokeFunctionRaw(u,[d,a.getMaybePooled("number",e)],t);if("boolean"!==n.type)throw new c.NativeFunctionError("Predicate is expected to return "+`booleans, but ${i.describe(n)} is returned for element `+`with index = ${e}`);if(n.value)return a.getMaybePooled("number",e)}catch(t){if(t instanceof s.FunctionInvocationError)throw new c.NativeFunctionError("Failed to apply function to the "+`element with index = ${e} of list: ${t.message}`);throw t instanceof l.WTCDError&&t.pushWTCDStack(`listFindIndex (index = ${e})`),t}}return a.getMaybePooled("number",-1)}]},{"../Interpreter":61,"../WTCDError":63,"../constantsPool":65,"../invokeFunction":66,"./utils":77}],73:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constantsPool"),i=e("./utils");n.mathStdFunctions=[function mathMin(e){i.assertArgsLength(e,1,1/0);let t=1/0;for(let n=0;n<e.length;n++){const a=i.assertArgType(e,n,"number");a<t&&(t=a)}return a.getMaybePooled("number",t)},function mathMax(e){i.assertArgsLength(e,1,1/0);let t=-1/0;for(let n=0;n<e.length;n++){const a=i.assertArgType(e,n,"number");a>t&&(t=a)}return a.getMaybePooled("number",t)},function mathFloor(e){return i.assertArgsLength(e,1),a.getMaybePooled("number",Math.floor(i.assertArgType(e,0,"number")))},function mathCeil(e){return i.assertArgsLength(e,1),a.getMaybePooled("number",Math.ceil(i.assertArgType(e,0,"number")))}]},{"../constantsPool":65,"./utils":77}],74:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constantsPool"),i=e("./utils");n.randomStdFunctions=[function random(e,t){i.assertArgsLength(e,0,2);const n=i.assertArgType(e,0,"number",0),a=i.assertArgType(e,1,"number",1);return{type:"number",value:t.getRandom().next(n,a)}},function randomInt(e,t){i.assertArgsLength(e,2);const n=i.assertArgType(e,0,"number"),s=i.assertArgType(e,1,"number");return a.getMaybePooled("number",t.getRandom().nextInt(n,s))},function randomBoolean(e,t){i.assertArgsLength(e,0,1);const n=i.assertArgType(e,0,"number",.5);return a.getMaybePooled("boolean",t.getRandom().next()<n)},function randomBiased(e,t){i.assertArgsLength(e,0,4);const n=i.assertArgType(e,0,"number",0),a=i.assertArgType(e,1,"number",1),s=i.assertArgType(e,2,"number",(n+a)/2),l=i.assertArgType(e,3,"number",4);if(n>=a)throw new i.NativeFunctionError("Low cannot be larger than or equal to high.");if(s<n||s>a)throw new i.NativeFunctionError("Bias has to be between low and high.");let c;do{c=s+(a-n)/l*Math.sqrt(-2*Math.log(t.getRandom().next()))*Math.cos(2*Math.PI*t.getRandom().next())}while(c<n||c>=a);return{type:"number",value:c}}]},{"../constantsPool":65,"./utils":77}],75:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constantsPool"),i=e("./utils");n.readerStdFunctions=[function readerSetPinned(e,t){return i.assertArgsLength(e,1),i.assertArgType(e,0,"function"),t.setPinnedFunction(e[0]),a.getMaybePooled("null",null)},function readerUnsetPinned(e,t){return i.assertArgsLength(e,0),t.setPinnedFunction(null),a.getMaybePooled("null",null)},function readerSetStateDesc(e,t){i.assertArgsLength(e,1);const n=i.assertArgType(e,0,"string");return t.setStateDesc(n),a.getMaybePooled("null",null)},function readerUnsetStateDesc(e,t){return i.assertArgsLength(e,0),t.setStateDesc(null),a.getMaybePooled("null",null)}]},{"../constantsPool":65,"./utils":77}],76:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constantsPool"),i=e("./utils");n.stringStdFunctions=[function stringLength(e){i.assertArgsLength(e,1);const t=i.assertArgType(e,0,"string");return a.getMaybePooled("number",t.length)},function stringFormatNumberFixed(e){i.assertArgsLength(e,1,2);const t=i.assertArgType(e,0,"number"),n=i.assertArgType(e,1,"number",0);if(n<0||n>100||n%1!=0)throw new i.NativeFunctionError("Digits must be an integer between 0 and "+`100, received: ${n}`);return a.getMaybePooled("string",t.toFixed(n))},function stringFormatNumberPrecision(e){i.assertArgsLength(e,2);const t=i.assertArgType(e,0,"number"),n=i.assertArgType(e,1,"number");if(n<1||n>100||n%1!=0)throw new i.NativeFunctionError("Digits must be an integer between 1 and "+`100, received: ${n}`);return a.getMaybePooled("string",t.toPrecision(n))},function stringSplit(e){i.assertArgsLength(e,2);const t=i.assertArgType(e,0,"string"),n=i.assertArgType(e,1,"string");return a.getMaybePooled("list",t.split(n).map(e=>a.getMaybePooled("string",e)))},function stringSubByLength(e){i.assertArgsLength(e,2,3);const t=i.assertArgType(e,0,"string"),n=i.assertArgType(e,1,"number"),s=i.assertArgType(e,2,"number",t.length-n);if(n<0||n%1!=0)throw new i.NativeFunctionError("Start index must be an nonnegative "+`integer, received: ${n}`);if(n>t.length)throw new i.NativeFunctionError("Start cannot be larger than str length. "+`startIndex=${n}, str length=${t.length}`);if(s<0||s%1!=0)throw new i.NativeFunctionError("Length must be an nonnegative integer "+`, received: ${s}`);if(n+s>t.length)throw new i.NativeFunctionError("Index out of bounds. "+`startIndex=${n}, length=${s}, `+`str length=${t.length}.`);return a.getMaybePooled("string",t.substr(n,s))},function stringSubByIndex(e){i.assertArgsLength(e,2,3);const t=i.assertArgType(e,0,"string"),n=i.assertArgType(e,1,"number"),s=i.assertArgType(e,2,"number",t.length);if(n<0||n%1!=0)throw new i.NativeFunctionError("Start index must be an nonnegative "+`integer, received: ${n}`);if(n>t.length)throw new i.NativeFunctionError("Start cannot be larger than str length. "+`startIndex=${n}, str length=${t.length}`);if(s<0||s%1!=0)throw new i.NativeFunctionError("End index must be an nonnegative "+`integer, received: ${s}`);if(s<n||s>t.length)throw new i.NativeFunctionError("End index cannot be smaller than start index nor larger than the length of str. "+`endIndex=${s}, startIndex=${n}, `+`str length=${t.length}`);return a.getMaybePooled("string",t.substring(n,s))}]},{"../constantsPool":65,"./utils":77}],77:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});const a=e("../constantsPool"),i=e("../Interpreter");class NativeFunctionError extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}}function nullify(e,t){const n=e[t];return void 0===n?a.getMaybePooled("null",null):n}n.NativeFunctionError=NativeFunctionError,n.assertArgsLength=function assertArgsLength(e,t,n=t){if(e.length<t)throw new NativeFunctionError("Too many arguments are provided. "+`Minimum number of arguments: ${t}, received: ${e.length}`);if(e.length>n)throw new NativeFunctionError("Too many arguments are provided. "+`Maximum number of arguments: ${n}, received: ${e.length}`)},n.nullify=nullify,n.assertArgType=function assertArgType(e,t,n,a){const s=nullify(e,t);if("null"===s.type&&void 0!==a)return a;if(s.type!==n)throw new NativeFunctionError(`The argument with index = ${t} of `+`invocation has wrong type. Expected: ${n}, received: `+`${i.describe(s)}`);return s.value}},{"../Interpreter":61,"../constantsPool":65}],78:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.flat=function flat(e){const t=[];for(const n of e)Array.isArray(n)?t.push(...n):t.push(n);return t},n.arrayEquals=function arrayEquals(e,t,n=((e,t)=>e===t)){return e.length===t.length&&e.every((e,a)=>n(e,t[a]))}},{}]},{},[37]);